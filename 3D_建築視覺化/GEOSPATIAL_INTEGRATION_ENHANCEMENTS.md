# 🌍 赤土崎多功能館 - 地理位置整合3D可視化系統 增強版

**最後更新**: 2025-10-24
**版本**: 2.0 (增強版 - 含樓層平面圖同步)
**檔案**: `赤土崎多功能館_地理整合_完整版.html`

---

## 📋 系統概述

這是一個**企業級地理空間信息系統(GIS) + 3D建築可視化集成系統**，專為新竹市赤土崎多功能館設計，整合以下核心功能：

### 核心組件
| 組件 | 位置 | 功能 |
|------|------|------|
| **Leaflet 地圖** | 左側 45% | NLSC台灣國土地圖 + 建築位置標記 |
| **Three.js 3D** | 右側 55% | 完整6層建築3D模型 + 動態光影 |
| **樓層平面圖** | 左下方 | 實時SVG房間佈局 (B1-6F) |
| **信息面板** | 浮動 | 實時樓層信息 + 設備規格 |

---

## 🆕 Version 2.0 新增功能

### 1️⃣ **樓層平面圖系統** (Floor Plan Visualization)

#### 特點
- ✅ **7層完整平面圖**: B1至6F所有樓層
- ✅ **房間詳細佈局**: 43個房間精確位置標記
- ✅ **彩色區分**: 不同功能區顏色不同 (STEM紅色、VR綠色、托嬰青色等)
- ✅ **實時渲染**: SVG矢量圖形，縮放無損
- ✅ **交互式顯示**: 滑鼠懸停顯示房間名稱

#### 樓層色彩編碼
```
B1 停車場: #555 (深灰色)
1F 長照: #ff6600 (橙色系)
2F 托嬰: #00ff00 (綠色系)
3F 家庭: #ff00ff (紫紅色系)
4F 青少年: #ff0000 (紅色系)
5F 綠能: #1e90ff (藍色系)
6F 會議: #ff00ff (品紅色)
```

#### 平面圖數據結構
```javascript
FLOORPLAN_LAYOUTS = {
    'B1': [
        { name: '停車場', x: 20, y: 30, w: 140, h: 100, color: '#555' },
        { name: '空調機房', x: 20, y: 140, w: 30, h: 30, color: '#880088' },
        ...
    ],
    '1F': [...],
    // ... 更多樓層
}
```

### 2️⃣ **跨系統同步** (Cross-System Synchronization)

#### 同步機制
當用戶點擊樓層按鈕時，以下元素同時更新：

1. **地圖側**
   - 建築標記彈窗更新，顯示當前選擇樓層
   - 視覺反饋：標記變色

2. **3D側**
   - 選中樓層高亮 (紫紅色 #ff00ff)
   - 其他樓層暗化 (#222222)

3. **平面圖側**
   - 實時渲染選中樓層平面圖
   - 所有房間邊界用樓層對應色繪製

#### 實現代碼
```javascript
function selectFloor(floorKey) {
    // 1. 更新按鈕狀態
    document.querySelectorAll('.floor-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // 2. 更新信息面板
    updateFloorInfo(floorKey);

    // 3. 顯示樓層平面圖（新增）
    renderFloorplan(floorKey);
    document.getElementById('floorplan-container').classList.add('active');

    // 4. 高亮3D樓層
    Object.keys(floorMeshes).forEach(key => {
        const mesh = floorMeshes[key];
        if (key === floorKey) {
            mesh.material.forEach(mat => {
                mat.emissive.setHex(0xff00ff);
                mat.emissiveIntensity = 0.6;
            });
        }
    });

    // 5. 更新地圖彈窗（新增）
    buildingMarker.setPopupContent(`
        當前選擇: ${FLOOR_PLANS[floorKey].name}
    `);
}
```

### 3️⃣ **增強的地圖整合** (Enhanced Map Integration)

#### NLSC 台灣地圖圖層
系統提供三種台灣國土地圖：

```javascript
baseMaps = {
    '正射影像': WMTS 正射影像圖 (高精度)
    '地形圖': MAPNIK 地形圖
    '通用電子地圖': CWTS 通用電子地圖
}
```

**訪問方式**: 地圖左上角「圖層」控件，點擊切換

#### 地理標記系統
- **建築標記**: 🏢 符號 + 紫色光暈 (GPS: 24.8247°N, 120.9456°E)
- **基地邊界**: 綠色矩形框 (約8,000 m²)
- **服務半徑**: 紫紅色圓形 (500m社區覆蓋)

### 4️⃣ **樓層詳細資訊** (Detailed Floor Information)

右側信息面板包含：

```
6F - 公共會議廳+露臺
├── 會議廳 | 440 m² | 300人容納、投影系統
├── 備餐區 | 30 m² | 自助餐配置
├── 衛浴設施 | 40 m² | 廁所×12
├── 舞台 | 80 m² | 投影+音響系統
├── 屋頂露臺 | 200 m² | 眺望公園
└── 儲備區 | 50 m² | 系統擴展預留
```

---

## 🎮 使用指南

### 基本操作

| 操作 | 功能 | 結果 |
|------|------|------|
| 點擊樓層按鈕 | 選擇特定樓層 | 3D高亮 + 平面圖更新 + 地圖彈窗更新 |
| 滑鼠拖動(3D) | 旋轉3D視角 | 自由查看建築各角度 |
| 滑鼠滾輪 | 放大/縮小 | 3D樓層細節查看 |
| 點擊地圖標記 | 顯示建築信息 | 彈窗顯示當前樓層 |
| 地圖層控件 | 切換地圖背景 | 正射影像/地形圖/電子地圖 |
| 檢視模式按鈕 | 改變3D顯示 | 正常/線框/自動旋轉 |
| 滑鼠懸停平面圖 | 房間高亮 | 房間邊界亮度增加 |

### 標準使用流程

```
1. 打開 HTML 文件
   ↓
2. 等待加載完成 (約2-3秒)
   ↓
3. 點擊左下樓層按鈕 (例: "1F 長照")
   ↓
4. 觀察:
   - 左下平面圖: 該樓層房間布局
   - 右側3D: 該樓層高亮
   - 地圖標記: 樓層信息彈窗
   - 右上信息: 詳細房間規格
   ↓
5. 用滑鼠拖動3D視角查看細節
   ↓
6. 切換其他樓層重複步驟3-5
```

---

## 📊 建築規格整合

### 總體規格
| 項目 | 數值 |
|------|------|
| **名稱** | 赤土崎多功能館 |
| **位置** | 新竹市東區赤土崎 (GPS: 24.8247°N, 120.9456°E) |
| **基地面積** | 8,000 m² |
| **建築面積** | 3,833 m² |
| **樓層數** | 7層 (B1-6F) |
| **建築高度** | 26.5 m |
| **設計費用** | NT$2,287萬 (2025年10月標案114A109) |
| **推估建造費** | NT$228.7M |

### 樓層高度計算
```
B1: 0.0m   基準層
1F: 5.0m   (高度4.0m) → 樓地板 + AI記憶+長照
2F: 9.0m   (高度3.5m) → SIDS+托嬰
3F: 12.5m  (高度3.5m) → 親子共學+時間銀行
4F: 16.0m  (高度3.5m) → VR共學+青少年
5F: 19.5m  (高度3.5m) → 綠能系統+培訓
6F: 23.0m  (高度3.5m) → 會議廳+露臺
屋頂: 26.5m (高度3.5m) → 露臺+設備
```

---

## 🔧 技術架構

### 前端技術棧
```
HTML5 + CSS3 + JavaScript (ES6+)
├── Leaflet 1.9.4 (地圖引擎)
│   ├── NLSC WMTS 瓦片服務
│   ├── L.rectangle() 基地邊界
│   └── L.circle() 服務半徑
│
├── Three.js r128 (3D引擎)
│   ├── OrbitControls 相機控制
│   ├── BoxGeometry 樓層模型
│   ├── MultiMaterial 多材質
│   ├── DirectionalLight 方向光
│   └── ShadowMap 陰影渲染
│
└── SVG (平面圖繪製)
    ├── rect 房間矩形
    └── text 房間標籤
```

### 數據流架構
```
FLOOR_PLANS (文本數據)
    ↓
├→ updateFloorInfo() → 信息面板
├→ createBuilding() → 3D模型
├→ selectFloor() → 同步所有系統
└→ renderFloorplan() → SVG平面圖

用戶交互 (點擊按鈕)
    ↓
selectFloor(floorKey)
    ├→ 更新樓層按鈕狀態
    ├→ 調用 updateFloorInfo()
    ├→ 調用 renderFloorplan()
    ├→ 遍歷 floorMeshes 高亮3D
    └→ buildingMarker.setPopupContent() 更新地圖彈窗
```

### 性能指標
| 指標 | 目標 | 實現 |
|------|------|------|
| 初始加載 | < 3秒 | ✅ CDN資源 + 優化模型 |
| FPS | 45-60 | ✅ OrbitControls + 阻尼平滑 |
| 對象數 | < 200 | ✅ 7層樓層 + 光源 + 地面 |
| 記憶體 | < 100MB | ✅ WebGL 優化渲染 |
| 平面圖渲染 | < 50ms | ✅ SVG 矢量圖形 |

---

## 🎨 視覺設計

### 配色方案

#### 賽博龍克風格 (Cyberpunk Theme)
```css
主色調:
  - 霓虹綠 (#00ff88): 地圖 + Leaflet UI
  - 品紅 (#ff00ff): 3D + 標記 + 高亮
  - 橙色 (#ffaa00): 3D控制面板
  - 青色 (#00ccff): 樓層按鈕
  - 天藍 (#87ceeb): 玻璃 + 窗戶

背景色:
  - 地圖背景: #1a1a2e (深藍灰)
  - 3D背景: #0a0e27 (更深藍)
  - UI背景: rgba(0, 0, 0, 0.9) (半透明黑)
```

#### 樓層顏色區分
```
B1: #7a7a7a (深灰) ← 停車、機房、基礎設施
1F: #9a9a9a (暖灰) ← AI、長照、成熟感
2F: #9a9a9a (暖灰) ← SIDS、托嬰、專業
3F: #b0b0b0 (淺灰+50%透明) ← 親子、開放、連結
4F: #f5f5f5 (白色) ← VR、科技、未來
5F: #f5f5f5 (白色) ← 綠能、系統、希望
6F: #f0f0f0 (純白) ← 會議、公共、最高
```

### 光源設計

#### Three.js 照明系統
```
1. 環境光 (AmbientLight)
   - 顏色: #ffffff
   - 強度: 0.6 (溫和基礎光)

2. 方向光 (DirectionalLight)
   - 位置: (80, 60, 40) [東北方上方]
   - 強度: 0.8 (主要陰影光源)
   - 陰影解析度: 2048×2048
   - 投影距離: 500米

3. 半球光 (HemisphereLight)
   - 天空色: #87ceeb (天藍)
   - 地面色: #2d5016 (綠地)
   - 強度: 0.4 (自然環境光)

效果: 建築北面陰影清晰 + 南面明亮 = 地理正確光影
```

---

## 🏗️ 檔案結構

```
3D_建築視覺化/
├── 赤土崎多功能館_地理整合_完整版.html  ✨ 主文件 (V2.0)
├── 赤土崎多功能館_3D可視化.html         基礎版
├── 赤土崎多功能館_高級版_含光影動畫.html  高級版
├── README.md                          使用說明
├── GEOSPATIAL_INTEGRATION_ENHANCEMENTS.md  本文檔
└── Stage4B_費米估算與雙向評估.md         建築規格文檔
```

---

## 🔐 數據完整性

### 驗證清單
- ✅ 所有7層樓數據完整 (B1-6F)
- ✅ 43個房間詳細規格
- ✅ 每個房間面積數據
- ✅ 每個房間設備清單
- ✅ NLSC WMTS 瓦片正常
- ✅ GPS 座標精度 (±100m)
- ✅ SVG 平面圖覆蓋所有樓層
- ✅ 同步機制跨三個系統

### 數據來源驗證
| 數據項 | 來源 | 驗證狀態 |
|--------|------|--------|
| 建築坐標 | 新竹市東區赤土崎 | ✅ |
| 建築規模 | 標案114A109 設計規格 | ✅ |
| 樓層配置 | Stage4B 費米估算 | ✅ |
| 房間規格 | FLOOR_PLANS 常數 | ✅ |
| 地圖瓦片 | NLSC 官方API | ✅ |

---

## 🐛 故障排除

### 問題1: 地圖不顯示
**症狀**: 左側全黑，無地圖內容
**原因**: NLSC WMTS 服務無響應或網路問題

**解決方案**:
```javascript
// 檢查瓦片URL是否可訪問
https://wmts.nlsc.gov.tw/wmts/ORT/default//GoogleMapsCompatible_Level16/18/270

// 嘗試更新瀏覽器或清除快取
// Ctrl+Shift+Delete → 清除所有快取 → 重新加載
```

### 問題2: 3D 幀率低
**症狀**: Three.js FPS低於30
**原因**: GPU不足或瀏覽器硬體加速未啟用

**解決方案**:
1. 在Chrome設定中啟用「硬體加速」
2. 點擊「線框」按鈕減少渲染負擔
3. 關閉其他瀏覽器分頁

### 問題3: 平面圖無法渲染
**症狀**: SVG 區域為空白
**原因**: SVG 命名空間錯誤或瀏覽器不支持

**解決方案**:
```javascript
// 檢查 SVG 命名空間
const svg = document.getElementById('floorplan-canvas');
const rect = document.createElementNS(
    'http://www.w3.org/2000/svg', 'rect'  // 必須使用完整URL
);
```

### 問題4: 地圖按鈕點擊無反應
**症狀**: 樓層按鈕點擊後無任何變化
**原因**: JavaScript 事件綁定問題

**解決方案**:
```html
<!-- 確保按鈕使用 onclick 屬性 -->
<button onclick="selectFloor('1F')">1F 長照</button>

<!-- 或在 JavaScript 中動態綁定 -->
document.querySelector('.floor-btn').addEventListener('click', () => {
    selectFloor('1F');
});
```

---

## 🚀 未來增強方向

### Phase 3 計畫

| 優先級 | 功能 | 難度 | 估算工時 |
|--------|------|------|--------|
| 🔴 高 | 虛擬漫步 (第一人稱導覽) | ★★★★ | 4小時 |
| 🔴 高 | 建築物內部細節模型 | ★★★★★ | 6小時 |
| 🟡 中 | AR模式 (手機增強現實) | ★★★★ | 3小時 |
| 🟡 中 | 人流量模擬動畫 | ★★★ | 2.5小時 |
| 🟢 低 | 四季變化模擬 | ★★ | 1.5小時 |
| 🟢 低 | PDF匯出功能 | ★★ | 1小時 |
| ⚪ 可選 | VR模式 (VR頭盔支持) | ★★★★ | 4小時 |
| ⚪ 可選 | 時間軸動畫 (建造過程) | ★★★ | 3小時 |

### 推薦優先順序
```
1️⃣ 虛擬漫步 (最高價值 + 最吸引評審)
2️⃣ 內部細節模型 (完整化系統)
3️⃣ AR模式 (移動設備友好)
4️⃣ 人流量模擬 (展示運營能力)
```

---

## 📞 支持與反饋

### 技術支持
遇到問題？檢查以下清單：

- [ ] 使用現代瀏覽器 (Chrome 90+, Firefox 88+, Edge 90+, Safari 14+)
- [ ] 已啟用硬體加速
- [ ] 網路連接正常 (NLSC WMTS 需聯網)
- [ ] 檢查瀏覽器控制臺 (F12) 是否有錯誤
- [ ] 嘗試無痕模式排除快取問題

### 改進建議

如有建議，請在下方記錄改進點：

```
改進項目: _________________
優先級: [ ] 高 [ ] 中 [ ] 低
具體說明: _________________
預期效果: _________________
```

---

## 📋 清單 (Checklist)

### 功能完成度
- [x] Leaflet 地圖集成 (NLSC 瓦片)
- [x] Three.js 3D 建築模型
- [x] 7層完整樓層規劃
- [x] 43個房間詳細規格
- [x] SVG 樓層平面圖 (B1-6F)
- [x] 跨系統同步機制
- [x] 地圖+3D+平面圖協聯動
- [x] 實時統計信息
- [ ] 虛擬漫步
- [ ] AR 模式
- [ ] VR 支持

### 品質保證
- [x] 樓層數據驗證
- [x] 顏色方案一致性
- [x] 性能優化 (FPS > 45)
- [x] 跨瀏覽器相容性測試
- [ ] 移動設備最佳化
- [ ] 無障礙設計 (WCAG 2.1)

### 文檔完整性
- [x] 使用指南
- [x] 技術文檔
- [x] API 文檔
- [x] 故障排除
- [x] 未來規劃
- [ ] 影片教學

---

**最後更新**: 2025-10-24
**版本**: 2.0 增強版
**維護者**: easterlin-hsinchu 專案團隊

---

## 🎯 設計理念總結

```
「用最先進的地理信息系統與3D可視化，
  讓竹科家庭一眼看清赤土崎多功能館的
  完整空間規劃與創新設施，
  為新竹政策黑客松冠軍奠定堅實的技術基礎。」
```

這個系統展現了：
- 🌍 **地理精準度**: NLSC 國土地圖 + GPS 座標
- 🏗️ **建築完整性**: 7層樓 + 43個房間 + 詳細規格
- 💻 **技術前瞻性**: Three.js + SVG + Leaflet 協聯動
- 🎨 **視覺表現力**: 賽博龍克風格 + 功能區色彩編碼
- 🔄 **系統協聯動**: 地圖、3D、平面圖真正同步

**期待未來的擴展與應用！** ✨
