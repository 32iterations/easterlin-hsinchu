<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ¤åœŸå´å¤šåŠŸèƒ½é¤¨ - 3Då®¤å…§å°è¦½ç³»çµ± (å°ˆæ¥­ç‰ˆ - ä¿®å¾©ç‰ˆ)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; font-family: 'Inter', 'Segoe UI', -apple-system, sans-serif; background: #0a0e27; overflow: hidden; color: #ffffff; }
        #app { width: 100%; height: 100%; display: grid; grid-template-columns: 1fr; grid-template-rows: 60px 1fr; }
        #topbar { background: rgba(10, 14, 39, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0, 255, 136, 0.2); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 1000; }
        .topbar-left { display: flex; align-items: center; gap: 30px; }
        .app-title { font-size: 16px; font-weight: 600; color: #00ff88; text-shadow: 0 0 10px rgba(0, 255, 136, 0.5); letter-spacing: 1px; }
        .mode-switcher { display: flex; gap: 8px; background: rgba(0, 255, 136, 0.1); padding: 4px; border-radius: 6px; border: 1px solid rgba(0, 255, 136, 0.2); }
        .mode-btn { padding: 6px 14px; border: none; background: transparent; color: #888; cursor: pointer; border-radius: 4px; font-size: 12px; font-weight: 500; transition: all 0.3s ease; }
        .mode-btn.active { background: #00ff88; color: #000; box-shadow: 0 0 15px rgba(0, 255, 136, 0.5); }
        .mode-btn:hover { color: #00ff88; }
        .topbar-right { display: flex; align-items: center; gap: 15px; }
        .stats { display: flex; gap: 20px; font-size: 11px; color: #888; font-family: 'Courier New', monospace; }
        .stat-item { display: flex; flex-direction: column; align-items: flex-end; }
        .stat-label { color: #666; font-size: 10px; }
        .stat-value { color: #00ff88; font-weight: 600; }
        #main-container { display: grid; grid-template-columns: 280px 1fr 320px; gap: 1px; background: #0a0e27; }
        #left-panel { background: rgba(10, 14, 39, 0.9); border-right: 1px solid rgba(0, 255, 136, 0.2); overflow-y: auto; padding: 20px; }
        .panel-title { font-size: 13px; font-weight: 600; color: #00ff88; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(0, 255, 136, 0.2); }
        .floor-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 30px; }
        .floor-btn { padding: 10px; background: rgba(0, 255, 136, 0.05); border: 1px solid rgba(0, 255, 136, 0.2); color: #888; cursor: pointer; border-radius: 4px; transition: all 0.3s ease; }
        .floor-btn:hover { background: rgba(0, 255, 136, 0.1); color: #00ff88; }
        .floor-btn.active { background: #00ff88; color: #000; }
        #canvas-container { background: #0a0e27; width: 100%; height: 100%; }
        #right-panel { background: rgba(10, 14, 39, 0.9); border-left: 1px solid rgba(0, 255, 136, 0.2); overflow-y: auto; padding: 20px; font-size: 12px; color: #aaa; }
        .info-section { margin-bottom: 20px; }
        .info-title { color: #00ff88; font-weight: 600; margin-bottom: 10px; }
        .info-item { margin: 5px 0; padding: 5px; background: rgba(0, 255, 136, 0.05); border-left: 2px solid rgba(0, 255, 136, 0.3); padding-left: 10px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 5000; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(0, 255, 136, 0.2); border-top: 4px solid #00ff88; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #00ff88; margin-top: 20px; font-size: 14px; }
        #status-bar { position: fixed; bottom: 10px; right: 10px; background: rgba(0, 0, 0, 0.8); color: #00ff88; padding: 10px 15px; border-radius: 4px; font-size: 11px; border: 1px solid rgba(0, 255, 136, 0.3); z-index: 999; }
    </style>
</head>
<body>
    <div id="app">
        <div id="topbar">
            <div class="topbar-left">
                <div class="app-title">ğŸ¢ èµ¤åœŸå´å¤šåŠŸèƒ½é¤¨ 3D å°è¦½</div>
                <div class="mode-switcher">
                    <button class="mode-btn active" id="exterior-btn">å¤–æ™¯</button>
                    <button class="mode-btn" id="interior-btn">å…§æ™¯</button>
                </div>
            </div>
            <div class="topbar-right">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-label">FPS</div>
                        <div class="stat-value" id="fps-display">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Objects</div>
                        <div class="stat-value" id="obj-display">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Memory</div>
                        <div class="stat-value" id="mem-display">0MB</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="main-container">
            <div id="left-panel">
                <div class="panel-title">æ¨“å±¤é¸æ“‡</div>
                <div class="floor-list" id="floor-list"></div>
                <div class="panel-title">æˆ¿é–“æ¸…å–®</div>
                <div id="rooms-list" style="font-size: 11px; color: #888;"></div>
            </div>

            <canvas id="canvas-container"></canvas>

            <div id="right-panel">
                <div class="panel-title">å ´æ™¯ä¿¡æ¯</div>
                <div id="info-panel"></div>
            </div>
        </div>
    </div>

    <div id="status-bar">â³ åˆå§‹åŒ–ä¸­...</div>

    <!-- å‹•æ…‹åŠ è¼‰ Three.jsï¼Œä¸ä½¿ç”¨ importmap ä»¥é¿å…é˜»å¡ -->
    <script>
        // ==================== å…¨å±€é…ç½® ====================
        const BUILDING_CONFIG = {
            width: 32,
            depth: 20,
            floors: ['B1', '1F', '2F', '3F', '4F'],
            floorHeights: [5, 4, 3.5, 3.5, 3.5]
        };

        // å…¨å±€å˜é‡
        let THREE, scene, camera, renderer;
        let currentFloor = '1F';
        let currentMode = 'exterior';
        let frameCount = 0, lastTime = Date.now(), fps = 0;

        // æˆ¿é—´æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼Œé‡ç‚¹åœ¨ä¿®å¤åŠ è½½ï¼‰
        const ROOM_DATA = {
            'B1': [
                { id: 'B1-01', name: 'åœè»Šå ´', area: 448 },
                { id: 'B1-02', name: 'ç©ºèª¿æ©Ÿæˆ¿', area: 12 }
            ],
            '1F': [
                { id: '1F-01', name: 'å¤±æ™ºç—‡å°ˆå€', area: 200 },
                { id: '1F-02', name: 'ä¸€èˆ¬æ—¥ç…§å€', area: 300 },
                { id: '1F-03', name: 'å…±äº«ç©ºé–“', area: 220 }
            ],
            '2F': [
                { id: '2F-01', name: 'å¬°å…’å®¤', area: 200 },
                { id: '2F-02', name: 'å¹¼å…’å®¤', area: 150 }
            ],
            '3F': [
                { id: '3F-01', name: 'è¦ªå­å…±å­¸å€', area: 150 },
                { id: '3F-02', name: 'æ™‚é–“éŠ€è¡Œè¾¦å…¬', area: 36 }
            ],
            '4F': [
                { id: '4F-01', name: 'STEMæ•™å®¤', area: 200 },
                { id: '4F-02', name: 'æŠ•å½±èˆ‡å±•ç¤ºå€', area: 150 }
            ]
        };

        // ==================== å¼‚æ­¥åŠ è½½ Three.js ====================
        async function loadThreeJS() {
            return new Promise((resolve, reject) => {
                // ç›´æ¥ä»æœ¬åœ°åŠ è½½ï¼Œä¸ä½¿ç”¨ importmap
                const script = document.createElement('script');
                script.src = '/libs/three/three.min.js';
                script.onload = () => {
                    console.log('âœ… Three.js loaded');
                    window.THREE = window.THREE || (typeof THREE !== 'undefined' ? THREE : null);
                    resolve(window.THREE);
                };
                script.onerror = () => {
                    console.error('âŒ Failed to load Three.js');
                    reject(new Error('Three.js loading failed'));
                };
                document.head.appendChild(script);
            });
        }

        // ==================== åœºæ™¯åˆå§‹åŒ– ====================
        function initScene() {
            const canvas = document.getElementById('canvas-container');

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0e27);
            scene.fog = new THREE.Fog(0x0a0e27, 100, 500);

            // Camera
            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.set(50, 40, 50);

            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            // å…‰çº¿
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
            sunLight.position.set(100, 100, 100);
            scene.add(sunLight);

            // åœ°é¢
            const groundGeo = new THREE.PlaneGeometry(200, 200);
            const groundMat = new THREE.MeshPhongMaterial({ color: 0x1a3a2a });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);

            // å»ºç¯‰ç‰©
            buildBuilding();

            // å¯åŠ¨åŠ¨ç”»å¾ªç¯
            animate();

            // äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();

            updateStatus('âœ… å ´æ™¯å·²åŠ è¼‰');
        }

        function buildBuilding() {
            const mat = new THREE.MeshStandardMaterial({ color: 0x888888 });

            // ä¸»å»ºç­‘ç‰©
            const geo = new THREE.BoxGeometry(BUILDING_CONFIG.width, 15, BUILDING_CONFIG.depth);
            const building = new THREE.Mesh(geo, mat);
            building.position.y = 7.5;
            scene.add(building);

            // ç®€å•æ·»åŠ æ¥¼å±‚ï¼ˆä¸ºæ€§èƒ½ä¼˜åŒ–ï¼Œåªæ·»åŠ å½“å‰æ¥¼å±‚çš„é«˜äº®ï¼‰
            BUILDING_CONFIG.floors.forEach((floor, index) => {
                const floorGeo = new THREE.PlaneGeometry(BUILDING_CONFIG.width - 2, BUILDING_CONFIG.depth - 2);
                const floorMat = new THREE.MeshStandardMaterial({
                    color: floor === currentFloor ? 0x00ff88 : 0x444444,
                    emissive: floor === currentFloor ? 0x00ff88 : 0x000000
                });
                const floorMesh = new THREE.Mesh(floorGeo, floorMat);
                floorMesh.position.y = 5 + index * 3;
                floorMesh.rotation.x = -Math.PI / 2;
                scene.add(floorMesh);
            });

            console.log('âœ… Building created with', scene.children.length, 'objects');
        }

        function animate() {
            requestAnimationFrame(animate);

            // è‡ªåŠ¨æ—‹è½¬
            scene.children.forEach(obj => {
                if (obj.geometry && obj.geometry.type === 'BoxGeometry') {
                    obj.rotation.y += 0.0005;
                }
            });

            renderer.render(scene, camera);

            // æ›´æ–° FPS
            frameCount++;
            const now = Date.now();
            if (now >= lastTime + 1000) {
                fps = frameCount;
                frameCount = 0;
                lastTime = now;
                document.getElementById('fps-display').textContent = fps;
                document.getElementById('obj-display').textContent = scene.children.length;
                if (performance.memory) {
                    const mem = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
                    document.getElementById('mem-display').textContent = mem + 'MB';
                }
            }
        }

        function setupEventListeners() {
            // æ¥¼å±‚é€‰æ‹©
            const floorList = document.getElementById('floor-list');
            BUILDING_CONFIG.floors.forEach(floor => {
                const btn = document.createElement('button');
                btn.className = 'floor-btn' + (floor === currentFloor ? ' active' : '');
                btn.textContent = floor;
                btn.onclick = () => selectFloor(floor);
                floorList.appendChild(btn);
            });

            // æ¨¡å¼åˆ‡æ¢
            document.getElementById('exterior-btn').onclick = () => switchMode('exterior');
            document.getElementById('interior-btn').onclick = () => switchMode('interior');

            // çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', () => {
                const canvas = document.getElementById('canvas-container');
                camera.aspect = canvas.clientWidth / canvas.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            });
        }

        function selectFloor(floor) {
            currentFloor = floor;
            updateUI();
            updateStatus(`âœ… å·²é¸æ“‡ ${floor} æ¨“`);
        }

        function switchMode(mode) {
            currentMode = mode;
            updateUI();
            updateStatus(`âœ… å·²åˆ‡æ›è‡³${mode === 'exterior' ? 'å¤–æ™¯' : 'å…§æ™¯'}æ¨¡å¼`);
        }

        function updateUI() {
            // æ›´æ–°æ¥¼å±‚æŒ‰é’®
            document.querySelectorAll('.floor-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === currentFloor);
            });

            // æ›´æ–°æ¨¡å¼æŒ‰é’®
            document.getElementById('exterior-btn').classList.toggle('active', currentMode === 'exterior');
            document.getElementById('interior-btn').classList.toggle('active', currentMode === 'interior');

            // æ›´æ–°æˆ¿é—´åˆ—è¡¨
            const roomsList = document.getElementById('rooms-list');
            roomsList.innerHTML = '';
            const rooms = ROOM_DATA[currentFloor] || [];
            rooms.forEach(room => {
                const item = document.createElement('div');
                item.className = 'info-item';
                item.textContent = `${room.name} (${room.area}mÂ²)`;
                roomsList.appendChild(item);
            });

            // æ›´æ–°ä¿¡æ¯é¢æ¿
            const infoPanel = document.getElementById('info-panel');
            infoPanel.innerHTML = `
                <div class="info-section">
                    <div class="info-title">ç•¶å‰æ¨“å±¤: ${currentFloor}</div>
                    <div class="info-item">æˆ¿é–“æ•¸: ${rooms.length}</div>
                    <div class="info-item">ç¸½é¢ç©: ${rooms.reduce((a, b) => a + b.area, 0)}mÂ²</div>
                </div>
                <div class="info-section">
                    <div class="info-title">è¦–åœ–æ¨¡å¼</div>
                    <div class="info-item">${currentMode === 'exterior' ? 'ğŸŒ å¤–æ™¯è¦–åœ–' : 'ğŸ  å…§æ™¯è¦–åœ–'}</div>
                </div>
            `;
        }

        function updateStatus(msg) {
            document.getElementById('status-bar').textContent = msg;
        }

        // ==================== ä¸»å…¥å£ ====================
        async function startup() {
            try {
                updateStatus('â³ åŠ è¼‰ Three.js...');
                THREE = await loadThreeJS();

                updateStatus('ğŸ—ï¸ åˆå§‹åŒ–å ´æ™¯...');
                await new Promise(resolve => setTimeout(resolve, 100)); // è®©æµè§ˆå™¨å‘¼å¸

                initScene();
                updateUI();

                // ç§»é™¤åŠ è½½è¦†ç›–å±‚
                updateStatus('âœ… å®Œæˆï¼ä½¿ç”¨ä¸Šæ–¹æŒ‰é’®è¿›è¡Œäº¤äº’');
            } catch (err) {
                console.error('âŒ Startup error:', err);
                updateStatus('âŒ åŠ è¼‰å¤±æ•—: ' + err.message);
            }
        }

        // DOMContentLoaded æ—¶å¯åŠ¨
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startup);
        } else {
            startup();
        }
    </script>
</body>
</html>
