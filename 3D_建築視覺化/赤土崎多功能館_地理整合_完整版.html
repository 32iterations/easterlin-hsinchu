<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ¤åœŸå´å¤šåŠŸèƒ½é¤¨ - åœ°ç†ä½ç½®æ•´åˆ3Då¯è¦–åŒ–ç³»çµ±</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: #000;
        }

        #map-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 45%;
            height: 100%;
            background: #1a1a2e;
            border-right: 3px solid #00ff88;
            z-index: 10;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #canvas-container {
            position: absolute;
            right: 0;
            top: 0;
            width: 55%;
            height: 100%;
            background: #0a0e27;
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* åœ°åœ–é ‚éƒ¨ä¿¡æ¯é¢æ¿ */
        .map-info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff88;
            padding: 15px 20px;
            border-radius: 8px;
            border: 2px solid #00ff88;
            font-size: 12px;
            z-index: 400;
            max-width: 300px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .map-info-panel h3 {
            font-size: 14px;
            margin-bottom: 8px;
            text-shadow: 0 0 10px #00ff88;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }

        .info-label {
            color: #666;
        }

        .info-value {
            color: #00ff88;
            font-weight: bold;
        }

        /* 3Dè¦–è§’ä¿¡æ¯é¢æ¿ */
        #info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 320px;
            max-height: 80vh;
            background: rgba(10, 20, 40, 0.95);
            border: 2px solid #ff00ff;
            border-radius: 12px;
            padding: 15px;
            color: #fff;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.3);
        }

        #info-panel h2 {
            color: #ff00ff;
            font-size: 16px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #ff00ff;
        }

        #info-panel h3 {
            color: #00ff88;
            font-size: 13px;
            margin-top: 12px;
            margin-bottom: 8px;
            border-bottom: 1px solid #00ff88;
            padding-bottom: 5px;
        }

        .floor-item {
            background: rgba(0, 255, 136, 0.1);
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #00ff88;
            font-size: 11px;
            color: #aaa;
        }

        .floor-item.active {
            background: rgba(255, 0, 255, 0.2);
            border-left-color: #ff00ff;
        }

        /* åº•éƒ¨æ§åˆ¶é¢æ¿ */
        #control-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: calc(45% - 40px);
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ccff;
            border-radius: 10px;
            padding: 15px;
            color: #00ccff;
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 204, 255, 0.3);
        }

        .control-title {
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .floor-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
        }

        .floor-btn {
            background: rgba(0, 204, 255, 0.2);
            color: #00ccff;
            border: 1px solid #00ccff;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .floor-btn:hover {
            background: rgba(0, 204, 255, 0.4);
        }

        .floor-btn.active {
            background: #00ccff;
            color: #000;
            box-shadow: 0 0 10px #00ccff;
        }

        /* 3Dæ§åˆ¶é¢æ¿ */
        #3d-control {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: calc(55% - 40px);
            background: rgba(10, 20, 40, 0.95);
            border: 2px solid #ffaa00;
            border-radius: 10px;
            padding: 15px;
            color: #ffaa00;
            z-index: 100;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.3);
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-3d {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
            border: 1px solid #ffaa00;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.3s;
        }

        .btn-3d:hover {
            background: rgba(255, 170, 0, 0.4);
        }

        .btn-3d.active {
            background: #ffaa00;
            color: #000;
            box-shadow: 0 0 10px #ffaa00;
        }

        /* çµ±è¨ˆä¿¡æ¯ */
        #stats {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(10, 20, 40, 0.8);
            border: 1px solid #00ff88;
            color: #00ff88;
            padding: 12px 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            z-index: 50;
        }

        .stat-row {
            padding: 2px 0;
        }

        /* Leaflet è‡ªå®šç¾©æ¨£å¼ */
        .leaflet-container {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
        }

        .building-marker {
            width: 30px;
            height: 30px;
            background: #ff00ff;
            border: 2px solid #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.8);
        }

        /* æ¨“å±¤è©³æƒ… */
        .floor-detail {
            background: rgba(0, 255, 136, 0.1);
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
            border-left: 3px solid #00ff88;
            font-size: 10px;
        }

        .floor-detail-title {
            color: #00ff88;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .floor-detail-desc {
            color: #888;
            line-height: 1.4;
        }

        /* æ¨“å±¤å¹³é¢åœ–å®¹å™¨ */
        #floorplan-container {
            position: absolute;
            bottom: 120px;
            left: 20px;
            width: calc(45% - 40px);
            height: 200px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 10px;
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            display: none;
            overflow: hidden;
        }

        #floorplan-container.active {
            display: block;
        }

        .floorplan-title {
            color: #00ff88;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 0 5px #00ff88;
        }

        #floorplan-canvas {
            width: 100%;
            height: calc(100% - 20px);
            background: #1a1a2e;
            border-radius: 4px;
        }

        /* SVGå¹³é¢åœ–æ¨£å¼ */
        .floorplan-room {
            fill: rgba(0, 255, 136, 0.2);
            stroke: #00ff88;
            stroke-width: 1;
        }

        .floorplan-room:hover {
            fill: rgba(0, 255, 136, 0.4);
        }

        .floorplan-text {
            font-size: 8px;
            fill: #00ff88;
            text-anchor: middle;
            pointer-events: none;
        }

        /* åŒæ­¥æŒ‡ç¤ºå™¨ */
        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Leafletåœ°åœ–å®¹å™¨ -->
    <div id="map-container">
        <div id="map"></div>

        <!-- åœ°åœ–ä¿¡æ¯é¢æ¿ -->
        <div class="map-info-panel">
            <h3>ğŸ“ èµ¤åœŸå´å¤šåŠŸèƒ½é¤¨</h3>
            <div class="info-row">
                <span class="info-label">ä½ç½®ï¼š</span>
                <span class="info-value">æ–°ç«¹å¸‚æ±å€</span>
            </div>
            <div class="info-row">
                <span class="info-label">åº§æ¨™ï¼š</span>
                <span class="info-value" id="coord-display">24.82Â°N, 120.94Â°E</span>
            </div>
            <div class="info-row">
                <span class="info-label">åœ°å€ï¼š</span>
                <span class="info-value">ç«¹ç§‘åœ’å€è¿‘éƒŠ</span>
            </div>
            <div class="info-row">
                <span class="info-label">åŸºåœ°é¢ç©ï¼š</span>
                <span class="info-value">8,000 mÂ²</span>
            </div>
            <div class="info-row">
                <span class="info-label">å»ºç¯‰é¢ç©ï¼š</span>
                <span class="info-value">3,833 mÂ²</span>
            </div>
        </div>

        <!-- æ¨“å±¤å¹³é¢åœ– -->
        <div id="floorplan-container">
            <div class="floorplan-title">ğŸ“ æ¨“å±¤å¹³é¢åœ–</div>
            <svg id="floorplan-canvas"></svg>
        </div>

        <!-- æ¨“å±¤æ§åˆ¶é¢æ¿ -->
        <div id="control-panel">
            <div class="control-title">ğŸ® æ¨“å±¤é¸æ“‡</div>
            <div class="floor-buttons">
                <button class="floor-btn" onclick="selectFloor('B1')">B1 åœè»Š</button>
                <button class="floor-btn" onclick="selectFloor('1F')">1F é•·ç…§</button>
                <button class="floor-btn" onclick="selectFloor('2F')">2F æ‰˜å¬°</button>
                <button class="floor-btn" onclick="selectFloor('3F')">3F å®¶åº­</button>
                <button class="floor-btn" onclick="selectFloor('4F')">4F é’å°‘å¹´</button>
                <button class="floor-btn" onclick="selectFloor('5F')">5F ç¶ èƒ½</button>
                <button class="floor-btn active" onclick="selectFloor('6F')">6F æœƒè­°</button>
            </div>
            <p style="font-size: 10px; color: #666; margin-top: 10px;">ğŸ’¡ é»æ“Šæ¨“å±¤æŒ‰éˆ•åœ¨3Dè¦–è§’ä¸­æŸ¥çœ‹<br><span class="sync-indicator"></span>åœ°åœ–å’Œ3DåŒæ­¥</p>
        </div>
    </div>

    <!-- Three.js 3Dè¦–è§’å®¹å™¨ -->
    <div id="canvas-container"></div>

    <!-- 3Dä¿¡æ¯é¢æ¿ -->
    <div id="info-panel">
        <h2>ğŸ“ ç©ºé–“è¦åŠƒè©³æƒ…</h2>
        <div id="floor-details"></div>
    </div>

    <!-- çµ±è¨ˆä¿¡æ¯ -->
    <div id="stats">
        <div class="stat-row">ğŸ¢ å»ºç¯‰ç‰©</div>
        <div class="stat-row">FPS: <span id="fps">60</span></div>
        <div class="stat-row">Objects: <span id="obj-count">0</span></div>
        <div class="stat-row" style="margin-top: 8px; border-top: 1px solid #00ff88; padding-top: 8px;">
            <div>ğŸ“Š ç•¶å‰æ¨“å±¤</div>
            <div id="current-floor-info" style="font-size: 9px; color: #ff00ff;">6F - æœƒè­°å»³</div>
        </div>
    </div>

    <!-- 3Dæ§åˆ¶é¢æ¿ -->
    <div id="3d-control">
        <div class="control-title">âš™ï¸ æª¢è¦–æ¨¡å¼</div>
        <div class="btn-group">
            <button class="btn-3d active" onclick="setViewMode('normal')">æ­£å¸¸</button>
            <button class="btn-3d" onclick="setViewMode('wireframe')">ç·šæ¡†</button>
            <button class="btn-3d" onclick="setViewMode('interior')">å…§éƒ¨</button>
            <button class="btn-3d" onclick="toggleAutoRotate()">è‡ªå‹•æ—‹è½‰</button>
        </div>
    </div>

    <!-- è…³æœ¬å¼•å…¥ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@r128/examples/js/controls/OrbitControls.js"></script>

    <script>
        // ==================== å…¨å±€é…ç½® ====================

        // èµ¤åœŸå´å¤šåŠŸèƒ½é¤¨åæ¨™
        const BUILDING_LOCATION = {
            lat: 24.8247,  // æ–°ç«¹å¸‚æ±å€èµ¤åœŸå´
            lng: 120.9456
        };

        // æ¨“å±¤è©³ç´°è¦åŠƒæ•¸æ“š
        const FLOOR_PLANS = {
            B1: {
                name: 'B1 - åœè»Šå ´+æ©Ÿæˆ¿',
                color: 0x7a7a7a,
                height: 5,
                description: 'åœ°é¢åœè»Š60è»Šä½ | ç©ºèª¿æ©Ÿæˆ¿ | é…é›»å®¤ | UPSç³»çµ± | çµ¦æ’æ°´ç³»çµ± | å€å¡Šéˆè¼•é‡ç¯€é»',
                rooms: [
                    { name: 'åœè»Šå ´', area: '450 mÂ²', equipment: '60è»Šä½ã€å‹•ç·šæ¨™ç·šã€æ„Ÿæ¸¬åœè»Š' },
                    { name: 'ç©ºèª¿æ©Ÿæˆ¿', area: '50 mÂ²', equipment: '2å¥—150RTå†·æš–ä¸»æ©Ÿã€æ–°é¢¨ç³»çµ±15,000CMH' },
                    { name: 'é…é›»å®¤', area: '40 mÂ²', equipment: '800Aä¸»é…ç›¤ã€15è¿´è·¯ã€UPS 200kVA' },
                    { name: 'çµ¦æ’æ°´', area: '30 mÂ²', equipment: '20å™¸æ°´å¡”ã€MBRè†œç”Ÿç‰©åæ‡‰å™¨' },
                    { name: 'é›¨æ°´å›æ”¶', area: '20 mÂ²', equipment: '300 mÂ³å„²å­˜æ± ã€å¹´å›æ”¶1,200 mÂ³' }
                ]
            },
            '1F': {
                name: '1F - AIè¨˜æ†¶é‡ç”Ÿ+é•·ç…§æ—¥ç…§',
                color: 0x9a9a9a,
                height: 4,
                description: 'å¤±æ™ºç—‡å°ˆå€(200 mÂ²) | æŠ•å½±é«”é©—å€ | ç©¿æˆ´ç›£æ¸¬ | æ—¥ç…§æ´»å‹•å€(80äºº)',
                rooms: [
                    { name: 'å¤±æ™ºç—‡å°ˆå€', area: '200 mÂ²', equipment: '4KæŠ•å½±(10mÃ—3m)ã€äº’å‹•æŠ•å½±Ã—2ã€ç©¿æˆ´é…ç½®' },
                    { name: 'AIæŠ•å½±æ’­æ”¾', area: '100 mÂ²', equipment: '3,000æµæ˜æŠ•å½±æ©Ÿã€æ™ºæ…§æ‰‹éŒ¶20å€‹ã€è·Œå€’æ„Ÿæ¸¬15å€‹' },
                    { name: 'å¾©å¥è¨“ç·´å€', area: '80 mÂ²', equipment: 'è·‘æ­¥æ©ŸÃ—2ã€è…³è¸è»ŠÃ—3ã€å¹³è¡¡è¨“ç·´å¢ŠÃ—5' },
                    { name: 'è—è¡“ç™‚æ³•å€', area: '80 mÂ²', equipment: 'é‹¼ç´éµç›¤ã€ç¹ªç•«æ¡ŒÃ—2ã€éŸ³æ¨‚æ²»ç™‚ç³»çµ±' },
                    { name: 'èªçŸ¥è¨“ç·´å€', area: '60 mÂ²', equipment: 'å¹³æ¿é›»è…¦Ã—5ã€Lumosityè»Ÿé«”ã€MMSEè©•ä¼°ç³»çµ±' },
                    { name: 'å…±ç”¨é¤å»³', area: '120 mÂ²', equipment: 'åœ“å½¢é¤æ¡ŒÃ—6(8äºº/æ¡Œ)ã€æª¢æ¸¬ç›¤å­ã€æº«åº¦æ„Ÿæ¸¬' },
                    { name: 'å‚™é¤å»šæˆ¿', area: '40 mÂ²', equipment: 'è’¸é£¯ç®±ã€å¾®æ³¢çˆã€æ”ªæ‹Œæ©Ÿã€æ´—ç¢—æ©Ÿ80Â°C' },
                    { name: 'è­·ç†ç«™', area: '20 mÂ²', equipment: 'å¤šå±ç›£æ§ç³»çµ±(4Ã—27å‹)ã€è­¦å ±ç³»çµ±ã€å†°ç®±å„²å­˜' }
                ]
            },
            '2F': {
                name: '2F - SIDSç›£æ¸¬+å…¬å…±æ‰˜å¬°',
                color: 0x9a9a9a,
                height: 3.5,
                description: 'SIDSç›£æ¸¬ç³»çµ±(50åºŠ) | æ‰˜å¬°æ´»å‹•å€ | æ„ŸæŸ“éš”é›¢è¨­è¨ˆ | AIå¥åº·é æ¸¬',
                rooms: [
                    { name: 'SIDSç›£æ¸¬ç³»çµ±', area: '200 mÂ²', equipment: 'ç´…å¤–æ„Ÿæ¸¬(98%)ã€å¿ƒå¾‹æ„Ÿæ¸¬(99%)ã€é«”æº«è²¼ç‰‡(97%)ã€è²ç´‹AI(92%)' },
                    { name: 'å¬°å…’åºŠå€', area: '200 mÂ²', equipment: '50å¼µå¬°å…’åºŠ(30cmé–“è·)ã€æ†æº«22-24Â°Cã€æ¿•åº¦45-65%' },
                    { name: 'ä¸­å¤®ç›£æ§', area: '30 mÂ²', equipment: '50åºŠå„€è¡¨æ¿ã€RGBç‡ˆä¿¡è™Ÿã€è­·ç†å¸«æ¨æ’­ç³»çµ±' },
                    { name: 'å¬°å…’æ´»å‹•å€', area: '50 mÂ²', equipment: 'çˆ¬è¡Œå¢Šã€é»‘ç™½é–ƒå¡ã€æ„Ÿå®˜ç©å…·ã€å®‰å…¨é¡' },
                    { name: 'å¹¼å…’æ´»å‹•å€', area: '50 mÂ²', equipment: 'æ”€çˆ¬æ¶ã€æ»‘æ¢¯ã€æ–æ–é¦¬Ã—3ã€çƒæ± ã€è·³è·³å¢Š' },
                    { name: 'AIæ•…äº‹æ™‚é–“', area: '20 mÂ²', equipment: 'Full-HDæŠ•å½±æ©Ÿã€120å‹å¹•ã€æ‰‹å‹¢è­˜åˆ¥ã€èªéŸ³äº’å‹•' },
                    { name: 'é¤µé£Ÿæ›å°¿å€', area: '80 mÂ²', equipment: 'å¥¶ç“¶æ¶ˆæ¯’æ©ŸÃ—2ã€æº«å¥¶æ©ŸÃ—2ã€æ›å°¿å¸ƒå°Ã—3ã€å†°ç®±Ã—2' },
                    { name: 'è¡›æµ´è¨­æ–½', area: '40 mÂ²', equipment: 'å¹¼å…’å»æ‰€Ã—2ã€æ´—æ‰‹å°Ã—2ã€æµ´ç›†Ã—2ã€æ¶ˆæ¯’ç‡ˆÃ—2ã€è’¸æ±½æ¶ˆæ¯’' }
                ]
            },
            '3F': {
                name: '3F - è¦ªå­å…±å­¸+æ™‚é–“éŠ€è¡Œ',
                color: 0xb0b0b0,
                height: 3.5,
                description: 'è¦ªå­å…±å­¸å€(60å®¶åº­) | æ™‚é–“éŠ€è¡Œç®¡ç†ä¸­å¿ƒ | MRäº’å‹•ç©ºé–“ | æ•…äº‹åŠ‡å ´',
                rooms: [
                    { name: 'é–±è®€å€', area: '80 mÂ²', equipment: 'æ›¸æ«ƒÃ—3(3,000å†Š)ã€è¦ªå­åº§æ¤…Ã—8ã€äº’å‹•æŠ•å½±Ã—6' },
                    { name: 'æ•…äº‹åŠ‡å ´', area: '120 mÂ²', equipment: 'åŠ‡å°Ã—1ã€æŠ•å½±å¹•Ã—1ã€åº§ä½Ã—30ã€AIæ•…äº‹ç³»çµ±' },
                    { name: 'ä¸»é¡Œå­¸ç¿’è§’', area: '100 mÂ²', equipment: 'æ¨‚é«˜ã€é›»è·¯æ¿ã€ç¨®æ¤ç›†ã€3Dåˆ—å°æ©Ÿã€STEAMæ•™æ' },
                    { name: 'æ™‚é–“éŠ€è¡Œè¾¦å…¬', area: '60 mÂ²', equipment: 'Time Brokeråº§ä½Ã—3ã€æœƒå“¡è«®è©¢å€ã€é›»è…¦ç³»çµ±ã€æª”æ¡ˆæ«ƒ' },
                    { name: 'å°å¸«åº§ä½å€', area: '60 mÂ²', equipment: 'è·æ¶¯å°å¸«åº§ä½Ã—3ã€éš±ç§å¸ƒç°¾ã€4Kæ”åƒæ©Ÿã€é™å™ªéº¥å…‹é¢¨' },
                    { name: 'æœˆåº¦è¡¨æšå€', area: '30 mÂ²', equipment: 'è­‰æ›¸å±•ç¤ºã€æ‹ç…§å€ã€ç¤¾ç¾¤åˆ†äº«ç‰†' },
                    { name: 'æ··åˆç¾å¯¦(MR)å€', area: '50 mÂ²', equipment: 'VRé ­ç›”Ã—2ã€éº¥å…‹é¢¨èˆ‡èªéŸ³ç³»çµ±ã€è§€çœ‹å¸­Ã—20ã€å¤§å±å¹•åŒæ­¥' }
                ]
            },
            '4F': {
                name: '4F - å…ƒå®‡å®™å…±å­¸æ•™å®¤+é’å°‘å¹´',
                color: 0xf5f5f5,
                height: 3.5,
                description: 'STEMæ•™å®¤(200 mÂ²) | VRæ²‰æµ¸æ•™å®¤(150 mÂ²) | è·æ¶¯å°å¸« | é è·æ•™å­¸',
                rooms: [
                    { name: 'STEMæ•™å®¤', area: '100 mÂ²', equipment: 'é›»è…¦Ã—15(i7+RTX4060)ã€ä¼ºæœå™¨Ã—1ã€å…‰çº–éª¨å¹¹1.2Gbps' },
                    { name: 'æ©Ÿå™¨äººå€', area: '60 mÂ²', equipment: 'ArduinoÃ—10ã€Raspberry PiÃ—10ã€3Dåˆ—å°æ©Ÿã€IoTå¥—çµ„Ã—10' },
                    { name: 'é›»å­å·¥ä½œå°', area: '40 mÂ²', equipment: 'ç„Šæ¥å°Ã—3ã€è¬ç”¨è¡¨ã€ç¤ºæ³¢å™¨ã€é‚è¼¯åˆ†æå„€ã€æ€¥æ•‘åŒ…' },
                    { name: 'VRç¡¬é«”å€', area: '30 mÂ²', equipment: 'VRé ­ç›”Ã—10(Meta Quest 3)ã€è¿½è¹¤åŸºåœ°å°Ã—4ã€æ§åˆ¶å™¨Ã—20' },
                    { name: 'VRæ²‰æµ¸æ•™å®¤', area: '120 mÂ²', equipment: '4KæŠ•å½±æ©ŸÃ—2ã€3mÃ—2må¹•Ã—2ã€5G DASç³»çµ±ã€é‚Šç·£è¨ˆç®—ä¼ºæœå™¨' },
                    { name: 'è™›æ“¬å¯¦é©—å®¤', area: '40 mÂ²', equipment: 'åŒ–å­¸å¯¦é©—å ´æ™¯ã€ç‰©ç†æ¨¡æ“¬ã€ç”Ÿç‰©è§£å‰–ã€é‡å­åŠ›å­¸VR' },
                    { name: 'é è·å°å¸«å®¤', area: '40 mÂ²', equipment: 'è™›æ“¬ç™½æ¿ã€AvataråŒ–èº«ã€å¯¦æ™‚äº’å‹•ã€æˆç¸¾ç´€éŒ„' },
                    { name: 'è·æ¶¯å°å¸«å€', area: '50 mÂ²', equipment: 'VRæœƒè­°å®¤ã€æˆå°±å±•ç¤ºã€æ•¸ä½å±¥æ­·ç³»çµ±' }
                ]
            },
            '5F': {
                name: '5F - ç¶ èƒ½ç³»çµ±+å¤šåŠŸèƒ½åŸ¹è¨“',
                color: 0xf5f5f5,
                height: 3.5,
                description: 'å¤ªé™½èƒ½50kWp | ç¶ å±‹é ‚250 mÂ² | å“¡å·¥åŸ¹è¨“ä¸­å¿ƒ | ç ”ç©¶å¯¦é©—å®¤',
                rooms: [
                    { name: 'å¤ªé™½èƒ½é¢æ¿', area: '300 mÂ²', equipment: '50kWp(120ç‰‡Ã—430W)ã€å¹´ç™¼60,000kWhã€å¹´çœNT$270K' },
                    { name: 'å„²èƒ½é›»æ± ', area: '30 mÂ²', equipment: '100kWhé‹°é›»æ± ã€BMSç®¡ç†ç³»çµ±ã€10å¹´å£½å‘½' },
                    { name: 'ç¶ å±‹é ‚', area: '250 mÂ²', equipment: 'è‰çš®èˆ‡çŒæœ¨ã€éš”ç†±30%ã€PM2.5å¸é™„ã€ç”Ÿç‰©å¤šæ¨£æ€§' },
                    { name: 'åŸ¹è¨“æ•™å®¤', area: '60 mÂ²', equipment: 'æŠ•å½±ç³»çµ±ã€60äººå®¹ç´ã€éŸ³éŸ¿è¨­å‚™ã€åº§æ¤…éˆæ´»é…ç½®' },
                    { name: 'æœƒè­°å®¤', area: '40 mÂ²', equipment: 'æœƒè­°æ¡Œã€20äººå®¹ç´ã€è¦–è¨Šç³»çµ±ã€ç™½æ¿' },
                    { name: 'å¯¦é©—å®¤', area: '50 mÂ²', equipment: 'VR/ARæ¸¬è©¦ã€AIæ¼”ç®—æ³•è©¦é©—ã€ç¤¾ç¦å‰µæ–°è¨­è¨ˆ' },
                    { name: 'è¾¦å…¬å€', area: '70 mÂ²', equipment: 'åº§ä½Ã—15ã€ç¤¾ç¦å°ˆæ¥­äººå“¡ã€è³‡æ–™åˆ†æåœ˜éšŠã€ç‡Ÿé‹äººå“¡' }
                ]
            },
            '6F': {
                name: '6F - å…¬å…±æœƒè­°å»³+éœ²è‡º',
                color: 0xf0f0f0,
                height: 3.5,
                description: 'å¤šåŠŸèƒ½æœƒè­°å»³(300äºº) | å±‹é ‚éœ²è‡º(200 mÂ²) | èµ¤åœŸå´å…¬åœ’çœºæœ›',
                rooms: [
                    { name: 'æœƒè­°å»³', area: '440 mÂ²', equipment: '300äººå®¹ç´ã€å¯åˆ†éš”2-3å»³ã€4KæŠ•å½±+120å‹å¹•ã€åŒæ­¥ç¿»è­¯(3èª)' },
                    { name: 'å‚™é¤å€', area: '30 mÂ²', equipment: 'å°å‹å»šæˆ¿ã€è‡ªåŠ©é¤é…ç½®ã€é£²å“æ©Ÿã€å†°ç®±' },
                    { name: 'è¡›æµ´è¨­æ–½', area: '40 mÂ²', equipment: 'å»æ‰€Ã—12ã€ç„¡éšœç¤™å»æ‰€ã€æ´—æ‰‹å€' },
                    { name: 'èˆå°', area: '80 mÂ²', equipment: 'æŠ•å½±ç³»çµ±ã€éŸ³éŸ¿ç³»çµ±ã€ç‡ˆå…‰æ§åˆ¶ã€éº¥å…‹é¢¨Ã—5' },
                    { name: 'å±‹é ‚éœ²è‡º', area: '200 mÂ²', equipment: 'åº§ä½èˆ‡é®é™½ã€çœºæœ›èµ¤åœŸå´å…¬åœ’èˆ‡ç«¹ç§‘åœ’å€ã€æ‹ç…§æ‰“å¡é»' },
                    { name: 'å„²å‚™å€', area: '50 mÂ²', equipment: 'æœªä¾†ç³»çµ±æ“´å±•é ç•™ã€çµæ§‹æ‰¿é‡é ç•™' }
                ]
            }
        };

        // ==================== Leafletåœ°åœ–åˆå§‹åŒ– ====================
        let map;
        let buildingMarker;

        function initMap() {
            // åˆå§‹åŒ–åœ°åœ–
            map = L.map('map').setView([BUILDING_LOCATION.lat, BUILDING_LOCATION.lng], 16);

            // ä½¿ç”¨NLSCå°ç£åœ°åœ– (æ­£å°„å½±åƒåœ–)
            L.tileLayer('https://wmts.nlsc.gov.tw/wmts/ORT/default//GoogleMapsCompatible_Level{z}/{y}/{x}', {
                minZoom: 1,
                maxZoom: 20,
                attribution: 'åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ'
            }).addTo(map);

            // æ·»åŠ å»ºç¯‰æ¨™è¨˜
            const markerIcon = L.divIcon({
                html: '<div class="building-marker">ğŸ¢</div>',
                iconSize: [30, 30],
                className: 'custom-marker'
            });

            buildingMarker = L.marker(
                [BUILDING_LOCATION.lat, BUILDING_LOCATION.lng],
                { icon: markerIcon }
            ).addTo(map);

            // å»ºç¯‰å½ˆçª—
            buildingMarker.bindPopup(`
                <div style="color: #000; font-size: 12px; font-weight: bold;">
                    <strong>èµ¤åœŸå´å¤šåŠŸèƒ½é¤¨</strong><br>
                    æ–°ç«¹å¸‚æ±å€<br>
                    24.8247Â°N, 120.9456Â°E<br>
                    åŸºåœ°é¢ç©: 8,000 mÂ²<br>
                    å»ºç¯‰é¢ç©: 3,833 mÂ²<br>
                    æ¨“å±¤: B1-6F
                </div>
            `);

            // ç¹ªè£½åŸºåœ°é‚Šç•Œï¼ˆç´„8,000 mÂ²çš„çŸ©å½¢ï¼‰
            // è¨ˆç®—åŸºåœ°é‚Šç•Œï¼ˆä¼°è¨ˆ200m Ã— 40mï¼‰
            const bounds = [
                [BUILDING_LOCATION.lat - 0.0009, BUILDING_LOCATION.lng - 0.0015],
                [BUILDING_LOCATION.lat + 0.0009, BUILDING_LOCATION.lng + 0.0015]
            ];

            const rectangle = L.rectangle(bounds, {
                color: '#00ff88',
                weight: 2,
                opacity: 0.7,
                fill: true,
                fillColor: '#00ff88',
                fillOpacity: 0.1
            }).addTo(map);

            // æ·»åŠ åœ“å½¢ç·©è¡å€(500mç¤¾å€æœå‹™ç¯„åœ)
            L.circle(
                [BUILDING_LOCATION.lat, BUILDING_LOCATION.lng],
                500,
                {
                    color: '#ff00ff',
                    weight: 1,
                    opacity: 0.3,
                    fill: true,
                    fillColor: '#ff00ff',
                    fillOpacity: 0.05
                }
            ).addTo(map);

            // æ·»åŠ åœ–å±¤æ§åˆ¶ï¼ˆNLSCæä¾›çš„å¤šå€‹åœ–å±¤ï¼‰
            const baseMaps = {
                'æ­£å°„å½±åƒ': L.tileLayer('https://wmts.nlsc.gov.tw/wmts/ORT/default//GoogleMapsCompatible_Level{z}/{y}/{x}', {
                    attribution: 'åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ',
                    minZoom: 1,
                    maxZoom: 20
                }),
                'åœ°å½¢åœ–': L.tileLayer('https://wmts.nlsc.gov.tw/wmts/MAPNIK/default//GoogleMapsCompatible_Level{z}/{y}/{x}', {
                    attribution: 'åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ',
                    minZoom: 1,
                    maxZoom: 20
                }),
                'é€šç”¨é›»å­åœ°åœ–': L.tileLayer('https://wmts.nlsc.gov.tw/wmts/CWTS/default//GoogleMapsCompatible_Level{z}/{y}/{x}', {
                    attribution: 'åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ',
                    minZoom: 1,
                    maxZoom: 20
                })
            };

            L.control.layers(baseMaps).addTo(map);
        }

        // ==================== Three.js 3Då»ºç¯‰åˆå§‹åŒ– ====================
        let scene, camera, renderer, controls;
        let building, floorMeshes = {};
        let currentFloor = '6F';
        let autoRotate = false;

        function init3D() {
            const container = document.getElementById('canvas-container');

            // å ´æ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0e27);
            scene.fog = new THREE.Fog(0x0a0e27, 200, 500);

            // ç›¸æ©Ÿ
            camera = new THREE.PerspectiveCamera(
                65,
                container.clientWidth / container.clientHeight,
                0.1,
                2000
            );
            camera.position.set(50, 35, 50);
            camera.lookAt(0, 15, 0);

            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.outputEncoding = THREE.sRGBColorSpace;
            container.appendChild(renderer.domElement);

            // æ§åˆ¶
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxDistance = 200;
            controls.minDistance = 20;

            // å‰µå»ºå»ºç¯‰
            createBuilding();

            // å…‰æº
            createLights();

            // åœ°é¢
            createGround();

            // çª—å£èª¿æ•´
            window.addEventListener('resize', onWindowResize);

            // å‹•ç•«å¾ªç’°
            animate3D();
        }

        function createBuilding() {
            building = new THREE.Group();
            scene.add(building);

            const buildingWidth = 32;
            const buildingDepth = 20;

            // å‰µå»ºæ¯ä¸€å±¤
            const floorOrder = ['B1', '1F', '2F', '3F', '4F', '5F', '6F'];
            let currentHeight = 0;

            floorOrder.forEach((floorKey) => {
                const data = FLOOR_PLANS[floorKey];

                const geometry = new THREE.BoxGeometry(buildingWidth, data.height, buildingDepth);

                // å¤šæè³ªï¼ˆä¸åŒé¢ï¼‰
                let materials = [];
                for (let i = 0; i < 6; i++) {
                    const isGlass = ['3F', '4F', '5F', '6F'].includes(floorKey);
                    const isSemiGlass = floorKey === '3F';

                    let material;
                    if (isSemiGlass && (i === 1 || i === 4)) {
                        material = new THREE.MeshPhongMaterial({
                            color: 0xb0b0b0,
                            transparent: true,
                            opacity: 0.7,
                            emissive: 0x333333,
                            shininess: 100
                        });
                    } else if (isGlass && (i === 1 || i === 4)) {
                        material = new THREE.MeshPhongMaterial({
                            color: 0xffffff,
                            transparent: true,
                            opacity: 0.8,
                            emissive: 0x444444,
                            shininess: 80
                        });
                    } else {
                        material = new THREE.MeshPhongMaterial({
                            color: data.color,
                            emissive: 0x222222,
                            shininess: 40
                        });
                    }
                    materials.push(material);
                }

                const mesh = new THREE.Mesh(geometry, materials);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                mesh.position.y = currentHeight + data.height / 2;
                mesh.userData = { floor: floorKey, data: data };

                // é‚Šæ¡†
                const edges = new THREE.EdgesGeometry(geometry);
                const lineSegments = new THREE.LineSegments(
                    edges,
                    new THREE.LineBasicMaterial({ color: 0x444444, linewidth: 1 })
                );
                lineSegments.position.copy(mesh.position);
                building.add(lineSegments);

                building.add(mesh);
                floorMeshes[floorKey] = mesh;

                // æ·»åŠ çª—æˆ¶
                addWindowsToFloor(mesh, floorKey, buildingWidth, buildingDepth);

                currentHeight += data.height;
            });

            // å±‹é ‚
            createRoof(currentHeight, buildingWidth, buildingDepth);
        }

        function addWindowsToFloor(floorMesh, floorKey, width, depth) {
            if (['4F', '5F', '6F'].includes(floorKey)) {
                const windowSize = 2;
                const windowSpacing = 3;

                for (let x = -width / 2 + 2; x < width / 2 - 2; x += windowSpacing) {
                    for (let z = -depth / 2 + 2; z < depth / 2 - 2; z += windowSpacing) {
                        const windowGeometry = new THREE.PlaneGeometry(windowSize, windowSize);
                        const windowMaterial = new THREE.MeshPhongMaterial({
                            color: 0x87ceeb,
                            emissive: 0x1a5c7a,
                            shininess: 120,
                            side: THREE.DoubleSide
                        });

                        const windowMesh = new THREE.Mesh(windowGeometry, windowMaterial);
                        windowMesh.position.set(x, 0, z);
                        windowMesh.position.z -= depth / 2 + 0.1;
                        windowMesh.position.y += floorMesh.position.y - floorMesh.geometry.parameters.height / 2 + 0.5;
                        windowMesh.castShadow = true;
                        building.add(windowMesh);
                    }
                }
            }
        }

        function createRoof(yPos, width, depth) {
            // å¤ªé™½èƒ½é¢æ¿
            const panelCount = 16;
            for (let i = 0; i < panelCount; i++) {
                const panelGeometry = new THREE.BoxGeometry(width / 5, 0.15, depth / 4);
                const panelMaterial = new THREE.MeshPhongMaterial({
                    color: 0x1e90ff,
                    emissive: 0x0066cc,
                    shininess: 100
                });
                const panelMesh = new THREE.Mesh(panelGeometry, panelMaterial);
                panelMesh.position.set(
                    -12 + (i % 4) * 8,
                    yPos + 0.2,
                    -7 + Math.floor(i / 4) * 5
                );
                panelMesh.castShadow = true;
                panelMesh.receiveShadow = true;
                building.add(panelMesh);
            }

            // ç¶ å±‹é ‚
            const greenGeometry = new THREE.PlaneGeometry(width * 0.7, depth * 0.7);
            const greenMaterial = new THREE.MeshPhongMaterial({
                color: 0x2d8659,
                emissive: 0x1a4d31,
                shininess: 20
            });
            const greenRoof = new THREE.Mesh(greenGeometry, greenMaterial);
            greenRoof.rotation.x = -Math.PI / 2;
            greenRoof.position.set(0, yPos + 0.3, 0);
            greenRoof.receiveShadow = true;
            building.add(greenRoof);
        }

        function createLights() {
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(80, 60, 40);
            directionalLight.target.position.set(0, 10, 0);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.far = 500;
            directionalLight.shadow.camera.left = -150;
            directionalLight.shadow.camera.right = 150;
            directionalLight.shadow.camera.top = 150;
            directionalLight.shadow.camera.bottom = -150;
            scene.add(directionalLight);

            const hemisphereLight = new THREE.HemisphereLight(0x87ceeb, 0x2d5016, 0.4);
            scene.add(hemisphereLight);
        }

        function createGround() {
            const groundGeometry = new THREE.PlaneGeometry(300, 300);
            const groundMaterial = new THREE.MeshPhongMaterial({
                color: 0x2d5016,
                side: THREE.DoubleSide
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.5;
            ground.receiveShadow = true;
            scene.add(ground);
        }

        // ==================== æ¨“å±¤å¹³é¢åœ–ç”Ÿæˆå‡½æ•¸ ====================

        // å®šç¾©æ¨“å±¤çš„æˆ¿é–“ä½ç½®ï¼ˆç”¨æ–¼SVGç¹ªåœ–ï¼‰
        const FLOORPLAN_LAYOUTS = {
            'B1': [
                { name: 'åœè»Šå ´', x: 20, y: 30, w: 140, h: 100, color: '#555' },
                { name: 'ç©ºèª¿æ©Ÿæˆ¿', x: 20, y: 140, w: 30, h: 30, color: '#880088' },
                { name: 'é…é›»å®¤', x: 60, y: 140, w: 30, h: 30, color: '#0088ff' },
                { name: 'çµ¦æ’æ°´', x: 100, y: 140, w: 25, h: 30, color: '#0088ff' },
                { name: 'é›¨æ°´å›æ”¶', x: 135, y: 140, w: 25, h: 30, color: '#00ccff' }
            ],
            '1F': [
                { name: 'å¤±æ™ºç—‡å°ˆå€', x: 15, y: 20, w: 80, h: 100, color: '#ff6600' },
                { name: 'AIæŠ•å½±', x: 105, y: 20, w: 55, h: 50, color: '#ff8800' },
                { name: 'å¾©å¥è¨“ç·´', x: 105, y: 75, w: 55, h: 45, color: '#ffaa00' },
                { name: 'è—è¡“ç™‚æ³•', x: 15, y: 125, w: 40, h: 40, color: '#ff00ff' },
                { name: 'èªçŸ¥è¨“ç·´', x: 60, y: 125, w: 30, h: 40, color: '#ff0088' },
                { name: 'å…±ç”¨é¤å»³', x: 95, y: 125, w: 50, h: 40, color: '#8800ff' },
                { name: 'å‚™é¤å»šæˆ¿', x: 150, y: 125, w: 20, h: 40, color: '#ffff00' }
            ],
            '2F': [
                { name: 'SIDSç›£æ¸¬', x: 20, y: 25, w: 75, h: 70, color: '#00ff00' },
                { name: 'å¬°å…’åºŠå€', x: 20, y: 100, w: 75, h: 70, color: '#00ff88' },
                { name: 'ä¸­å¤®ç›£æ§', x: 105, y: 25, w: 35, h: 35, color: '#0088ff' },
                { name: 'å¬°å¹¼æ´»å‹•å€', x: 105, y: 65, w: 65, h: 50, color: '#00ffff' },
                { name: 'AIæ•…äº‹', x: 105, y: 120, w: 35, h: 25, color: '#88ffff' },
                { name: 'é¤µé£Ÿæ›å°¿', x: 145, y: 65, w: 40, h: 50, color: '#ffcc00' },
                { name: 'è¡›æµ´è¨­æ–½', x: 145, y: 120, w: 40, h: 25, color: '#ccaa00' }
            ],
            '3F': [
                { name: 'é–±è®€å€', x: 15, y: 20, w: 45, h: 50, color: '#ff0088' },
                { name: 'æ•…äº‹åŠ‡å ´', x: 65, y: 20, w: 75, h: 60, color: '#8800ff' },
                { name: 'ä¸»é¡Œå­¸ç¿’', x: 15, y: 75, w: 125, h: 55, color: '#00ff00' },
                { name: 'æ™‚é–“éŠ€è¡Œ', x: 150, y: 20, w: 50, h: 40, color: '#ffff00' },
                { name: 'å°å¸«åº§ä½', x: 150, y: 65, w: 50, h: 35, color: '#ffaa00' },
                { name: 'è¡¨æšå±•ç¤º', x: 150, y: 105, w: 50, h: 25, color: '#00ccff' },
                { name: 'MRå€', x: 65, y: 85, w: 30, h: 45, color: '#ff00ff' }
            ],
            '4F': [
                { name: 'STEMæ•™å®¤', x: 15, y: 20, w: 60, h: 55, color: '#ff0000' },
                { name: 'æ©Ÿå™¨äººå€', x: 80, y: 20, w: 50, h: 55, color: '#ff4400' },
                { name: 'é›»å­å·¥ä½œå°', x: 135, y: 20, w: 35, h: 55, color: '#ff8800' },
                { name: 'VRç¡¬é«”', x: 15, y: 80, w: 35, h: 40, color: '#00ff00' },
                { name: 'VRæ²‰æµ¸æ•™å®¤', x: 55, y: 80, w: 80, h: 40, color: '#00ff88' },
                { name: 'è™›æ“¬å¯¦é©—å®¤', x: 140, y: 80, w: 30, h: 40, color: '#00ffff' },
                { name: 'é è·å°å¸«', x: 15, y: 125, w: 35, h: 25, color: '#0088ff' },
                { name: 'è·æ¶¯å°å¸«', x: 55, y: 125, w: 50, h: 25, color: '#0044ff' }
            ],
            '5F': [
                { name: 'å¤ªé™½èƒ½é¢æ¿', x: 15, y: 15, w: 160, h: 30, color: '#1e90ff' },
                { name: 'å„²èƒ½é›»æ± ', x: 15, y: 50, w: 35, h: 25, color: '#ffaa00' },
                { name: 'ç¶ å±‹é ‚', x: 55, y: 50, w: 120, h: 80, color: '#228b22' },
                { name: 'åŸ¹è¨“æ•™å®¤', x: 15, y: 130, w: 40, h: 25, color: '#ff00ff' },
                { name: 'æœƒè­°å®¤', x: 60, y: 130, w: 30, h: 25, color: '#00ffff' },
                { name: 'å¯¦é©—å®¤', x: 95, y: 130, w: 35, h: 25, color: '#00ff00' },
                { name: 'è¾¦å…¬å€', x: 135, y: 130, w: 40, h: 25, color: '#ffff00' }
            ],
            '6F': [
                { name: 'æœƒè­°å»³', x: 15, y: 20, w: 175, h: 70, color: '#ff00ff' },
                { name: 'å‚™é¤å€', x: 15, y: 95, w: 30, h: 20, color: '#ffaa00' },
                { name: 'è¡›æµ´è¨­æ–½', x: 50, y: 95, w: 30, h: 20, color: '#0088ff' },
                { name: 'èˆå°', x: 85, y: 95, w: 50, h: 20, color: '#ff0000' },
                { name: 'å±‹é ‚éœ²è‡º', x: 140, y: 95, w: 50, h: 30, color: '#00ff88' },
                { name: 'å„²å‚™å€', x: 195, y: 95, w: 20, h: 30, color: '#888888' }
            ]
        };

        function renderFloorplan(floorKey) {
            const svg = document.getElementById('floorplan-canvas');
            svg.innerHTML = '';
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '100%');
            svg.setAttribute('viewBox', '0 0 220 160');

            const layout = FLOORPLAN_LAYOUTS[floorKey];
            if (!layout) return;

            // ç¹ªè£½èƒŒæ™¯
            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('width', '220');
            bg.setAttribute('height', '160');
            bg.setAttribute('fill', '#1a1a2e');
            bg.setAttribute('stroke', '#00ff88');
            bg.setAttribute('stroke-width', '1');
            svg.appendChild(bg);

            // ç¹ªè£½æ¯å€‹æˆ¿é–“
            layout.forEach(room => {
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', room.x);
                rect.setAttribute('y', room.y);
                rect.setAttribute('width', room.w);
                rect.setAttribute('height', room.h);
                rect.setAttribute('fill', room.color);
                rect.setAttribute('fill-opacity', '0.3');
                rect.setAttribute('stroke', room.color);
                rect.setAttribute('stroke-width', '1.5');
                rect.setAttribute('class', 'floorplan-room');
                rect.setAttribute('title', room.name);

                // æ·»åŠ æˆ¿é–“åç¨±æ¨™ç±¤
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', room.x + room.w / 2);
                text.setAttribute('y', room.y + room.h / 2 + 2);
                text.setAttribute('class', 'floorplan-text');
                text.setAttribute('fill', room.color);
                text.textContent = room.name.substring(0, 8);

                svg.appendChild(rect);
                svg.appendChild(text);
            });
        }

        // ==================== äº¤äº’å‡½æ•¸ ====================
        function selectFloor(floorKey) {
            // æ›´æ–°UIæŒ‰éˆ•
            document.querySelectorAll('.floor-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // æ›´æ–°æ¨“å±¤ä¿¡æ¯
            updateFloorInfo(floorKey);

            // é¡¯ç¤ºæ¨“å±¤å¹³é¢åœ–
            renderFloorplan(floorKey);
            const container = document.getElementById('floorplan-container');
            container.classList.add('active');

            // é«˜äº®æ¨“å±¤ï¼ˆ3Dè¦–è§’ï¼‰
            Object.keys(floorMeshes).forEach(key => {
                const mesh = floorMeshes[key];
                if (key === floorKey) {
                    mesh.material.forEach(mat => {
                        mat.emissive.setHex(0xff00ff);
                        mat.emissiveIntensity = 0.6;
                    });
                } else {
                    mesh.material.forEach(mat => {
                        mat.emissive.setHex(0x222222);
                        mat.emissiveIntensity = 0.1;
                    });
                }
            });

            currentFloor = floorKey;

            // æ›´æ–°åœ°åœ–æ¨™è¨˜å½ˆçª—
            if (buildingMarker) {
                buildingMarker.setPopupContent(`
                    <div style="color: #000; font-size: 11px; font-weight: bold;">
                        <strong>èµ¤åœŸå´å¤šåŠŸèƒ½é¤¨</strong><br>
                        <span style="color: #ff00ff; font-weight: bold;">ç•¶å‰é¸æ“‡: ${FLOOR_PLANS[floorKey].name}</span><br>
                        <br>
                        24.8247Â°N, 120.9456Â°E<br>
                        åŸºåœ°é¢ç©: 8,000 mÂ²<br>
                        å»ºç¯‰é¢ç©: 3,833 mÂ²
                    </div>
                `);
            }
        }

        function updateFloorInfo(floorKey) {
            const data = FLOOR_PLANS[floorKey];
            const html = `
                <h2>${data.name}</h2>
                <p style="color: #888; margin: 8px 0; font-size: 11px;">${data.description}</p>
                <h3>ğŸ›ï¸ ç©ºé–“åŠŸèƒ½</h3>
                ${data.rooms.map(room => `
                    <div class="floor-detail">
                        <div class="floor-detail-title">${room.name}</div>
                        <div class="floor-detail-desc">
                            <strong>é¢ç©:</strong> ${room.area}<br>
                            <strong>è¨­å‚™:</strong> ${room.equipment}
                        </div>
                    </div>
                `).join('')}
            `;
            document.getElementById('floor-details').innerHTML = html;
            document.getElementById('current-floor-info').textContent = data.name;
        }

        function setViewMode(mode) {
            document.querySelectorAll('.btn-3d').forEach(btn => {
                if (btn.textContent === 'æ­£å¸¸' || btn.textContent === 'ç·šæ¡†' || btn.textContent === 'å…§éƒ¨') {
                    btn.classList.remove('active');
                }
            });
            event.target.classList.add('active');

            if (mode === 'wireframe') {
                Object.values(floorMeshes).forEach(mesh => {
                    mesh.material.forEach(mat => mat.wireframe = true);
                });
            } else if (mode === 'normal') {
                Object.values(floorMeshes).forEach(mesh => {
                    mesh.material.forEach(mat => mat.wireframe = false);
                });
            }
        }

        function toggleAutoRotate() {
            autoRotate = !autoRotate;
            event.target.classList.toggle('active');
        }

        // ==================== å‹•ç•«å¾ªç’° ====================
        let frameCount = 0, lastTime = Date.now(), fps = 0;

        function animate3D() {
            requestAnimationFrame(animate3D);

            // FPSè¨ˆç®—
            frameCount++;
            const now = Date.now();
            if (now >= lastTime + 1000) {
                fps = frameCount;
                document.getElementById('fps').textContent = fps;
                document.getElementById('obj-count').textContent = scene.children.length;
                frameCount = 0;
                lastTime = now;
            }

            // è‡ªå‹•æ—‹è½‰
            if (autoRotate && !controls.isDragging) {
                building.rotation.y += 0.0005;
            }

            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // ==================== åˆå§‹åŒ– ====================
        window.addEventListener('load', () => {
            initMap();
            init3D();
            updateFloorInfo('6F');
            // åˆå§‹åŒ–æ¨“å±¤å¹³é¢åœ–
            renderFloorplan('6F');
            document.getElementById('floorplan-container').classList.add('active');
        });
    </script>
</body>
</html>
