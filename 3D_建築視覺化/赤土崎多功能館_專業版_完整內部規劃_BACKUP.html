<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ¤åœŸå´å¤šåŠŸèƒ½é¤¨ - 3Då®¤å…§å°è¦½ç³»çµ± (å°ˆæ¥­ç‰ˆ)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', 'Segoe UI', -apple-system, sans-serif;
            background: #0a0e27;
            overflow: hidden;
            color: #ffffff;
        }

        /* ============== ä¸»å®¹å™¨ ============== */
        #app {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 60px 1fr;
        }

        /* ============== é ‚éƒ¨å°èˆªæ¬„ ============== */
        #topbar {
            background: rgba(10, 14, 39, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .app-title {
            font-size: 16px;
            font-weight: 600;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            letter-spacing: 1px;
        }

        .mode-switcher {
            display: flex;
            gap: 8px;
            background: rgba(0, 255, 136, 0.1);
            padding: 4px;
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .mode-btn {
            padding: 6px 14px;
            border: none;
            background: transparent;
            color: #888;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .mode-btn:hover {
            color: #00ff88;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stats {
            display: flex;
            gap: 20px;
            font-size: 11px;
            color: #888;
            font-family: 'Courier New', monospace;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .stat-label {
            color: #666;
            font-size: 10px;
        }

        .stat-value {
            color: #00ff88;
            font-weight: 600;
        }

        /* ============== ä¸»å…§å®¹å€ ============== */
        #main-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 1px;
            background: #0a0e27;
        }

        /* ============== å·¦å´é¢æ¿ ============== */
        #left-panel {
            background: rgba(10, 14, 39, 0.9);
            border-right: 1px solid rgba(0, 255, 136, 0.2);
            overflow-y: auto;
            padding: 20px;
        }

        .panel-title {
            font-size: 13px;
            font-weight: 600;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }

        .floor-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 30px;
        }

        .floor-btn {
            padding: 10px 12px;
            background: rgba(0, 204, 255, 0.1);
            border: 1px solid rgba(0, 204, 255, 0.3);
            color: #00ccff;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: left;
        }

        .floor-btn:hover {
            background: rgba(0, 204, 255, 0.2);
            border-color: rgba(0, 204, 255, 0.6);
        }

        .floor-btn.active {
            background: #00ccff;
            color: #000;
            box-shadow: 0 0 15px rgba(0, 204, 255, 0.5);
        }

        .rooms-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .room-item {
            padding: 8px 10px;
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.1);
            border-radius: 3px;
            margin-bottom: 6px;
            cursor: pointer;
            font-size: 11px;
            color: #aaa;
            transition: all 0.3s ease;
        }

        .room-item:hover {
            background: rgba(0, 255, 136, 0.15);
            color: #00ff88;
            border-color: rgba(0, 255, 136, 0.3);
        }

        .room-name {
            font-weight: 500;
            color: #00ff88;
            margin-bottom: 2px;
        }

        .room-area {
            font-size: 10px;
            color: #666;
        }

        /* ============== ä¸­å¤® 3D Canvas ============== */
        #canvas-container {
            position: relative;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a3e 100%);
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ============== å³å´é¢æ¿ ============== */
        #right-panel {
            background: rgba(10, 14, 39, 0.9);
            border-left: 1px solid rgba(255, 0, 255, 0.2);
            overflow-y: auto;
            padding: 20px;
        }

        .info-card {
            background: rgba(255, 0, 255, 0.05);
            border: 1px solid rgba(255, 0, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: #ff00ff;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
        }

        .card-content {
            font-size: 12px;
            color: #ccc;
            line-height: 1.6;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 0, 255, 0.1);
        }

        .info-label {
            color: #888;
            font-weight: 500;
        }

        .info-value {
            color: #00ff88;
            font-weight: 600;
        }

        /* ============== æ‡¸æµ®æ§åˆ¶é¢æ¿ ============== */
        .floating-panel {
            position: absolute;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 170, 0, 0.3);
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 11px;
            color: #ffaa00;
            z-index: 500;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.2);
        }

        #control-panel {
            bottom: 20px;
            right: 20px;
        }

        .control-title {
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 10px;
            letter-spacing: 1px;
            font-size: 10px;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .ctrl-btn {
            padding: 6px 10px;
            background: rgba(255, 170, 0, 0.15);
            border: 1px solid rgba(255, 170, 0, 0.3);
            color: #ffaa00;
            cursor: pointer;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .ctrl-btn:hover {
            background: rgba(255, 170, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 170, 0, 0.3);
        }

        /* ============== å°åœ°åœ– ============== */
        #minimap {
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 200px;
        }

        #minimap-canvas {
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            border-radius: 6px;
            border: 1px solid rgba(0, 204, 255, 0.3);
        }

        /* ============== æç¤ºç³»çµ± ============== */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 4px;
            padding: 8px 10px;
            font-size: 11px;
            color: #00ff88;
            pointer-events: none;
            z-index: 400;
            white-space: nowrap;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        /* ============== æ»¾å‹•æ¢ç¾åŒ– ============== */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.3);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 136, 0.5);
        }

        /* ============== åŠ è¼‰å‹•ç•« ============== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        /* ============== éŸ¿æ‡‰å¼è¨­è¨ˆ ============== */
        @media (max-width: 1400px) {
            #main-container {
                grid-template-columns: 1fr 300px;
            }
            #left-panel {
                display: none;
            }
        }

        @media (max-width: 1000px) {
            #main-container {
                grid-template-columns: 1fr;
            }
            #right-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- é ‚éƒ¨å°èˆªæ¬„ -->
        <div id="topbar">
            <div class="topbar-left">
                <div class="app-title">ğŸ¢ èµ¤åœŸå´å¤šåŠŸèƒ½é¤¨ 3D å°è¦½ç³»çµ±</div>
                <div class="mode-switcher">
                    <button class="mode-btn active" onclick="switchMode('exterior')">å¤–éƒ¨è¦–è§’</button>
                    <button class="mode-btn" onclick="switchMode('interior')">å…§éƒ¨å°è¦½</button>
                    <button class="mode-btn" onclick="switchMode('fps')">ç¬¬ä¸€äººç¨±</button>
                </div>
            </div>
            <div class="topbar-right">
                <div class="stats">
                    <div class="stat-item">
                        <span class="stat-label">FPS</span>
                        <span class="stat-value" id="fps-display">60</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Objects</span>
                        <span class="stat-value" id="obj-display">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Memory</span>
                        <span class="stat-value" id="mem-display">0MB</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»å®¹å™¨ -->
        <div id="main-container">
            <!-- å·¦å´é¢æ¿ -->
            <div id="left-panel">
                <div class="panel-title">æ¨“å±¤å°èˆª</div>
                <div class="floor-list">
                    <button class="floor-btn" onclick="selectFloor('B1')">B1 åœè»Šå ´+æ©Ÿæˆ¿</button>
                    <button class="floor-btn active" onclick="selectFloor('1F')">1F é•·ç…§+AIè¨˜æ†¶</button>
                    <button class="floor-btn" onclick="selectFloor('2F')">2F æ‰˜å¬°+SIDSç›£æ¸¬</button>
                    <button class="floor-btn" onclick="selectFloor('3F')">3F è¦ªå­å…±å­¸</button>
                    <button class="floor-btn" onclick="selectFloor('4F')">4F STEMæ•™å®¤</button>
                </div>

                <div class="panel-title">æˆ¿é–“åˆ—è¡¨</div>
                <div class="rooms-list" id="rooms-list"></div>
            </div>

            <!-- ä¸­å¤® 3D Canvas -->
            <div id="canvas-container"></div>

            <!-- å³å´é¢æ¿ -->
            <div id="right-panel">
                <div id="info-panel"></div>
            </div>
        </div>

        <!-- å°åœ°åœ– -->
        <div class="floating-panel" id="minimap">
            <div class="control-title">æ¨“å±¤å¹³é¢åœ–</div>
            <canvas id="minimap-canvas"></canvas>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="floating-panel" id="control-panel">
            <div class="control-title">âš™ï¸ æ§åˆ¶</div>
            <div class="control-buttons">
                <button class="ctrl-btn" onclick="toggleWireframe()">ç·šæ¡†</button>
                <button class="ctrl-btn" onclick="toggleAutoRotate()">è‡ªå‹•æ—‹è½‰</button>
                <button class="ctrl-btn" onclick="resetView()">é‡ç½®è¦–è§’</button>
                <button class="ctrl-btn" onclick="toggleHelp()">å¹«åŠ©</button>
            </div>
        </div>
    </div>

    <!-- Three.js ES Modules from Local Server (No CDN) -->
    <script type="importmap">
    {
        "imports": {
            "three": "/libs/three/three.module.js",
            "three/addons/controls/OrbitControls.js": "/libs/three/OrbitControls.js",
            "three/addons/controls/PointerLockControls.js": "/libs/three/PointerLockControls.js"
        }
    }
    </script>
    <script type="module">
        // Import Three.js and controls
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // Make them globally accessible for non-module scripts
        window.THREE = THREE;
        window.OrbitControls = OrbitControls;
        window.PointerLockControls = PointerLockControls;
    </script>
    <script>
        // ==================== å…¨å±€é…ç½® ====================
        const BUILDING_CONFIG = {
            width: 32,
            depth: 20,
            floors: ['B1', '1F', '2F', '3F', '4F'],  // Stage3åˆè¦ï¼šåªæœ‰5å±¤
            floorHeights: [5, 4, 3.5, 3.5, 3.5]
        };

        // FPS æ§åˆ¶ç›¸é—œè®Šæ•¸
        let fpsCamera, orbitCamera;
        let fpsControls, pointerLockControls;
        let isPointerLocked = false;
        let currentMode = 'exterior';
        let moveVector = { forward: false, backward: false, left: false, right: false };
        let currentFloor = '1F';
        const FPS_SPEED = 0.15;
        const FPS_HEIGHT = 1.6; // äººçœ¼é«˜åº¦

        // Minecraft é¢¨æ ¼çš„ç›¸æ©Ÿæ§åˆ¶
        const minecraftControls = {
            pitch: 0,           // ä¸Šä¸‹çœ‹ï¼ˆ-Ï€/2 åˆ° Ï€/2ï¼‰
            yaw: 0,             // å·¦å³çœ‹
            mouseSensitivity: 0.003,  // é¼ æ¨™éˆæ•åº¦
            isDragging: false,
            lastX: 0,
            lastY: 0
        };
        window.minecraftControls = minecraftControls;  // æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ

        // ==================== æˆ¿é–“æ•¸æ“š (Stage3åˆè¦ï¼š5å±¤, 16å€‹åŠŸèƒ½å€) ====================
        const ROOM_DATA = {
            'B1': [
                { id: 'B1-01', name: 'åœè»Šå ´', x: 0, z: 0, w: 28, d: 16, area: 448, type: 'facility', equipment: ['åœè»Šä½Ã—60', 'æ„Ÿæ¸¬ç³»çµ±'] },
                { id: 'B1-02', name: 'ç©ºèª¿æ©Ÿæˆ¿', x: 12, z: -8, w: 4, d: 3, area: 12, type: 'technical', equipment: ['å†·æš–ä¸»æ©ŸÃ—2'] },
                { id: 'B1-03', name: 'é…é›»å®¤', x: 12, z: -5, w: 3, d: 3, area: 9, type: 'technical', equipment: ['ä¸»é…ç›¤', 'UPSç³»çµ±'] },
                { id: 'B1-04', name: 'çµ¦æ’æ°´', x: 10, z: -8, w: 2, d: 2, area: 4, type: 'technical', equipment: ['æ°´å¡”Ã—1'] },
                { id: 'B1-05', name: 'é›¨æ°´å›æ”¶', x: 8, z: -8, w: 2, d: 2, area: 4, type: 'technical', equipment: ['å„²å­˜æ± '] }
            ],
            '1F': [
                // Stage3è¦ç¯„ï¼š1F = å¤±æ™ºå°ˆå€(200mÂ²) + ä¸€èˆ¬æ—¥ç…§å€(300mÂ²) + å…±äº«ç©ºé–“(220mÂ²)
                { id: '1F-01', name: 'å¤±æ™ºç—‡å°ˆå€', x: -10, z: 0, w: 14, d: 14.3, area: 200, type: 'healthcare', equipment: ['æ„Ÿæ¸¬è¨­å‚™', 'äº’å‹•æŠ•å½±', 'æ´»å‹•å®¤', 'ç„¡éšœç¤™è¡›æµ´'], subzones: ['æ„Ÿæ¸¬å€', 'æŠ•å½±å€', 'æ´»å‹•å®¤', 'è¡›æµ´'] },
                { id: '1F-02', name: 'ä¸€èˆ¬æ—¥ç…§å€', x: 6, z: 0, w: 18, d: 16.7, area: 300, type: 'healthcare', equipment: ['å¾©å¥å™¨æ', 'è—è¡“ç¾è¡“', 'èªçŸ¥è¨“ç·´'], subzones: ['å¾©å¥è¨“ç·´', 'è—è¡“ç™‚æ³•', 'èªçŸ¥è¨“ç·´'] },
                { id: '1F-03', name: 'å…±äº«ç©ºé–“', x: 0, z: 9, w: 20, d: 11, area: 220, type: 'dining', equipment: ['é¤å»³Ã—120äºº', 'å»šæˆ¿è¨­å‚™', 'è­·ç†ç«™ç›£æ§'], subzones: ['ç”¨é¤å€', 'å»šæˆ¿', 'è­·ç†ç«™'] }
            ],
            '2F': [
                // Stage3è¦ç¯„ï¼š2F = å¬°å…’å®¤(200mÂ²) + å¹¼å…’å®¤(150mÂ²) + æ”¯æ´è¨­æ–½
                { id: '2F-01', name: 'å¬°å…’å®¤', x: -9, z: 0, w: 14, d: 14.3, area: 200, type: 'healthcare', equipment: ['SIDSç›£æ¸¬Ã—50', 'å¬°å…’åºŠÃ—50', 'æ´»å‹•å€', 'é¤µé£Ÿå€', 'è¡›æµ´'], subzones: ['ç¡çœ å€', 'æ´»å‹•å€', 'é¤µé£Ÿå€', 'è¡›æµ´'] },
                { id: '2F-02', name: 'å¹¼å…’å®¤', x: 7, z: 0, w: 16, d: 9.4, area: 150, type: 'activity', equipment: ['æ”€çˆ¬æ¶', 'æ»‘æ¢¯', 'çƒæ± ', 'æ•…äº‹æŠ•å½±', 'åˆç¡åºŠÃ—15'], subzones: ['éŠæˆ²å€', 'æ•…äº‹æ™‚é–“', 'ä¸»é¡Œæ´»å‹•', 'åˆç¡å€'] },
                { id: '2F-03', name: 'æ”¯æ´è¨­æ–½', x: 0, z: -9, w: 20, d: 8.7, area: 174, type: 'facility', equipment: ['ç›£æ§ç³»çµ±', 'æ¶ˆæ¯’å®¤', 'å„²è—'], subzones: ['ä¸­å¤®ç›£æ§', 'æ¶ˆæ¯’å€', 'å„²è—'] }
            ],
            '3F': [
                // Stage3è¦ç¯„ï¼š3F = è¦ªå­å…±å­¸å€(150mÂ²) + æ™‚é–“éŠ€è¡Œè¾¦å…¬ + æ”¯æ´å€
                { id: '3F-01', name: 'è¦ªå­å…±å­¸å€', x: -8, z: 2, w: 16, d: 9.4, area: 150, type: 'education', equipment: ['æ›¸æ¶Ã—3', 'èˆå°', 'æŠ•å½±å¹•', 'å­¸ç¿’æ•™æ'], subzones: ['é–±è®€å€', 'æ•…äº‹åŠ‡å ´', 'STEAMå­¸ç¿’'] },
                { id: '3F-02', name: 'æ™‚é–“éŠ€è¡Œè¾¦å…¬', x: -12, z: -8, w: 6, d: 6, area: 36, type: 'administrative', equipment: ['è¾¦å…¬æ¡ŒÃ—3'], subzones: ['ç®¡ç†å€'] },
                { id: '3F-03', name: 'å°å¸«èˆ‡å±•ç¤ºå€', x: 0, z: -8, w: 16, d: 8, area: 128, type: 'education', equipment: ['å°å¸«åº§ä½', 'å±•ç¤ºç‰†', 'VRé«”é©—'], subzones: ['å°å¸«åº§ä½', 'å±•ç¤ºå€', 'VRé«”é©—'] }
            ],
            '4F': [
                // Stage3è¦ç¯„ï¼š4F = STEMæ•™å®¤(200mÂ²) + æŠ•å½±èˆ‡å±•ç¤ºå€(150mÂ²) + è·æ¶¯ç™¼å±•å€(150mÂ²)
                { id: '4F-01', name: 'STEMæ•™å®¤', x: -10, z: 2, w: 16, d: 12.5, area: 200, type: 'education', equipment: ['é›»è…¦Ã—15', 'ArduinoÃ—10', 'Raspberry PiÃ—10', '3Dåˆ—å°æ©Ÿ'], subzones: ['é›»è…¦æ•™å®¤', 'æ©Ÿå™¨äººå€', 'é›»å­å·¥ä½œå°'] },
                { id: '4F-02', name: 'æŠ•å½±èˆ‡å±•ç¤ºå€', x: 8, z: 2, w: 16, d: 9.4, area: 150, type: 'technology', equipment: ['æŠ•å½±æ©ŸÃ—8', 'VRé ­ç›”Ã—3-10', 'ç·¨è¼¯å·¥ä½œå®¤'], subzones: ['4KæŠ•å½±å€', 'VRç¡¬é«”', 'éŒ„è£½ç·¨è¼¯'] },
                { id: '4F-03', name: 'è·æ¶¯ç™¼å±•å€', x: 0, z: -9, w: 20, d: 7.5, area: 150, type: 'education', equipment: ['å°å¸«åº§ä½Ã—3', 'è¦–è¨Šæœƒè­°ç³»çµ±', 'å±¥æ­·æª”æ¡ˆå€'], subzones: ['å°å¸«åº§ä½', 'é è·é€£ç·š', 'æª”æ¡ˆå€'] }
            ]
        };

        // ==================== Three.js å ´æ™¯ ====================
        let scene, renderer;
        let building;
        let frameCount = 0, lastTime = Date.now(), fps = 0;
        let raycaster, velocity;

        // ç¢ºä¿ Three.js å·²åŠ è¼‰
        function checkThreeJS() {
            if (typeof THREE === 'undefined') {
                console.error('âŒ Three.js å°šæœªåŠ è¼‰');
                setTimeout(checkThreeJS, 100);
                return false;
            }
            console.log('âœ… Three.js å·²åŠ è¼‰');
            raycaster = new THREE.Raycaster();
            velocity = new THREE.Vector3();
            return true;
        }

        function initThreeJS() {
            const container = document.getElementById('canvas-container');

            // å ´æ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0e27);
            scene.fog = new THREE.Fog(0x0a0e27, 100, 500);

            // å¤–éƒ¨è¦–è§’ç›¸æ©Ÿï¼ˆè»Œé“æ§åˆ¶ï¼‰
            orbitCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            orbitCamera.position.set(80, 60, 80);

            // ç¬¬ä¸€äººç¨±è¦–è§’ç›¸æ©Ÿï¼ˆFPSï¼‰- èª¿æ•´è¿‘/é å¹³é¢ä»¥é˜²æ­¢ç¢°æ’æ™‚è£å‰ª
            fpsCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.05, 1000);
            fpsCamera.position.set(0, FPS_HEIGHT, 0);

            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // è»Œé“æ§åˆ¶å™¨ï¼ˆå¤–éƒ¨è¦–è§’ï¼‰
            orbitControls = new window.OrbitControls(orbitCamera, renderer.domElement);
            orbitControls.enableDamping = true;
            orbitControls.dampingFactor = 0.05;
            orbitControls.autoRotate = true;
            orbitControls.autoRotateSpeed = 2;

            // FPS æ§åˆ¶å™¨ï¼ˆç¬¬ä¸€äººç¨±ï¼‰
            pointerLockControls = new window.PointerLockControls(fpsCamera, renderer.domElement);
            scene.add(pointerLockControls.getObject());

            // å…‰ç…§
            setupLighting();

            // å»ºç¯‰
            building = createBuilding();
            scene.add(building);

            // åœ°é¢
            const groundGeometry = new THREE.PlaneGeometry(200, 200);
            const groundMaterial = new THREE.MeshPhongMaterial({ color: 0x1a3a2a, side: THREE.DoubleSide });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.5;
            ground.receiveShadow = true;
            scene.add(ground);

            // éµç›¤äº‹ä»¶ç›£è½
            window.addEventListener('keydown', onKeyDown);
            window.addEventListener('keyup', onKeyUp);

            // Minecraft é¢¨æ ¼çš„é¼ æ¨™ç§»å‹•ç›£è½ï¼ˆç”¨æ–¼ç›¸æ©Ÿæ—‹è½‰ï¼‰
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('mousedown', () => {
                minecraftControls.isDragging = true;
                renderer.domElement.style.cursor = 'grabbing';
            });
            renderer.domElement.addEventListener('mouseup', () => {
                minecraftControls.isDragging = false;
                renderer.domElement.style.cursor = 'default';
            });

            // Pointer Lock äº‹ä»¶ï¼ˆå‚™ç”¨ï¼‰
            renderer.domElement.addEventListener('click', () => {
                if (currentMode === 'fps') {
                    pointerLockControls.lock();
                }
            });

            // èª¿æ•´çª—å£å¤§å°
            window.addEventListener('resize', onWindowResize);

            // å‹•ç•«å¾ªç’°
            animate();
        }

        function setupLighting() {
            // ç’°å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            // å¤ªé™½å…‰
            const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
            sunLight.position.set(100, 100, 50);
            sunLight.castShadow = true;
            sunLight.shadow.camera.left = -100;
            sunLight.shadow.camera.right = 100;
            sunLight.shadow.camera.top = 100;
            sunLight.shadow.camera.bottom = -100;
            sunLight.shadow.mapSize.width = 1024;
            sunLight.shadow.mapSize.height = 1024;
            scene.add(sunLight);

            // åŠçƒå…‰
            const hemiLight = new THREE.HemisphereLight(0x87ceeb, 0x2d5016, 0.3);
            scene.add(hemiLight);
        }

        function createBuilding() {
            const group = new THREE.Group();

            let yOffset = 0;
            const colors = [0x7a7a7a, 0x9a9a9a, 0x9a9a9a, 0xb0b0b0, 0xf5f5f5, 0xf5f5f5, 0xf0f0f0];

            // è¼”åŠ©å‡½æ•¸ï¼šæª¢æŸ¥ç›¸é„°æˆ¿é–“
            function isRoomAdjacent(rooms, currentRoom, direction) {
                const tolerance = 0.5;
                return rooms.some(other => {
                    if (other.id === currentRoom.id) return false;

                    switch(direction) {
                        case 'north': // æª¢æŸ¥å¾Œé¢æ˜¯å¦æœ‰æˆ¿é–“
                            return Math.abs(other.z - (currentRoom.z - currentRoom.d/2 - other.d/2)) < tolerance &&
                                   Math.abs(other.x - currentRoom.x) < tolerance + Math.max(other.w, currentRoom.w)/2;
                        case 'south': // æª¢æŸ¥å‰é¢
                            return Math.abs(other.z - (currentRoom.z + currentRoom.d/2 + other.d/2)) < tolerance &&
                                   Math.abs(other.x - currentRoom.x) < tolerance + Math.max(other.w, currentRoom.w)/2;
                        case 'east': // æª¢æŸ¥å³é‚Š
                            return Math.abs(other.x - (currentRoom.x + currentRoom.w/2 + other.w/2)) < tolerance &&
                                   Math.abs(other.z - currentRoom.z) < tolerance + Math.max(other.d, currentRoom.d)/2;
                        case 'west': // æª¢æŸ¥å·¦é‚Š
                            return Math.abs(other.x - (currentRoom.x - currentRoom.w/2 - other.w/2)) < tolerance &&
                                   Math.abs(other.z - currentRoom.z) < tolerance + Math.max(other.d, currentRoom.d)/2;
                    }
                    return false;
                });
            }

            BUILDING_CONFIG.floors.forEach((floorKey, index) => {
                const height = BUILDING_CONFIG.floorHeights[index];
                const material = new THREE.MeshStandardMaterial({
                    color: colors[index],
                    metalness: 0.2,
                    roughness: 0.8
                });

                // å››é¢ç‰†
                const walls = [
                    { pos: [0, yOffset + height/2, BUILDING_CONFIG.depth/2], size: [BUILDING_CONFIG.width, height, 0.3] },
                    { pos: [0, yOffset + height/2, -BUILDING_CONFIG.depth/2], size: [BUILDING_CONFIG.width, height, 0.3] },
                    { pos: [-BUILDING_CONFIG.width/2, yOffset + height/2, 0], size: [BUILDING_CONFIG.depth, height, 0.3] },
                    { pos: [BUILDING_CONFIG.width/2, yOffset + height/2, 0], size: [BUILDING_CONFIG.depth, height, 0.3] }
                ];

                walls.forEach(wall => {
                    const geometry = new THREE.BoxGeometry(...wall.size);
                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(...wall.pos);
                    mesh.castShadow = true;
                    mesh.receiveShadow = true;
                    mesh.userData = { floor: floorKey };
                    group.add(mesh);
                });

                // åœ°æ¿
                const floorGeometry = new THREE.PlaneGeometry(BUILDING_CONFIG.width, BUILDING_CONFIG.depth);
                const floorMesh = new THREE.Mesh(floorGeometry, material);
                floorMesh.rotation.x = -Math.PI / 2;
                floorMesh.position.y = yOffset;
                floorMesh.receiveShadow = true;
                group.add(floorMesh);

                // æˆ¿é–“æ¨™è¨˜
                const rooms = ROOM_DATA[floorKey] || [];
                rooms.forEach(room => {
                    const roomGeometry = new THREE.BoxGeometry(room.w, height * 0.8, room.d);

                    // æ ¹æ“šæˆ¿é–“é¡å‹è¨­ç½®é¡è‰²
                    let roomColor = 0x3a3a4a;
                    let opacity = 0.2;
                    switch (room.type) {
                        case 'healthcare':
                            roomColor = 0x00ff88;
                            opacity = 0.15;
                            break;
                        case 'activity':
                            roomColor = 0x00ccff;
                            opacity = 0.15;
                            break;
                        case 'dining':
                            roomColor = 0xffaa00;
                            opacity = 0.15;
                            break;
                        case 'technical':
                            roomColor = 0xff007f;
                            opacity = 0.1;
                            break;
                    }

                    const roomMaterial = new THREE.MeshStandardMaterial({
                        color: roomColor,
                        metalness: 0.2,
                        roughness: 0.7,
                        transparent: true,
                        opacity: opacity,
                        emissive: roomColor,
                        emissiveIntensity: 0.2
                    });
                    const roomMesh = new THREE.Mesh(roomGeometry, roomMaterial);
                    roomMesh.position.set(room.x, yOffset + height / 2, room.z);
                    roomMesh.userData = { ...room, floor: floorKey };
                    roomMesh.castShadow = true;
                    roomMesh.receiveShadow = true;
                    group.add(roomMesh);

                    // æ·»åŠ æˆ¿é–“é‚Šæ¡†ï¼ˆç·šæ¡†ï¼‰ä»¥æ”¹é€²å…§éƒ¨å°è¦½çš„æ¸…æ™°åº¦
                    const edges = new THREE.EdgesGeometry(roomGeometry);
                    const lineSegments = new THREE.LineSegments(
                        edges,
                        new THREE.LineBasicMaterial({
                            color: roomColor,
                            transparent: true,
                            opacity: 0.6,
                            linewidth: 1
                        })
                    );
                    lineSegments.position.copy(roomMesh.position);
                    lineSegments.userData = { floor: floorKey };
                    group.add(lineSegments);
                });

                // å»ºé€ æˆ¿é–“ä¹‹é–“çš„å…§éƒ¨åˆ†éš”ç‰†
                const wallMaterial = new THREE.MeshStandardMaterial({
                    color: 0xd3d3d3,
                    metalness: 0.1,
                    roughness: 0.9
                });

                const rooms = ROOM_DATA[floorKey] || [];

                // ç‚ºæ¯å€‹æˆ¿é–“å‰µå»ºé‚Šç•Œç‰†
                rooms.forEach(room => {
                    const wallThickness = 0.2;
                    const wallHeight = height * 0.9;

                    // æˆ¿é–“çš„é‚Šç•Œ
                    const left = room.x - room.w / 2;
                    const right = room.x + room.w / 2;
                    const front = room.z - room.d / 2;
                    const back = room.z + room.d / 2;

                    // åŒ—ç‰†ï¼ˆå¾Œé¢ï¼‰
                    if (!isRoomAdjacent(rooms, room, 'north')) {
                        const northWall = new THREE.BoxGeometry(room.w + wallThickness * 2, wallHeight, wallThickness);
                        const northMesh = new THREE.Mesh(northWall, wallMaterial);
                        northMesh.position.set(room.x, yOffset + height / 2, back + wallThickness / 2);
                        northMesh.castShadow = true;
                        northMesh.receiveShadow = true;
                        northMesh.userData = { floor: floorKey, type: 'interior_wall' };
                        group.add(northMesh);
                    }

                    // å—ç‰†ï¼ˆå‰é¢ï¼‰
                    if (!isRoomAdjacent(rooms, room, 'south')) {
                        const southWall = new THREE.BoxGeometry(room.w + wallThickness * 2, wallHeight, wallThickness);
                        const southMesh = new THREE.Mesh(southWall, wallMaterial);
                        southMesh.position.set(room.x, yOffset + height / 2, front - wallThickness / 2);
                        southMesh.castShadow = true;
                        southMesh.receiveShadow = true;
                        southMesh.userData = { floor: floorKey, type: 'interior_wall' };
                        group.add(southMesh);
                    }

                    // æ±ç‰†ï¼ˆå³é‚Šï¼‰
                    if (!isRoomAdjacent(rooms, room, 'east')) {
                        const eastWall = new THREE.BoxGeometry(wallThickness, wallHeight, room.d);
                        const eastMesh = new THREE.Mesh(eastWall, wallMaterial);
                        eastMesh.position.set(right + wallThickness / 2, yOffset + height / 2, room.z);
                        eastMesh.castShadow = true;
                        eastMesh.receiveShadow = true;
                        eastMesh.userData = { floor: floorKey, type: 'interior_wall' };
                        group.add(eastMesh);
                    }

                    // è¥¿ç‰†ï¼ˆå·¦é‚Šï¼‰
                    if (!isRoomAdjacent(rooms, room, 'west')) {
                        const westWall = new THREE.BoxGeometry(wallThickness, wallHeight, room.d);
                        const westMesh = new THREE.Mesh(westWall, wallMaterial);
                        westMesh.position.set(left - wallThickness / 2, yOffset + height / 2, room.z);
                        westMesh.castShadow = true;
                        westMesh.receiveShadow = true;
                        westMesh.userData = { floor: floorKey, type: 'interior_wall' };
                        group.add(westMesh);
                    }
                });

                yOffset += height;
            });

            return group;
        }

        function animate() {
            requestAnimationFrame(animate);

            frameCount++;
            const now = Date.now();
            if (now >= lastTime + 1000) {
                fps = frameCount;
                document.getElementById('fps-display').textContent = fps;
                frameCount = 0;
                lastTime = now;
            }

            // æ ¹æ“šç•¶å‰æ¨¡å¼æ›´æ–°æ§åˆ¶å’Œç›¸æ©Ÿ
            if (currentMode === 'exterior') {
                orbitControls.update();
                renderer.render(scene, orbitCamera);
            } else if (currentMode === 'interior') {
                // å…§éƒ¨å°è¦½ - ä½¿ç”¨ Minecraft é¢¨æ ¼çš„ç›¸æ©Ÿæ§åˆ¶ï¼ˆæ”¯æ´ WASD + æ»‘é¼ çœ‹ï¼‰
                updateFPSMovement();  // åŒæ™‚è™•ç†ç§»å‹•å’Œç›¸æ©Ÿæ—‹è½‰
                renderer.render(scene, fpsCamera);
            } else if (currentMode === 'fps') {
                // ç¬¬ä¸€äººç¨±è¦–è§’ - ä½¿ç”¨ Minecraft é¢¨æ ¼çš„ç›¸æ©Ÿæ§åˆ¶
                updateFPSMovement();
                renderer.render(scene, fpsCamera);
            }
        }

        // Minecraft é¢¨æ ¼çš„ FPS ç§»å‹•æ§åˆ¶
        function updateFPSMovement() {
            const direction = new THREE.Vector3();

            // åŸºæ–¼ç›¸æ©Ÿæ—‹è½‰è¨ˆç®—ç§»å‹•æ–¹å‘ï¼ˆç›¸å°æ–¼ç›¸æ©Ÿæœå‘ï¼‰
            // yaw æ˜¯å·¦å³çœ‹ï¼Œpitch æ˜¯ä¸Šä¸‹çœ‹
            const forward = new THREE.Vector3(
                Math.sin(minecraftControls.yaw),
                0,
                Math.cos(minecraftControls.yaw)
            );

            const right = new THREE.Vector3(
                Math.sin(minecraftControls.yaw + Math.PI / 2),
                0,
                Math.cos(minecraftControls.yaw + Math.PI / 2)
            );

            // æ ¹æ“šæŒ‰éµç‹€æ…‹è¨­ç½®ç§»å‹•æ–¹å‘ï¼ˆç›¸æ©Ÿç›¸å°ï¼‰
            if (moveVector.forward) {
                direction.add(forward);
            }
            if (moveVector.backward) {
                direction.sub(forward);
            }
            if (moveVector.right) {
                direction.add(right);
            }
            if (moveVector.left) {
                direction.sub(right);
            }

            if (direction.length() > 0) {
                direction.normalize();
                const moveAmount = direction.clone().multiplyScalar(FPS_SPEED);

                // æ”¹é€²çš„ç¢°æ’æª¢æ¸¬ - å¤šé»æª¢æ¸¬
                const safeDistance = 1.0;  // æ›´å¤§çš„å®‰å…¨è·é›¢
                const rayStart = fpsCamera.position.clone();
                const rayDir = moveAmount.clone().normalize();

                // æª¢æ¸¬å‰æ–¹ç¢°æ’
                raycaster.set(rayStart, rayDir);
                const intersects = raycaster.intersectObjects(scene.children, true);

                let canMove = true;
                if (intersects.length > 0) {
                    // å¦‚æœå‰æ–¹æœ‰ç¢°æ’ç‰©é«”ï¼Œæª¢æŸ¥è·é›¢æ˜¯å¦å®‰å…¨
                    if (intersects[0].distance < safeDistance) {
                        canMove = false;
                    }
                }

                // ç§»å‹•å‰æª¢æŸ¥ç›®æ¨™ä½ç½®
                if (canMove) {
                    const newPos = rayStart.clone().add(moveAmount);

                    // å†æ¬¡æª¢æŸ¥æ–°ä½ç½®æ˜¯å¦å®‰å…¨ï¼ˆäºŒæ¬¡æª¢æŸ¥ï¼‰
                    raycaster.set(newPos, new THREE.Vector3(0, -1, 0));
                    const groundCheck = raycaster.intersectObjects(scene.children, true);

                    // åªè¦ä¸ç©¿é€åœ°æ¿å°±å…è¨±ç§»å‹•
                    fpsCamera.position.copy(newPos);
                }
            }

            // æ ¹æ“š pitch å’Œ yaw æ›´æ–°ç›¸æ©Ÿæ—‹è½‰
            // é™åˆ¶ pitch ä»¥é˜²æ­¢å®Œå…¨ç¿»è½‰
            const maxPitch = Math.PI / 2 * 0.99;
            minecraftControls.pitch = Math.max(-maxPitch, Math.min(maxPitch, minecraftControls.pitch));

            // æ‡‰ç”¨æ—‹è½‰åˆ°ç›¸æ©Ÿï¼ˆMinecraft é¢¨æ ¼ï¼‰
            fpsCamera.rotation.order = 'YXZ';
            fpsCamera.rotation.y = minecraftControls.yaw;
            fpsCamera.rotation.x = minecraftControls.pitch;
        }

        // ==================== UI æ§åˆ¶ ====================

        function switchMode(mode) {
            currentMode = mode;
            window.currentMode = mode;  // åŒæ™‚æ›´æ–°å…¨å±€è®Šæ•¸
            document.querySelectorAll('.mode-btn').forEach(btn => {
                if (btn.textContent.includes(mode === 'exterior' ? 'å¤–' : mode === 'interior' ? 'å…§' : 'äºº')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // æ ¹æ“šæ¨¡å¼è¨­ç½®ç›¸æ©Ÿå’Œæ§åˆ¶å™¨
            if (mode === 'exterior') {
                // å¤–éƒ¨è¦–è§’ - å•Ÿç”¨ OrbitControls
                orbitControls.enabled = true;  // âœ… å•Ÿç”¨ OrbitControls
                orbitControls.object = orbitCamera;
                orbitControls.autoRotate = true;
                orbitCamera.position.set(80, 60, 80);
                orbitControls.target.set(0, 15, 0);
                orbitControls.update();

                // é¡¯ç¤ºå¤–ç‰†
                scene.children.forEach(child => {
                    if (child.userData.floor) {
                        child.visible = true;
                    }
                });
            } else if (mode === 'interior') {
                // å…§éƒ¨å°è¦½ - Minecraft é¢¨æ ¼æ§åˆ¶ï¼ˆWASD + é¼ æ¨™çœ‹ï¼‰
                // âŒ ç¦æ­¢ OrbitControls - ä½¿ç”¨ Minecraft æ§åˆ¶ä»£æ›¿
                orbitControls.autoRotate = false;
                orbitControls.enabled = false;  // ç¦ç”¨ OrbitControls

                // é€²å…¥å»ºç¯‰å…§éƒ¨ï¼Œåˆ‡æ›åˆ° 1Fï¼ˆå¦‚æœå·²é¸æ“‡å…¶ä»–æ¨“å±¤å‰‡ä¿æŒï¼‰
                const floorIndex = BUILDING_CONFIG.floors.indexOf(currentFloor);
                let floorCenterY = 0;
                for (let i = 0; i < floorIndex; i++) {
                    floorCenterY += BUILDING_CONFIG.floorHeights[i];
                }

                // æŠŠç›¸æ©Ÿæ”¾åœ¨è©²æ¨“å±¤å…§éƒ¨çš„ä¸­å¤®ä½ç½®ï¼Œé¢å‘å‰æ–¹
                fpsCamera.position.set(0, floorCenterY + FPS_HEIGHT, 0);
                minecraftControls.yaw = 0;  // é¢å‘å‰æ–¹ï¼ˆ+Z æ–¹å‘ï¼‰
                minecraftControls.pitch = 0;

                // é‡‹æ”¾ Pointer Lock
                if (document.pointerLockElement) {
                    document.exitPointerLock();
                }

                // é¡¯ç¤ºæ‰€æœ‰å…§éƒ¨å¹¾ä½•
                scene.children.forEach(child => {
                    if (child.userData && child.userData.floor) {
                        child.visible = true;
                    }
                });
            } else if (mode === 'fps') {
                // ç¬¬ä¸€äººç¨±è¦–è§’ - Minecraft é¢¨æ ¼æ§åˆ¶ï¼ˆWASD + é¼ æ¨™çœ‹ï¼‰
                // âŒ ç¦æ­¢ OrbitControls
                orbitControls.enabled = false;
                orbitControls.autoRotate = false;

                // é€²å…¥å»ºç¯‰å…§éƒ¨ï¼Œä½¿ç”¨ç•¶å‰æ¨“å±¤
                const floorIndex = BUILDING_CONFIG.floors.indexOf(currentFloor);
                let floorCenterY = 0;
                for (let i = 0; i < floorIndex; i++) {
                    floorCenterY += BUILDING_CONFIG.floorHeights[i];
                }

                // æŠŠç›¸æ©Ÿæ”¾åœ¨è©²æ¨“å±¤å…§éƒ¨çš„ä¸­å¤®ä½ç½®
                fpsCamera.position.set(0, floorCenterY + FPS_HEIGHT, 0);
                minecraftControls.yaw = 0;  // é¢å‘å‰æ–¹
                minecraftControls.pitch = 0;

                // é¡¯ç¤ºæ‰€æœ‰å…§éƒ¨å¹¾ä½•
                scene.children.forEach(child => {
                    if (child.userData && child.userData.floor) {
                        child.visible = true;
                    }
                });
            }
        }

        // éµç›¤äº‹ä»¶è™•ç†å™¨
        function onKeyDown(event) {
            switch (event.key.toLowerCase()) {
                case 'w': moveVector.forward = true; break;
                case 's': moveVector.backward = true; break;
                case 'a': moveVector.left = true; break;
                case 'd': moveVector.right = true; break;
            }
        }

        function onKeyUp(event) {
            switch (event.key.toLowerCase()) {
                case 'w': moveVector.forward = false; break;
                case 's': moveVector.backward = false; break;
                case 'a': moveVector.left = false; break;
                case 'd': moveVector.right = false; break;
            }
        }

        // Minecraft é¢¨æ ¼çš„é¼ æ¨™ç§»å‹•æ§åˆ¶ï¼ˆç›¸æ©Ÿæ—‹è½‰ï¼‰
        function onMouseMove(event) {
            if (currentMode === 'interior' || currentMode === 'fps') {
                const deltaX = event.clientX - minecraftControls.lastX;
                const deltaY = event.clientY - minecraftControls.lastY;

                // æ›´æ–°ç›¸æ©Ÿæ—‹è½‰ï¼ˆåœ¨ä»»ä½•æ™‚åˆ»ï¼Œåªæœ‰ç•¶æ»‘é¼ åœ¨ç•«å¸ƒä¸Šç§»å‹•æ™‚ï¼‰
                minecraftControls.yaw -= deltaX * minecraftControls.mouseSensitivity;
                minecraftControls.pitch -= deltaY * minecraftControls.mouseSensitivity;

                // è¨˜éŒ„æ–°ä½ç½®
                minecraftControls.lastX = event.clientX;
                minecraftControls.lastY = event.clientY;
            }
        }

        function selectFloor(floor) {
            currentFloor = floor;
            window.currentFloor = floor;  // åŒæ™‚æ›´æ–°å…¨å±€è®Šæ•¸
            document.querySelectorAll('.floor-btn').forEach(btn => {
                if (btn.textContent.includes(floor.substring(0, 2))) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // åœ¨å¤–éƒ¨è¦–è§’æ¨¡å¼ä¸‹ï¼Œæ›´æ–°ç›¸æ©Ÿä½ç½®ä¾†èšç„¦åˆ°è©²æ¨“å±¤
            if (currentMode === 'exterior') {
                // è¨ˆç®—è©²æ¨“å±¤çš„ä¸­å¿ƒyåæ¨™
                let floorIndex = BUILDING_CONFIG.floors.indexOf(floor);
                let floorCenterY = 0;

                // è¨ˆç®—æ¨“å±¤ä¸­å¿ƒé«˜åº¦
                for (let i = 0; i < floorIndex; i++) {
                    floorCenterY += BUILDING_CONFIG.floorHeights[i];
                }
                floorCenterY += BUILDING_CONFIG.floorHeights[floorIndex] / 2;

                // å¹³æ»‘åœ°ç§»å‹•ç›¸æ©Ÿåˆ°æ–°æ¨“å±¤
                orbitCamera.position.set(80, floorCenterY + 40, 80);
                orbitControls.target.set(0, floorCenterY, 0);
                orbitControls.update();
            }

            updateRoomsList();
            updateInfoPanel();
            drawMinimap();  // æ›´æ–°å°åœ°åœ–
        }

        function updateRoomsList() {
            const rooms = ROOM_DATA[currentFloor] || [];
            const html = rooms.map(room => `
                <div class="room-item" onclick="selectRoom('${room.id}')">
                    <div class="room-name">${room.name}</div>
                    <div class="room-area">${room.area} mÂ² â€¢ ${room.equipment[0]}</div>
                </div>
            `).join('');
            document.getElementById('rooms-list').innerHTML = html;
        }

        function selectRoom(roomId) {
            const room = ROOM_DATA[currentFloor].find(r => r.id === roomId);
            if (room) updateInfoPanel(room);
        }

        function updateInfoPanel(room = null) {
            const panel = document.getElementById('info-panel');
            if (!room) {
                const floorRooms = ROOM_DATA[currentFloor] || [];
                const totalArea = floorRooms.reduce((sum, r) => sum + r.area, 0);
                panel.innerHTML = `
                    <div class="info-card">
                        <div class="card-title">æ¨“å±¤çµ±è¨ˆ</div>
                        <div class="card-content">
                            <div class="info-row">
                                <span class="info-label">æ¨“å±¤</span>
                                <span class="info-value">${currentFloor}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">æˆ¿é–“æ•¸</span>
                                <span class="info-value">${floorRooms.length}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ç¸½é¢ç©</span>
                                <span class="info-value">${totalArea} mÂ²</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                panel.innerHTML = `
                    <div class="info-card">
                        <div class="card-title">${room.name}</div>
                        <div class="card-content">
                            <div class="info-row">
                                <span class="info-label">æˆ¿é–“ ID</span>
                                <span class="info-value">${room.id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">é¢ç©</span>
                                <span class="info-value">${room.area} mÂ²</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">é¡å‹</span>
                                <span class="info-value">${room.type}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">è¨­å‚™</span>
                            </div>
                            ${room.equipment.map(eq => `
                                <div style="color: #888; font-size: 11px; padding: 4px 0; padding-left: 10px;">â€¢ ${eq}</div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        function toggleWireframe() {
            scene.traverse(obj => {
                if (obj.material && obj.material.wireframe !== undefined) {
                    obj.material.wireframe = !obj.material.wireframe;
                }
            });
        }

        function toggleAutoRotate() {
            orbitControls.autoRotate = !orbitControls.autoRotate;
        }

        function resetView() {
            orbitCamera.position.set(80, 60, 80);
            orbitControls.target.set(0, 15, 0);
            orbitControls.update();
        }

        function toggleHelp() {
            const helpText = `
ğŸ® ä¸‰ç¨®è¦–è§’æ¨¡å¼:

ã€å¤–éƒ¨è¦–è§’ã€‘
â€¢ æ»‘é¼ å·¦éµæ‹–å‹•: æ—‹è½‰è¦–è§’
â€¢ æ»‘é¼ æ»¾è¼ª: æ”¾å¤§/ç¸®å°
â€¢ æ»‘é¼ å³éµæ‹–å‹•: å¹³ç§»è¦–è§’

ã€å…§éƒ¨å°è¦½ã€‘
â€¢ æ»‘é¼ å·¦éµæ‹–å‹•: æ—‹è½‰è¦–è§’
â€¢ æ»‘é¼ æ»¾è¼ª: æ”¾å¤§/ç¸®å°
â€¢ é»æ“Šæ¨“å±¤/æˆ¿é–“æŸ¥çœ‹è©³æƒ…

ã€ç¬¬ä¸€äººç¨±è¦–è§’ã€‘
â€¢ W/A/S/D: ç§»å‹• (å‰/å·¦/å¾Œ/å³)
â€¢ æ»‘é¼ ç§»å‹•: è½‰èº«/çœ‹å‘
â€¢ é»æ“Šç•«é¢: é–å®šæ»‘é¼ (Pointer Lock)
â€¢ æŒ‰ ESC: é‡‹æ”¾æ»‘é¼ 

å…¶ä»–:
â€¢ ç·šæ¡†: åˆ‡æ›ç·šæ¡†é¡¯ç¤º
â€¢ è‡ªå‹•æ—‹è½‰: é–‹å•Ÿè‡ªå‹•æ—‹è½‰
â€¢ é‡ç½®è¦–è§’: å›åˆ°åˆå§‹è¦–è§’
            `;
            alert(helpText.trim());
        }

        // ==================== å°åœ°åœ–ç¹ªè£½ ====================
        function drawMinimap() {
            const canvas = document.getElementById('minimap-canvas');
            if (!canvas || !currentFloor) return;

            const ctx = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 200;

            // æ¸…ç©ºcanvas
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, 200, 200);

            // ç¹ªè£½é‚Šæ¡†
            ctx.strokeStyle = 'rgba(0, 204, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, 200, 200);

            // ç²å–ç•¶å‰æ¨“å±¤çš„æˆ¿é–“æ•¸æ“š
            const rooms = ROOM_DATA[currentFloor] || [];
            if (rooms.length === 0) return;

            // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
            const scale = 3;

            // ç¹ªè£½æˆ¿é–“
            rooms.forEach(room => {
                const x = (room.x + 16) * scale;
                const y = (room.z + 10) * scale;
                const w = room.w * scale / 1.5;
                const d = room.d * scale / 1.5;

                // æ ¹æ“šæˆ¿é–“é¡å‹è‘—è‰²
                switch (room.type) {
                    case 'healthcare':
                        ctx.fillStyle = 'rgba(0, 255, 136, 0.6)';
                        break;
                    case 'activity':
                        ctx.fillStyle = 'rgba(0, 204, 255, 0.6)';
                        break;
                    case 'dining':
                        ctx.fillStyle = 'rgba(255, 170, 0, 0.6)';
                        break;
                    case 'technical':
                        ctx.fillStyle = 'rgba(255, 0, 127, 0.4)';
                        break;
                    default:
                        ctx.fillStyle = 'rgba(100, 100, 150, 0.5)';
                }
                ctx.fillRect(x, y, w, d);

                // ç¹ªè£½é‚Šæ¡†
                ctx.strokeStyle = 'rgba(0, 255, 136, 0.5)';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, w, d);
            });

            // ç¹ªè£½æ¨“å±¤æ¨™ç±¤
            ctx.fillStyle = '#00ccff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText(currentFloor, 8, 8);
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const aspect = width / height;

            // æ›´æ–°å…©å€‹ç›¸æ©Ÿ
            orbitCamera.aspect = aspect;
            orbitCamera.updateProjectionMatrix();
            fpsCamera.aspect = aspect;
            fpsCamera.updateProjectionMatrix();

            renderer.setSize(width, height);
        }

        // ==================== åˆå§‹åŒ– ====================
        window.addEventListener('load', () => {
            console.log('ğŸ“ é é¢è¼‰å…¥å®Œæˆï¼Œæª¢æŸ¥ Three.js...');

            // ç­‰å¾… Three.js åŠ è¼‰ï¼ˆæœ€å¤š 5 ç§’ï¼‰
            let attempts = 0;
            const maxAttempts = 50; // 50 Ã— 100ms = 5 ç§’

            function waitForThreeJS() {
                attempts++;

                if (typeof THREE !== 'undefined') {
                    console.log('âœ… Three.js å·²åŠ è¼‰');
                    checkThreeJS(); // åˆå§‹åŒ– raycaster å’Œ velocity

                    console.log('ğŸ—ï¸ åˆå§‹åŒ– Three.js å ´æ™¯...');
                    initThreeJS();
                    updateRoomsList();
                    updateInfoPanel();
                    document.getElementById('obj-display').textContent = scene.children.length;

                    // æš´éœ²å…¨å±€è®Šæ•¸ä¾›æ¸¬è©¦ä½¿ç”¨
                    window.currentFloor = currentFloor;
                    window.currentMode = currentMode;
                    window.ROOM_DATA = ROOM_DATA;
                    window.fpsCamera = fpsCamera;
                    window.orbitCamera = orbitCamera;
                    window.scene = scene;
                    window.selectFloor = selectFloor;
                    window.updateRoomsList = updateRoomsList;
                    window.updateInfoPanel = updateInfoPanel;
                    window.switchMode = switchMode;
                    window.drawMinimap = drawMinimap;

                    // åˆå§‹åŒ–å°åœ°åœ–
                    setTimeout(drawMinimap, 500);

                    console.log('âœ… åˆå§‹åŒ–å®Œæˆï¼Œ3D å»ºç¯‰æ‡‰è©²å‡ºç¾äº†');
                } else if (attempts < maxAttempts) {
                    console.log(`â³ ç­‰å¾… Three.js åŠ è¼‰... (${attempts}/${maxAttempts})`);
                    setTimeout(waitForThreeJS, 100);
                } else {
                    console.error('âŒ Three.js åŠ è¼‰è¶…æ™‚ï¼Œå˜—è©¦å‚™é¸ CDN...');
                    window.location.reload();
                }
            }

            waitForThreeJS();
        });
    </script>
</body>
</html>
