<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ¤åœŸå´å¤šåŠŸèƒ½é¤¨ - 3Då®¤å…§å°è¦½ç³»çµ± (å°ˆæ¥­ç‰ˆ)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', 'Segoe UI', -apple-system, sans-serif;
            background: #0a0e27;
            overflow: hidden;
            color: #ffffff;
        }

        /* ============== ä¸»å®¹å™¨ ============== */
        #app {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 60px 1fr;
        }

        /* ============== é ‚éƒ¨å°èˆªæ¬„ ============== */
        #topbar {
            background: rgba(10, 14, 39, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .app-title {
            font-size: 16px;
            font-weight: 600;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            letter-spacing: 1px;
        }

        .mode-switcher {
            display: flex;
            gap: 8px;
            background: rgba(0, 255, 136, 0.1);
            padding: 4px;
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .mode-btn {
            padding: 6px 14px;
            border: none;
            background: transparent;
            color: #888;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .mode-btn:hover {
            color: #00ff88;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stats {
            display: flex;
            gap: 20px;
            font-size: 11px;
            color: #888;
            font-family: 'Courier New', monospace;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .stat-label {
            color: #666;
            font-size: 10px;
        }

        .stat-value {
            color: #00ff88;
            font-weight: 600;
        }

        /* ============== ä¸»å…§å®¹å€ ============== */
        #main-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 1px;
            background: #0a0e27;
        }

        /* ============== å·¦å´é¢æ¿ ============== */
        #left-panel {
            background: rgba(10, 14, 39, 0.9);
            border-right: 1px solid rgba(0, 255, 136, 0.2);
            overflow-y: auto;
            padding: 20px;
        }

        .panel-title {
            font-size: 13px;
            font-weight: 600;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }

        .floor-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 30px;
        }

        .floor-btn {
            padding: 10px 12px;
            background: rgba(0, 204, 255, 0.1);
            border: 1px solid rgba(0, 204, 255, 0.3);
            color: #00ccff;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: left;
        }

        .floor-btn:hover {
            background: rgba(0, 204, 255, 0.2);
            border-color: rgba(0, 204, 255, 0.6);
        }

        .floor-btn.active {
            background: #00ccff;
            color: #000;
            box-shadow: 0 0 15px rgba(0, 204, 255, 0.5);
        }

        .rooms-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .room-item {
            padding: 8px 10px;
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.1);
            border-radius: 3px;
            margin-bottom: 6px;
            cursor: pointer;
            font-size: 11px;
            color: #aaa;
            transition: all 0.3s ease;
        }

        .room-item:hover {
            background: rgba(0, 255, 136, 0.15);
            color: #00ff88;
            border-color: rgba(0, 255, 136, 0.3);
        }

        .room-name {
            font-weight: 500;
            color: #00ff88;
            margin-bottom: 2px;
        }

        .room-area {
            font-size: 10px;
            color: #666;
        }

        /* ============== ä¸­å¤® 3D Canvas ============== */
        #canvas-container {
            position: relative;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a3e 100%);
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ============== å³å´é¢æ¿ ============== */
        #right-panel {
            background: rgba(10, 14, 39, 0.9);
            border-left: 1px solid rgba(255, 0, 255, 0.2);
            overflow-y: auto;
            padding: 20px;
        }

        .info-card {
            background: rgba(255, 0, 255, 0.05);
            border: 1px solid rgba(255, 0, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: #ff00ff;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
        }

        .card-content {
            font-size: 12px;
            color: #ccc;
            line-height: 1.6;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 0, 255, 0.1);
        }

        .info-label {
            color: #888;
            font-weight: 500;
        }

        .info-value {
            color: #00ff88;
            font-weight: 600;
        }

        /* ============== æ‡¸æµ®æ§åˆ¶é¢æ¿ ============== */
        .floating-panel {
            position: absolute;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 170, 0, 0.3);
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 11px;
            color: #ffaa00;
            z-index: 500;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.2);
        }

        #control-panel {
            bottom: 20px;
            right: 20px;
        }

        .control-title {
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 10px;
            letter-spacing: 1px;
            font-size: 10px;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .ctrl-btn {
            padding: 6px 10px;
            background: rgba(255, 170, 0, 0.15);
            border: 1px solid rgba(255, 170, 0, 0.3);
            color: #ffaa00;
            cursor: pointer;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .ctrl-btn:hover {
            background: rgba(255, 170, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 170, 0, 0.3);
        }

        /* ============== å°åœ°åœ– ============== */
        #minimap {
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 200px;
        }

        #minimap-canvas {
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            border-radius: 6px;
            border: 1px solid rgba(0, 204, 255, 0.3);
        }

        /* ============== æç¤ºç³»çµ± ============== */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 4px;
            padding: 8px 10px;
            font-size: 11px;
            color: #00ff88;
            pointer-events: none;
            z-index: 400;
            white-space: nowrap;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        /* ============== æ»¾å‹•æ¢ç¾åŒ– ============== */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.3);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 136, 0.5);
        }

        /* ============== åŠ è¼‰å‹•ç•« ============== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        /* ============== éŸ¿æ‡‰å¼è¨­è¨ˆ ============== */
        @media (max-width: 1400px) {
            #main-container {
                grid-template-columns: 1fr 300px;
            }
            #left-panel {
                display: none;
            }
        }

        @media (max-width: 1000px) {
            #main-container {
                grid-template-columns: 1fr;
            }
            #right-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- é ‚éƒ¨å°èˆªæ¬„ -->
        <div id="topbar">
            <div class="topbar-left">
                <div class="app-title">ğŸ¢ èµ¤åœŸå´å¤šåŠŸèƒ½é¤¨ 3D å°è¦½ç³»çµ±</div>
                <div class="mode-switcher">
                    <button class="mode-btn active" onclick="switchMode('exterior')">å¤–éƒ¨è¦–è§’</button>
                    <button class="mode-btn" onclick="switchMode('interior')">å…§éƒ¨å°è¦½</button>
                    <button class="mode-btn" onclick="switchMode('fps')">ç¬¬ä¸€äººç¨±</button>
                </div>
            </div>
            <div class="topbar-right">
                <div class="stats">
                    <div class="stat-item">
                        <span class="stat-label">FPS</span>
                        <span class="stat-value" id="fps-display">60</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Objects</span>
                        <span class="stat-value" id="obj-display">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Memory</span>
                        <span class="stat-value" id="mem-display">0MB</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»å®¹å™¨ -->
        <div id="main-container">
            <!-- å·¦å´é¢æ¿ -->
            <div id="left-panel">
                <div class="panel-title">æ¨“å±¤å°èˆª</div>
                <div class="floor-list">
                    <button class="floor-btn" onclick="selectFloor('B1')">B1 åœè»Šå ´+æ©Ÿæˆ¿</button>
                    <button class="floor-btn active" onclick="selectFloor('1F')">1F é•·ç…§+AIè¨˜æ†¶</button>
                    <button class="floor-btn" onclick="selectFloor('2F')">2F æ‰˜å¬°+SIDSç›£æ¸¬</button>
                    <button class="floor-btn" onclick="selectFloor('3F')">3F è¦ªå­å…±å­¸</button>
                    <button class="floor-btn" onclick="selectFloor('4F')">4F VRæ•™å®¤</button>
                    <button class="floor-btn" onclick="selectFloor('5F')">5F ç¶ èƒ½ç³»çµ±</button>
                    <button class="floor-btn" onclick="selectFloor('6F')">6F æœƒè­°å»³</button>
                </div>

                <div class="panel-title">æˆ¿é–“åˆ—è¡¨</div>
                <div class="rooms-list" id="rooms-list"></div>
            </div>

            <!-- ä¸­å¤® 3D Canvas -->
            <div id="canvas-container"></div>

            <!-- å³å´é¢æ¿ -->
            <div id="right-panel">
                <div id="info-panel"></div>
            </div>
        </div>

        <!-- å°åœ°åœ– -->
        <div class="floating-panel" id="minimap">
            <div class="control-title">æ¨“å±¤å¹³é¢åœ–</div>
            <canvas id="minimap-canvas"></canvas>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="floating-panel" id="control-panel">
            <div class="control-title">âš™ï¸ æ§åˆ¶</div>
            <div class="control-buttons">
                <button class="ctrl-btn" onclick="toggleWireframe()">ç·šæ¡†</button>
                <button class="ctrl-btn" onclick="toggleAutoRotate()">è‡ªå‹•æ—‹è½‰</button>
                <button class="ctrl-btn" onclick="resetView()">é‡ç½®è¦–è§’</button>
                <button class="ctrl-btn" onclick="toggleHelp()">å¹«åŠ©</button>
            </div>
        </div>
    </div>

    <!-- Three.js ES Modules from Local Server (No CDN) -->
    <script type="importmap">
    {
        "imports": {
            "three": "/libs/three/three.module.js",
            "three/addons/controls/OrbitControls.js": "/libs/three/OrbitControls.js",
            "three/addons/controls/PointerLockControls.js": "/libs/three/PointerLockControls.js"
        }
    }
    </script>
    <script type="module">
        // Import Three.js and controls
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // Make them globally accessible for non-module scripts
        window.THREE = THREE;
        window.OrbitControls = OrbitControls;
        window.PointerLockControls = PointerLockControls;
    </script>
    <script>
        // ==================== å…¨å±€é…ç½® ====================
        const BUILDING_CONFIG = {
            width: 32,
            depth: 20,
            floors: ['B1', '1F', '2F', '3F', '4F', '5F', '6F'],
            floorHeights: [5, 4, 3.5, 3.5, 3.5, 3.5, 3.5]
        };

        // FPS æ§åˆ¶ç›¸é—œè®Šæ•¸
        let fpsCamera, orbitCamera;
        let fpsControls, pointerLockControls;
        let isPointerLocked = false;
        let currentMode = 'exterior';
        let moveVector = { forward: false, backward: false, left: false, right: false };
        let currentFloor = '1F';
        const FPS_SPEED = 0.15;
        const FPS_HEIGHT = 1.6; // äººçœ¼é«˜åº¦

        // ==================== æˆ¿é–“æ•¸æ“š (å®Œæ•´çš„43å€‹æˆ¿é–“) ====================
        const ROOM_DATA = {
            'B1': [
                { id: 'B1-01', name: 'åœè»Šå ´', x: 0, z: 0, w: 28, d: 16, area: 448, type: 'facility', equipment: ['åœè»Šä½Ã—60', 'æ„Ÿæ¸¬ç³»çµ±'] },
                { id: 'B1-02', name: 'ç©ºèª¿æ©Ÿæˆ¿', x: 12, z: -8, w: 4, d: 3, area: 12, type: 'technical', equipment: ['å†·æš–ä¸»æ©ŸÃ—2'] },
                { id: 'B1-03', name: 'é…é›»å®¤', x: 12, z: -5, w: 3, d: 3, area: 9, type: 'technical', equipment: ['ä¸»é…ç›¤', 'UPSç³»çµ±'] },
                { id: 'B1-04', name: 'çµ¦æ’æ°´', x: 10, z: -8, w: 2, d: 2, area: 4, type: 'technical', equipment: ['æ°´å¡”Ã—1'] },
                { id: 'B1-05', name: 'é›¨æ°´å›æ”¶', x: 8, z: -8, w: 2, d: 2, area: 4, type: 'technical', equipment: ['å„²å­˜æ± '] }
            ],
            '1F': [
                { id: '1F-01', name: 'å¤±æ™ºç—‡å°ˆå€', x: -8, z: 0, w: 14, d: 14, area: 196, type: 'healthcare', equipment: ['æŠ•å½±ç³»çµ±', 'äº’å‹•è£ç½®'] },
                { id: '1F-02', name: 'AIæŠ•å½±æ’­æ”¾', x: 4, z: -5, w: 8, d: 7, area: 56, type: 'healthcare', equipment: ['æŠ•å½±æ©Ÿ', 'æ™ºæ…§ç›£æ¸¬'] },
                { id: '1F-03', name: 'å¾©å¥è¨“ç·´å€', x: 4, z: 5, w: 8, d: 7, area: 56, type: 'healthcare', equipment: ['å™¨æÃ—5'] },
                { id: '1F-04', name: 'è—è¡“ç™‚æ³•å€', x: -10, z: -8, w: 6, d: 5, area: 30, type: 'healthcare', equipment: ['ç•«å…·', 'æ¨‚å™¨'] },
                { id: '1F-05', name: 'èªçŸ¥è¨“ç·´å€', x: -2, z: -8, w: 5, d: 5, area: 25, type: 'healthcare', equipment: ['å¹³æ¿Ã—5'] },
                { id: '1F-06', name: 'å…±ç”¨é¤å»³', x: 8, z: 8, w: 10, d: 6, area: 60, type: 'dining', equipment: ['æ¡Œæ¤…Ã—20'] },
                { id: '1F-07', name: 'å‚™é¤å»šæˆ¿', x: 10, z: -1, w: 4, d: 3, area: 12, type: 'dining', equipment: ['çˆç¶Ã—3'] },
                { id: '1F-08', name: 'è­·ç†ç«™', x: -12, z: 8, w: 3, d: 3, area: 9, type: 'technical', equipment: ['ç›£æ§ç³»çµ±'] }
            ],
            '2F': [
                { id: '2F-01', name: 'SIDSç›£æ¸¬ç³»çµ±', x: -8, z: 0, w: 12, d: 10, area: 120, type: 'healthcare', equipment: ['æ„Ÿæ¸¬å™¨Ã—50'] },
                { id: '2F-02', name: 'å¬°å…’åºŠå€', x: -8, z: 11, w: 12, d: 8, area: 96, type: 'healthcare', equipment: ['å¬°å…’åºŠÃ—50'] },
                { id: '2F-03', name: 'ä¸­å¤®ç›£æ§', x: 6, z: 0, w: 4, d: 4, area: 16, type: 'technical', equipment: ['ç›£æ§è¢å¹•Ã—4'] },
                { id: '2F-04', name: 'å¬°å…’æ´»å‹•å€', x: 6, z: 8, w: 5, d: 5, area: 25, type: 'activity', equipment: ['çˆ¬è¡Œå¢Š', 'ç©å…·'] },
                { id: '2F-05', name: 'å¹¼å…’æ´»å‹•å€', x: 12, z: 8, w: 6, d: 6, area: 36, type: 'activity', equipment: ['æ»‘æ¢¯', 'æ”€çˆ¬æ¶'] },
                { id: '2F-06', name: 'AIæ•…äº‹æ™‚é–“', x: 6, z: -8, w: 4, d: 3, area: 12, type: 'activity', equipment: ['æŠ•å½±æ©Ÿ'] },
                { id: '2F-07', name: 'é¤µé£Ÿæ›å°¿å€', x: 12, z: -2, w: 6, d: 5, area: 30, type: 'facility', equipment: ['æ›å°¿å°Ã—3'] },
                { id: '2F-08', name: 'è¡›æµ´è¨­æ–½', x: 14, z: 8, w: 4, d: 4, area: 16, type: 'facility', equipment: ['å»æ‰€Ã—2', 'æµ´ç›†'] }
            ],
            '3F': [
                { id: '3F-01', name: 'é–±è®€å€', x: -12, z: 0, w: 6, d: 8, area: 48, type: 'education', equipment: ['æ›¸æ¶Ã—3', 'åº§æ¤…Ã—8'] },
                { id: '3F-02', name: 'æ•…äº‹åŠ‡å ´', x: -4, z: 4, w: 10, d: 8, area: 80, type: 'education', equipment: ['èˆå°', 'æŠ•å½±å¹•'] },
                { id: '3F-03', name: 'ä¸»é¡Œå­¸ç¿’è§’', x: 8, z: 4, w: 10, d: 8, area: 80, type: 'education', equipment: ['STEAMæ•™æ'] },
                { id: '3F-04', name: 'æ™‚é–“éŠ€è¡Œè¾¦å…¬', x: -12, z: -8, w: 6, d: 6, area: 36, type: 'administrative', equipment: ['è¾¦å…¬æ¡ŒÃ—3'] },
                { id: '3F-05', name: 'å°å¸«åº§ä½å€', x: -4, z: -8, w: 6, d: 6, area: 36, type: 'education', equipment: ['åº§ä½Ã—3'] },
                { id: '3F-06', name: 'æœˆåº¦è¡¨æšå€', x: 4, z: -8, w: 4, d: 4, area: 16, type: 'activity', equipment: ['å±•ç¤ºç‰†'] },
                { id: '3F-07', name: 'MRäº’å‹•å€', x: 14, z: 0, w: 5, d: 6, area: 30, type: 'technology', equipment: ['VRé ­ç›”Ã—2'] }
            ],
            '4F': [
                { id: '4F-01', name: 'STEMæ•™å®¤', x: -12, z: 0, w: 10, d: 8, area: 80, type: 'education', equipment: ['é›»è…¦Ã—15'] },
                { id: '4F-02', name: 'æ©Ÿå™¨äººå€', x: 0, z: 0, w: 8, d: 7, area: 56, type: 'technology', equipment: ['ArduinoÃ—10', 'Raspberry PiÃ—10'] },
                { id: '4F-03', name: 'é›»å­å·¥ä½œå°', x: 0, z: -8, w: 5, d: 6, area: 30, type: 'technology', equipment: ['ç„Šæ¥å°Ã—3'] },
                { id: '4F-04', name: 'VRç¡¬é«”å€', x: -12, z: -8, w: 5, d: 5, area: 25, type: 'technology', equipment: ['VRé ­ç›”Ã—10'] },
                { id: '4F-05', name: 'VRæ²‰æµ¸æ•™å®¤', x: 6, z: 2, w: 12, d: 8, area: 96, type: 'technology', equipment: ['æŠ•å½±æ©ŸÃ—2', 'è¿½è¹¤ç³»çµ±'] },
                { id: '4F-06', name: 'è™›æ“¬å¯¦é©—å®¤', x: 10, z: -8, w: 5, d: 6, area: 30, type: 'technology', equipment: ['VRå ´æ™¯'] },
                { id: '4F-07', name: 'é è·å°å¸«å®¤', x: -4, z: -8, w: 5, d: 4, area: 20, type: 'education', equipment: ['è¦–è¨Šç³»çµ±'] },
                { id: '4F-08', name: 'è·æ¶¯å°å¸«å€', x: 12, z: -8, w: 6, d: 5, area: 30, type: 'education', equipment: ['æœƒè­°æ¡Œ'] }
            ],
            '5F': [
                { id: '5F-01', name: 'å¤ªé™½èƒ½é¢æ¿', x: 0, z: 0, w: 20, d: 14, area: 280, type: 'energy', equipment: ['å¤ªé™½èƒ½æ¿Ã—120'] },
                { id: '5F-02', name: 'å„²èƒ½é›»æ± ', x: -8, z: -8, w: 4, d: 4, area: 16, type: 'energy', equipment: ['é‹°é›»æ± çµ„'] },
                { id: '5F-03', name: 'ç¶ å±‹é ‚', x: 8, z: -8, w: 12, d: 10, area: 120, type: 'environment', equipment: ['æ¤è¢«'] },
                { id: '5F-04', name: 'åŸ¹è¨“æ•™å®¤', x: -12, z: 8, w: 6, d: 5, area: 30, type: 'education', equipment: ['åº§æ¤…Ã—60'] },
                { id: '5F-05', name: 'æœƒè­°å®¤', x: -4, z: 8, w: 5, d: 4, area: 20, type: 'administrative', equipment: ['æœƒè­°æ¡Œ'] },
                { id: '5F-06', name: 'å¯¦é©—å®¤', x: 4, z: 8, w: 6, d: 5, area: 30, type: 'research', equipment: ['VR/ARè¨­å‚™'] },
                { id: '5F-07', name: 'è¾¦å…¬å€', x: 12, z: 8, w: 8, d: 6, area: 48, type: 'administrative', equipment: ['åº§ä½Ã—15'] }
            ],
            '6F': [
                { id: '6F-01', name: 'æœƒè­°å»³', x: -2, z: 0, w: 20, d: 12, area: 240, type: 'event', equipment: ['åº§ä½Ã—300', 'æŠ•å½±å¹•'] },
                { id: '6F-02', name: 'å‚™é¤å€', x: -12, z: 8, w: 4, d: 3, area: 12, type: 'dining', equipment: ['æ–™ç†å°'] },
                { id: '6F-03', name: 'è¡›æµ´è¨­æ–½', x: -6, z: 8, w: 4, d: 4, area: 16, type: 'facility', equipment: ['å»æ‰€Ã—12'] },
                { id: '6F-04', name: 'èˆå°', x: 10, z: 6, w: 8, d: 5, area: 40, type: 'event', equipment: ['æŠ•å½±ç³»çµ±', 'éŸ³éŸ¿'] },
                { id: '6F-05', name: 'å±‹é ‚éœ²è‡º', x: 8, z: -10, w: 10, d: 8, area: 80, type: 'outdoor', equipment: ['åº§ä½', 'é®é™½'] },
                { id: '6F-06', name: 'å„²å‚™å€', x: 14, z: 8, w: 4, d: 5, area: 20, type: 'facility', equipment: ['é ç•™ç©ºé–“'] }
            ]
        };

        // ==================== Three.js å ´æ™¯ ====================
        let scene, renderer;
        let building;
        let frameCount = 0, lastTime = Date.now(), fps = 0;
        let raycaster, velocity;

        // ç¢ºä¿ Three.js å·²åŠ è¼‰
        function checkThreeJS() {
            if (typeof THREE === 'undefined') {
                console.error('âŒ Three.js å°šæœªåŠ è¼‰');
                setTimeout(checkThreeJS, 100);
                return false;
            }
            console.log('âœ… Three.js å·²åŠ è¼‰');
            raycaster = new THREE.Raycaster();
            velocity = new THREE.Vector3();
            return true;
        }

        function initThreeJS() {
            const container = document.getElementById('canvas-container');

            // å ´æ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0e27);
            scene.fog = new THREE.Fog(0x0a0e27, 100, 500);

            // å¤–éƒ¨è¦–è§’ç›¸æ©Ÿï¼ˆè»Œé“æ§åˆ¶ï¼‰
            orbitCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            orbitCamera.position.set(80, 60, 80);

            // ç¬¬ä¸€äººç¨±è¦–è§’ç›¸æ©Ÿï¼ˆFPSï¼‰
            fpsCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            fpsCamera.position.set(0, FPS_HEIGHT, 10);

            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // è»Œé“æ§åˆ¶å™¨ï¼ˆå¤–éƒ¨è¦–è§’ï¼‰
            orbitControls = new window.OrbitControls(orbitCamera, renderer.domElement);
            orbitControls.enableDamping = true;
            orbitControls.dampingFactor = 0.05;
            orbitControls.autoRotate = true;
            orbitControls.autoRotateSpeed = 2;

            // FPS æ§åˆ¶å™¨ï¼ˆç¬¬ä¸€äººç¨±ï¼‰
            pointerLockControls = new window.PointerLockControls(fpsCamera, renderer.domElement);
            scene.add(pointerLockControls.getObject());

            // å…‰ç…§
            setupLighting();

            // å»ºç¯‰
            building = createBuilding();
            scene.add(building);

            // åœ°é¢
            const groundGeometry = new THREE.PlaneGeometry(200, 200);
            const groundMaterial = new THREE.MeshPhongMaterial({ color: 0x1a3a2a, side: THREE.DoubleSide });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.5;
            ground.receiveShadow = true;
            scene.add(ground);

            // éµç›¤äº‹ä»¶ç›£è½
            window.addEventListener('keydown', onKeyDown);
            window.addEventListener('keyup', onKeyUp);

            // Pointer Lock äº‹ä»¶
            renderer.domElement.addEventListener('click', () => {
                if (currentMode === 'fps') {
                    pointerLockControls.lock();
                }
            });

            // èª¿æ•´çª—å£å¤§å°
            window.addEventListener('resize', onWindowResize);

            // å‹•ç•«å¾ªç’°
            animate();
        }

        function setupLighting() {
            // ç’°å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            // å¤ªé™½å…‰
            const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
            sunLight.position.set(100, 100, 50);
            sunLight.castShadow = true;
            sunLight.shadow.camera.left = -100;
            sunLight.shadow.camera.right = 100;
            sunLight.shadow.camera.top = 100;
            sunLight.shadow.camera.bottom = -100;
            sunLight.shadow.mapSize.width = 1024;
            sunLight.shadow.mapSize.height = 1024;
            scene.add(sunLight);

            // åŠçƒå…‰
            const hemiLight = new THREE.HemisphereLight(0x87ceeb, 0x2d5016, 0.3);
            scene.add(hemiLight);
        }

        function createBuilding() {
            const group = new THREE.Group();

            let yOffset = 0;
            const colors = [0x7a7a7a, 0x9a9a9a, 0x9a9a9a, 0xb0b0b0, 0xf5f5f5, 0xf5f5f5, 0xf0f0f0];

            BUILDING_CONFIG.floors.forEach((floorKey, index) => {
                const height = BUILDING_CONFIG.floorHeights[index];
                const material = new THREE.MeshStandardMaterial({
                    color: colors[index],
                    metalness: 0.2,
                    roughness: 0.8
                });

                // å››é¢ç‰†
                const walls = [
                    { pos: [0, yOffset + height/2, BUILDING_CONFIG.depth/2], size: [BUILDING_CONFIG.width, height, 0.3] },
                    { pos: [0, yOffset + height/2, -BUILDING_CONFIG.depth/2], size: [BUILDING_CONFIG.width, height, 0.3] },
                    { pos: [-BUILDING_CONFIG.width/2, yOffset + height/2, 0], size: [BUILDING_CONFIG.depth, height, 0.3] },
                    { pos: [BUILDING_CONFIG.width/2, yOffset + height/2, 0], size: [BUILDING_CONFIG.depth, height, 0.3] }
                ];

                walls.forEach(wall => {
                    const geometry = new THREE.BoxGeometry(...wall.size);
                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(...wall.pos);
                    mesh.castShadow = true;
                    mesh.receiveShadow = true;
                    mesh.userData = { floor: floorKey };
                    group.add(mesh);
                });

                // åœ°æ¿
                const floorGeometry = new THREE.PlaneGeometry(BUILDING_CONFIG.width, BUILDING_CONFIG.depth);
                const floorMesh = new THREE.Mesh(floorGeometry, material);
                floorMesh.rotation.x = -Math.PI / 2;
                floorMesh.position.y = yOffset;
                floorMesh.receiveShadow = true;
                group.add(floorMesh);

                // æˆ¿é–“æ¨™è¨˜
                const rooms = ROOM_DATA[floorKey] || [];
                rooms.forEach(room => {
                    const roomGeometry = new THREE.BoxGeometry(room.w, height * 0.8, room.d);
                    const roomMaterial = new THREE.MeshStandardMaterial({
                        color: 0x3a3a4a,
                        metalness: 0.1,
                        roughness: 0.9,
                        transparent: true,
                        opacity: 0.1
                    });
                    const roomMesh = new THREE.Mesh(roomGeometry, roomMaterial);
                    roomMesh.position.set(room.x, yOffset + height / 2, room.z);
                    roomMesh.userData = { ...room, floor: floorKey };
                    roomMesh.castShadow = true;
                    roomMesh.receiveShadow = true;
                    group.add(roomMesh);
                });

                yOffset += height;
            });

            return group;
        }

        function animate() {
            requestAnimationFrame(animate);

            frameCount++;
            const now = Date.now();
            if (now >= lastTime + 1000) {
                fps = frameCount;
                document.getElementById('fps-display').textContent = fps;
                frameCount = 0;
                lastTime = now;
            }

            // æ ¹æ“šç•¶å‰æ¨¡å¼æ›´æ–°æ§åˆ¶å’Œç›¸æ©Ÿ
            if (currentMode === 'exterior') {
                orbitControls.update();
                renderer.render(scene, orbitCamera);
            } else if (currentMode === 'interior') {
                // å…§éƒ¨è»Œé“è¦–è§’
                orbitControls.object = fpsCamera;
                orbitControls.update();
                renderer.render(scene, fpsCamera);
            } else if (currentMode === 'fps') {
                // FPS æ§åˆ¶å’Œç§»å‹•
                updateFPSMovement();
                pointerLockControls.update();
                renderer.render(scene, fpsCamera);
            }
        }

        // FPS ç§»å‹•æ§åˆ¶
        function updateFPSMovement() {
            const direction = new THREE.Vector3();
            const rotation = new THREE.Euler(0, pointerLockControls.getObject().rotation.y, 0, 'YXZ');

            if (moveVector.forward) {
                direction.z -= 1;
            }
            if (moveVector.backward) {
                direction.z += 1;
            }
            if (moveVector.left) {
                direction.x -= 1;
            }
            if (moveVector.right) {
                direction.x += 1;
            }

            if (direction.length() > 0) {
                direction.normalize();
                direction.applyAxisAngle(new THREE.Vector3(0, 1, 0), rotation.y);

                // ç¢°æ’æª¢æ¸¬
                const checkDistance = 0.5;
                const rayStart = pointerLockControls.getObject().position.clone();
                rayStart.y = FPS_HEIGHT;

                const moveVector = direction.clone().multiplyScalar(FPS_SPEED);
                raycaster.set(rayStart, moveVector.normalize());
                const intersects = raycaster.intersectObjects(scene.children, true);

                // å¦‚æœæ²’æœ‰ç¢°æ’ï¼Œç§»å‹•ç›¸æ©Ÿ
                if (intersects.length === 0 || intersects[0].distance > checkDistance) {
                    pointerLockControls.getObject().position.add(moveVector);
                }
            }
        }

        // ==================== UI æ§åˆ¶ ====================

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // æ ¹æ“šæ¨¡å¼è¨­ç½®ç›¸æ©Ÿå’Œæ§åˆ¶å™¨
            if (mode === 'exterior') {
                // å¤–éƒ¨è¦–è§’
                orbitControls.object = orbitCamera;
                orbitControls.autoRotate = true;
                orbitCamera.position.set(80, 60, 80);
                orbitControls.target.set(0, 15, 0);
                orbitControls.update();
            } else if (mode === 'interior') {
                // å…§éƒ¨è»Œé“è¦–è§’
                orbitControls.object = fpsCamera;
                orbitControls.autoRotate = false;
                fpsCamera.position.set(0, FPS_HEIGHT, 10);
                orbitControls.target.set(0, FPS_HEIGHT, 0);
                orbitControls.update();
                // é‡‹æ”¾ Pointer Lock
                if (document.pointerLockElement) {
                    document.exitPointerLock();
                }
            } else if (mode === 'fps') {
                // ç¬¬ä¸€äººç¨±è¦–è§’
                orbitControls.autoRotate = false;
                fpsCamera.position.set(0, FPS_HEIGHT, 10);
            }
        }

        // éµç›¤äº‹ä»¶è™•ç†å™¨
        function onKeyDown(event) {
            switch (event.key.toLowerCase()) {
                case 'w': moveVector.forward = true; break;
                case 's': moveVector.backward = true; break;
                case 'a': moveVector.left = true; break;
                case 'd': moveVector.right = true; break;
            }
        }

        function onKeyUp(event) {
            switch (event.key.toLowerCase()) {
                case 'w': moveVector.forward = false; break;
                case 's': moveVector.backward = false; break;
                case 'a': moveVector.left = false; break;
                case 'd': moveVector.right = false; break;
            }
        }

        function selectFloor(floor) {
            currentFloor = floor;
            document.querySelectorAll('.floor-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            updateRoomsList();
            updateInfoPanel();
        }

        function updateRoomsList() {
            const rooms = ROOM_DATA[currentFloor] || [];
            const html = rooms.map(room => `
                <div class="room-item" onclick="selectRoom('${room.id}')">
                    <div class="room-name">${room.name}</div>
                    <div class="room-area">${room.area} mÂ² â€¢ ${room.equipment[0]}</div>
                </div>
            `).join('');
            document.getElementById('rooms-list').innerHTML = html;
        }

        function selectRoom(roomId) {
            const room = ROOM_DATA[currentFloor].find(r => r.id === roomId);
            if (room) updateInfoPanel(room);
        }

        function updateInfoPanel(room = null) {
            const panel = document.getElementById('info-panel');
            if (!room) {
                const floorRooms = ROOM_DATA[currentFloor] || [];
                const totalArea = floorRooms.reduce((sum, r) => sum + r.area, 0);
                panel.innerHTML = `
                    <div class="info-card">
                        <div class="card-title">æ¨“å±¤çµ±è¨ˆ</div>
                        <div class="card-content">
                            <div class="info-row">
                                <span class="info-label">æ¨“å±¤</span>
                                <span class="info-value">${currentFloor}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">æˆ¿é–“æ•¸</span>
                                <span class="info-value">${floorRooms.length}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ç¸½é¢ç©</span>
                                <span class="info-value">${totalArea} mÂ²</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                panel.innerHTML = `
                    <div class="info-card">
                        <div class="card-title">${room.name}</div>
                        <div class="card-content">
                            <div class="info-row">
                                <span class="info-label">æˆ¿é–“ ID</span>
                                <span class="info-value">${room.id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">é¢ç©</span>
                                <span class="info-value">${room.area} mÂ²</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">é¡å‹</span>
                                <span class="info-value">${room.type}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">è¨­å‚™</span>
                            </div>
                            ${room.equipment.map(eq => `
                                <div style="color: #888; font-size: 11px; padding: 4px 0; padding-left: 10px;">â€¢ ${eq}</div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        function toggleWireframe() {
            scene.traverse(obj => {
                if (obj.material && obj.material.wireframe !== undefined) {
                    obj.material.wireframe = !obj.material.wireframe;
                }
            });
        }

        function toggleAutoRotate() {
            orbitControls.autoRotate = !orbitControls.autoRotate;
        }

        function resetView() {
            camera.position.set(80, 60, 80);
            orbitControls.target.set(0, 15, 0);
            orbitControls.update();
        }

        function toggleHelp() {
            const helpText = `
ğŸ® ä¸‰ç¨®è¦–è§’æ¨¡å¼:

ã€å¤–éƒ¨è¦–è§’ã€‘
â€¢ æ»‘é¼ å·¦éµæ‹–å‹•: æ—‹è½‰è¦–è§’
â€¢ æ»‘é¼ æ»¾è¼ª: æ”¾å¤§/ç¸®å°
â€¢ æ»‘é¼ å³éµæ‹–å‹•: å¹³ç§»è¦–è§’

ã€å…§éƒ¨å°è¦½ã€‘
â€¢ æ»‘é¼ å·¦éµæ‹–å‹•: æ—‹è½‰è¦–è§’
â€¢ æ»‘é¼ æ»¾è¼ª: æ”¾å¤§/ç¸®å°
â€¢ é»æ“Šæ¨“å±¤/æˆ¿é–“æŸ¥çœ‹è©³æƒ…

ã€ç¬¬ä¸€äººç¨±è¦–è§’ã€‘
â€¢ W/A/S/D: ç§»å‹• (å‰/å·¦/å¾Œ/å³)
â€¢ æ»‘é¼ ç§»å‹•: è½‰èº«/çœ‹å‘
â€¢ é»æ“Šç•«é¢: é–å®šæ»‘é¼ (Pointer Lock)
â€¢ æŒ‰ ESC: é‡‹æ”¾æ»‘é¼ 

å…¶ä»–:
â€¢ ç·šæ¡†: åˆ‡æ›ç·šæ¡†é¡¯ç¤º
â€¢ è‡ªå‹•æ—‹è½‰: é–‹å•Ÿè‡ªå‹•æ—‹è½‰
â€¢ é‡ç½®è¦–è§’: å›åˆ°åˆå§‹è¦–è§’
            `;
            alert(helpText.trim());
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const aspect = width / height;

            // æ›´æ–°å…©å€‹ç›¸æ©Ÿ
            orbitCamera.aspect = aspect;
            orbitCamera.updateProjectionMatrix();
            fpsCamera.aspect = aspect;
            fpsCamera.updateProjectionMatrix();

            renderer.setSize(width, height);
        }

        // ==================== åˆå§‹åŒ– ====================
        window.addEventListener('load', () => {
            console.log('ğŸ“ é é¢è¼‰å…¥å®Œæˆï¼Œæª¢æŸ¥ Three.js...');

            // ç­‰å¾… Three.js åŠ è¼‰ï¼ˆæœ€å¤š 5 ç§’ï¼‰
            let attempts = 0;
            const maxAttempts = 50; // 50 Ã— 100ms = 5 ç§’

            function waitForThreeJS() {
                attempts++;

                if (typeof THREE !== 'undefined') {
                    console.log('âœ… Three.js å·²åŠ è¼‰');
                    checkThreeJS(); // åˆå§‹åŒ– raycaster å’Œ velocity

                    console.log('ğŸ—ï¸ åˆå§‹åŒ– Three.js å ´æ™¯...');
                    initThreeJS();
                    updateRoomsList();
                    updateInfoPanel();
                    document.getElementById('obj-display').textContent = scene.children.length;
                    console.log('âœ… åˆå§‹åŒ–å®Œæˆï¼Œ3D å»ºç¯‰æ‡‰è©²å‡ºç¾äº†');
                } else if (attempts < maxAttempts) {
                    console.log(`â³ ç­‰å¾… Three.js åŠ è¼‰... (${attempts}/${maxAttempts})`);
                    setTimeout(waitForThreeJS, 100);
                } else {
                    console.error('âŒ Three.js åŠ è¼‰è¶…æ™‚ï¼Œå˜—è©¦å‚™é¸ CDN...');
                    window.location.reload();
                }
            }

            waitForThreeJS();
        });
    </script>
</body>
</html>
