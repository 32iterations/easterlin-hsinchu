<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëµ§ÂúüÂ¥éÂ§öÂäüËÉΩÈ§® - 3DÂÆ§ÂÖßÂ∞éË¶ΩÁ≥ªÁµ± (Â∞àÊ•≠Áâà)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', 'Segoe UI', -apple-system, sans-serif;
            background: #0a0e27;
            overflow: hidden;
            color: #ffffff;
        }

        /* ============== ‰∏ªÂÆπÂô® ============== */
        #app {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 60px 1fr;
        }

        /* ============== È†ÇÈÉ®Â∞éËà™Ê¨Ñ ============== */
        #topbar {
            background: rgba(10, 14, 39, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .app-title {
            font-size: 16px;
            font-weight: 600;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            letter-spacing: 1px;
        }

        .mode-switcher {
            display: flex;
            gap: 8px;
            background: rgba(0, 255, 136, 0.1);
            padding: 4px;
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .mode-btn {
            padding: 6px 14px;
            border: none;
            background: transparent;
            color: #888;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .mode-btn:hover {
            color: #00ff88;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stats {
            display: flex;
            gap: 20px;
            font-size: 11px;
            color: #888;
            font-family: 'Courier New', monospace;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .stat-label {
            color: #666;
            font-size: 10px;
        }

        .stat-value {
            color: #00ff88;
            font-weight: 600;
        }

        /* ============== ‰∏ªÂÖßÂÆπÂçÄ ============== */
        #main-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 1px;
            background: #0a0e27;
        }

        /* ============== Â∑¶ÂÅ¥Èù¢Êùø ============== */
        #left-panel {
            background: rgba(10, 14, 39, 0.9);
            border-right: 1px solid rgba(0, 255, 136, 0.2);
            overflow-y: auto;
            padding: 20px;
        }

        .panel-title {
            font-size: 13px;
            font-weight: 600;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }

        .floor-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 30px;
        }

        .floor-btn {
            padding: 10px 12px;
            background: rgba(0, 204, 255, 0.1);
            border: 1px solid rgba(0, 204, 255, 0.3);
            color: #00ccff;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: left;
        }

        .floor-btn:hover {
            background: rgba(0, 204, 255, 0.2);
            border-color: rgba(0, 204, 255, 0.6);
        }

        .floor-btn.active {
            background: #00ccff;
            color: #000;
            box-shadow: 0 0 15px rgba(0, 204, 255, 0.5);
        }

        .rooms-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .room-item {
            padding: 8px 10px;
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.1);
            border-radius: 3px;
            margin-bottom: 6px;
            cursor: pointer;
            font-size: 11px;
            color: #aaa;
            transition: all 0.3s ease;
        }

        .room-item:hover {
            background: rgba(0, 255, 136, 0.15);
            color: #00ff88;
            border-color: rgba(0, 255, 136, 0.3);
        }

        .room-name {
            font-weight: 500;
            color: #00ff88;
            margin-bottom: 2px;
        }

        .room-area {
            font-size: 10px;
            color: #666;
        }

        /* ============== ‰∏≠Â§Æ 3D Canvas ============== */
        #canvas-container {
            position: relative;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a3e 100%);
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ============== Âè≥ÂÅ¥Èù¢Êùø ============== */
        #right-panel {
            background: rgba(10, 14, 39, 0.9);
            border-left: 1px solid rgba(255, 0, 255, 0.2);
            overflow-y: auto;
            padding: 20px;
        }

        .info-card {
            background: rgba(255, 0, 255, 0.05);
            border: 1px solid rgba(255, 0, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: #ff00ff;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
        }

        .card-content {
            font-size: 12px;
            color: #ccc;
            line-height: 1.6;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 0, 255, 0.1);
        }

        .info-label {
            color: #888;
            font-weight: 500;
        }

        .info-value {
            color: #00ff88;
            font-weight: 600;
        }

        /* ============== Êá∏ÊµÆÊéßÂà∂Èù¢Êùø ============== */
        .floating-panel {
            position: absolute;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 170, 0, 0.3);
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 11px;
            color: #ffaa00;
            z-index: 500;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.2);
        }

        #control-panel {
            bottom: 20px;
            right: 20px;
        }

        .control-title {
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 10px;
            letter-spacing: 1px;
            font-size: 10px;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .ctrl-btn {
            padding: 6px 10px;
            background: rgba(255, 170, 0, 0.15);
            border: 1px solid rgba(255, 170, 0, 0.3);
            color: #ffaa00;
            cursor: pointer;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .ctrl-btn:hover {
            background: rgba(255, 170, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 170, 0, 0.3);
        }

        /* ============== Â∞èÂú∞Âúñ ============== */
        #minimap {
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 200px;
        }

        #minimap-canvas {
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            border-radius: 6px;
            border: 1px solid rgba(0, 204, 255, 0.3);
        }

        /* ============== ÊèêÁ§∫Á≥ªÁµ± ============== */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 4px;
            padding: 8px 10px;
            font-size: 11px;
            color: #00ff88;
            pointer-events: none;
            z-index: 400;
            white-space: nowrap;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        /* ============== ÊªæÂãïÊ¢ùÁæéÂåñ ============== */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.3);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 136, 0.5);
        }

        /* ============== Âä†ËºâÂãïÁï´ ============== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        /* ============== ÈüøÊáâÂºèË®≠Ë®à ============== */
        @media (max-width: 1400px) {
            #main-container {
                grid-template-columns: 1fr 300px;
            }
            #left-panel {
                display: none;
            }
        }

        @media (max-width: 1000px) {
            #main-container {
                grid-template-columns: 1fr;
            }
            #right-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- È†ÇÈÉ®Â∞éËà™Ê¨Ñ -->
        <div id="topbar">
            <div class="topbar-left">
                <div class="app-title">üè¢ Ëµ§ÂúüÂ¥éÂ§öÂäüËÉΩÈ§® 3D Â∞éË¶ΩÁ≥ªÁµ±</div>
                <div class="mode-switcher">
                    <button class="mode-btn active" onclick="switchMode('exterior')">Â§ñÈÉ®Ë¶ñËßí</button>
                    <button class="mode-btn" onclick="switchMode('interior')">ÂÖßÈÉ®Â∞éË¶Ω</button>
                    <button class="mode-btn" onclick="switchMode('fps')">Á¨¨‰∏Ä‰∫∫Á®±</button>
                </div>
            </div>
            <div class="topbar-right">
                <div class="stats">
                    <div class="stat-item">
                        <span class="stat-label">FPS</span>
                        <span class="stat-value" id="fps-display">60</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Objects</span>
                        <span class="stat-value" id="obj-display">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Memory</span>
                        <span class="stat-value" id="mem-display">0MB</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‰∏ªÂÆπÂô® -->
        <div id="main-container">
            <!-- Â∑¶ÂÅ¥Èù¢Êùø -->
            <div id="left-panel">
                <div class="panel-title">Ê®ìÂ±§Â∞éËà™</div>
                <div class="floor-list">
                    <button class="floor-btn" onclick="selectFloor('B1')">B1 ÂÅúËªäÂ†¥+Ê©üÊàø</button>
                    <button class="floor-btn active" onclick="selectFloor('1F')">1F Èï∑ÁÖß+AIË®òÊÜ∂</button>
                    <button class="floor-btn" onclick="selectFloor('2F')">2F ÊâòÂ¨∞+SIDSÁõ£Ê∏¨</button>
                    <button class="floor-btn" onclick="selectFloor('3F')">3F Ë¶™Â≠êÂÖ±Â≠∏</button>
                    <button class="floor-btn" onclick="selectFloor('4F')">4F VRÊïôÂÆ§</button>
                    <button class="floor-btn" onclick="selectFloor('5F')">5F Á∂†ËÉΩÁ≥ªÁµ±</button>
                    <button class="floor-btn" onclick="selectFloor('6F')">6F ÊúÉË≠∞Âª≥</button>
                </div>

                <div class="panel-title">ÊàøÈñìÂàóË°®</div>
                <div class="rooms-list" id="rooms-list"></div>
            </div>

            <!-- ‰∏≠Â§Æ 3D Canvas -->
            <div id="canvas-container"></div>

            <!-- Âè≥ÂÅ¥Èù¢Êùø -->
            <div id="right-panel">
                <div id="info-panel"></div>
            </div>
        </div>

        <!-- Â∞èÂú∞Âúñ -->
        <div class="floating-panel" id="minimap">
            <div class="control-title">Ê®ìÂ±§Âπ≥Èù¢Âúñ</div>
            <canvas id="minimap-canvas"></canvas>
        </div>

        <!-- ÊéßÂà∂Èù¢Êùø -->
        <div class="floating-panel" id="control-panel">
            <div class="control-title">‚öôÔ∏è ÊéßÂà∂</div>
            <div class="control-buttons">
                <button class="ctrl-btn" onclick="toggleWireframe()">Á∑öÊ°Ü</button>
                <button class="ctrl-btn" onclick="toggleAutoRotate()">Ëá™ÂãïÊóãËΩâ</button>
                <button class="ctrl-btn" onclick="resetView()">ÈáçÁΩÆË¶ñËßí</button>
                <button class="ctrl-btn" onclick="toggleHelp()">Âπ´Âä©</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@r128/examples/js/controls/PointerLockControls.js"></script>
    <script>
        // ==================== ÂÖ®Â±ÄÈÖçÁΩÆ ====================
        const BUILDING_CONFIG = {
            width: 32,
            depth: 20,
            floors: ['B1', '1F', '2F', '3F', '4F', '5F', '6F'],
            floorHeights: [5, 4, 3.5, 3.5, 3.5, 3.5, 3.5]
        };

        // FPS ÊéßÂà∂Áõ∏ÈóúËÆäÊï∏
        let fpsCamera, orbitCamera;
        let fpsControls, pointerLockControls;
        let isPointerLocked = false;
        let currentMode = 'exterior';
        let moveVector = { forward: false, backward: false, left: false, right: false };
        let currentFloor = '1F';
        const FPS_SPEED = 0.15;
        const FPS_HEIGHT = 1.6; // ‰∫∫ÁúºÈ´òÂ∫¶

        // ==================== ÊàøÈñìÊï∏Êìö (ÂÆåÊï¥ÁöÑ43ÂÄãÊàøÈñì) ====================
        const ROOM_DATA = {
            'B1': [
                { id: 'B1-01', name: 'ÂÅúËªäÂ†¥', x: 0, z: 0, w: 28, d: 16, area: 448, type: 'facility', equipment: ['ÂÅúËªä‰Ωç√ó60', 'ÊÑüÊ∏¨Á≥ªÁµ±'] },
                { id: 'B1-02', name: 'Á©∫Ë™øÊ©üÊàø', x: 12, z: -8, w: 4, d: 3, area: 12, type: 'technical', equipment: ['ÂÜ∑Êöñ‰∏ªÊ©ü√ó2'] },
                { id: 'B1-03', name: 'ÈÖçÈõªÂÆ§', x: 12, z: -5, w: 3, d: 3, area: 9, type: 'technical', equipment: ['‰∏ªÈÖçÁõ§', 'UPSÁ≥ªÁµ±'] },
                { id: 'B1-04', name: 'Áµ¶ÊéíÊ∞¥', x: 10, z: -8, w: 2, d: 2, area: 4, type: 'technical', equipment: ['Ê∞¥Â°î√ó1'] },
                { id: 'B1-05', name: 'Èõ®Ê∞¥ÂõûÊî∂', x: 8, z: -8, w: 2, d: 2, area: 4, type: 'technical', equipment: ['ÂÑ≤Â≠òÊ±†'] }
            ],
            '1F': [
                { id: '1F-01', name: 'Â§±Êô∫ÁóáÂ∞àÂçÄ', x: -8, z: 0, w: 14, d: 14, area: 196, type: 'healthcare', equipment: ['ÊäïÂΩ±Á≥ªÁµ±', '‰∫íÂãïË£ùÁΩÆ'] },
                { id: '1F-02', name: 'AIÊäïÂΩ±Êí≠Êîæ', x: 4, z: -5, w: 8, d: 7, area: 56, type: 'healthcare', equipment: ['ÊäïÂΩ±Ê©ü', 'Êô∫ÊÖßÁõ£Ê∏¨'] },
                { id: '1F-03', name: 'Âæ©ÂÅ•Ë®ìÁ∑¥ÂçÄ', x: 4, z: 5, w: 8, d: 7, area: 56, type: 'healthcare', equipment: ['Âô®Êùê√ó5'] },
                { id: '1F-04', name: 'ËóùË°ìÁôÇÊ≥ïÂçÄ', x: -10, z: -8, w: 6, d: 5, area: 30, type: 'healthcare', equipment: ['Áï´ÂÖ∑', 'Ê®ÇÂô®'] },
                { id: '1F-05', name: 'Ë™çÁü•Ë®ìÁ∑¥ÂçÄ', x: -2, z: -8, w: 5, d: 5, area: 25, type: 'healthcare', equipment: ['Âπ≥Êùø√ó5'] },
                { id: '1F-06', name: 'ÂÖ±Áî®È§êÂª≥', x: 8, z: 8, w: 10, d: 6, area: 60, type: 'dining', equipment: ['Ê°åÊ§Ö√ó20'] },
                { id: '1F-07', name: 'ÂÇôÈ§êÂªöÊàø', x: 10, z: -1, w: 4, d: 3, area: 12, type: 'dining', equipment: ['ÁàêÁÅ∂√ó3'] },
                { id: '1F-08', name: 'Ë≠∑ÁêÜÁ´ô', x: -12, z: 8, w: 3, d: 3, area: 9, type: 'technical', equipment: ['Áõ£ÊéßÁ≥ªÁµ±'] }
            ],
            '2F': [
                { id: '2F-01', name: 'SIDSÁõ£Ê∏¨Á≥ªÁµ±', x: -8, z: 0, w: 12, d: 10, area: 120, type: 'healthcare', equipment: ['ÊÑüÊ∏¨Âô®√ó50'] },
                { id: '2F-02', name: 'Â¨∞ÂÖíÂ∫äÂçÄ', x: -8, z: 11, w: 12, d: 8, area: 96, type: 'healthcare', equipment: ['Â¨∞ÂÖíÂ∫ä√ó50'] },
                { id: '2F-03', name: '‰∏≠Â§ÆÁõ£Êéß', x: 6, z: 0, w: 4, d: 4, area: 16, type: 'technical', equipment: ['Áõ£ÊéßËû¢Âπï√ó4'] },
                { id: '2F-04', name: 'Â¨∞ÂÖíÊ¥ªÂãïÂçÄ', x: 6, z: 8, w: 5, d: 5, area: 25, type: 'activity', equipment: ['Áà¨Ë°åÂ¢ä', 'Áé©ÂÖ∑'] },
                { id: '2F-05', name: 'ÂπºÂÖíÊ¥ªÂãïÂçÄ', x: 12, z: 8, w: 6, d: 6, area: 36, type: 'activity', equipment: ['ÊªëÊ¢Ø', 'ÊîÄÁà¨Êû∂'] },
                { id: '2F-06', name: 'AIÊïÖ‰∫ãÊôÇÈñì', x: 6, z: -8, w: 4, d: 3, area: 12, type: 'activity', equipment: ['ÊäïÂΩ±Ê©ü'] },
                { id: '2F-07', name: 'È§µÈ£üÊèõÂ∞øÂçÄ', x: 12, z: -2, w: 6, d: 5, area: 30, type: 'facility', equipment: ['ÊèõÂ∞øÂè∞√ó3'] },
                { id: '2F-08', name: 'Ë°õÊµ¥Ë®≠ÊñΩ', x: 14, z: 8, w: 4, d: 4, area: 16, type: 'facility', equipment: ['ÂªÅÊâÄ√ó2', 'Êµ¥ÁõÜ'] }
            ],
            '3F': [
                { id: '3F-01', name: 'Èñ±ËÆÄÂçÄ', x: -12, z: 0, w: 6, d: 8, area: 48, type: 'education', equipment: ['Êõ∏Êû∂√ó3', 'Â∫ßÊ§Ö√ó8'] },
                { id: '3F-02', name: 'ÊïÖ‰∫ãÂäáÂ†¥', x: -4, z: 4, w: 10, d: 8, area: 80, type: 'education', equipment: ['ËàûÂè∞', 'ÊäïÂΩ±Âπï'] },
                { id: '3F-03', name: '‰∏ªÈ°åÂ≠∏ÁøíËßí', x: 8, z: 4, w: 10, d: 8, area: 80, type: 'education', equipment: ['STEAMÊïôÊùê'] },
                { id: '3F-04', name: 'ÊôÇÈñìÈäÄË°åËæ¶ÂÖ¨', x: -12, z: -8, w: 6, d: 6, area: 36, type: 'administrative', equipment: ['Ëæ¶ÂÖ¨Ê°å√ó3'] },
                { id: '3F-05', name: 'Â∞éÂ∏´Â∫ß‰ΩçÂçÄ', x: -4, z: -8, w: 6, d: 6, area: 36, type: 'education', equipment: ['Â∫ß‰Ωç√ó3'] },
                { id: '3F-06', name: 'ÊúàÂ∫¶Ë°®ÊèöÂçÄ', x: 4, z: -8, w: 4, d: 4, area: 16, type: 'activity', equipment: ['Â±ïÁ§∫ÁâÜ'] },
                { id: '3F-07', name: 'MR‰∫íÂãïÂçÄ', x: 14, z: 0, w: 5, d: 6, area: 30, type: 'technology', equipment: ['VRÈ†≠Áõî√ó2'] }
            ],
            '4F': [
                { id: '4F-01', name: 'STEMÊïôÂÆ§', x: -12, z: 0, w: 10, d: 8, area: 80, type: 'education', equipment: ['ÈõªËÖ¶√ó15'] },
                { id: '4F-02', name: 'Ê©üÂô®‰∫∫ÂçÄ', x: 0, z: 0, w: 8, d: 7, area: 56, type: 'technology', equipment: ['Arduino√ó10', 'Raspberry Pi√ó10'] },
                { id: '4F-03', name: 'ÈõªÂ≠êÂ∑•‰ΩúÂè∞', x: 0, z: -8, w: 5, d: 6, area: 30, type: 'technology', equipment: ['ÁÑäÊé•Âè∞√ó3'] },
                { id: '4F-04', name: 'VRÁ°¨È´îÂçÄ', x: -12, z: -8, w: 5, d: 5, area: 25, type: 'technology', equipment: ['VRÈ†≠Áõî√ó10'] },
                { id: '4F-05', name: 'VRÊ≤âÊµ∏ÊïôÂÆ§', x: 6, z: 2, w: 12, d: 8, area: 96, type: 'technology', equipment: ['ÊäïÂΩ±Ê©ü√ó2', 'ËøΩËπ§Á≥ªÁµ±'] },
                { id: '4F-06', name: 'ËôõÊì¨ÂØ¶È©óÂÆ§', x: 10, z: -8, w: 5, d: 6, area: 30, type: 'technology', equipment: ['VRÂ†¥ÊôØ'] },
                { id: '4F-07', name: 'ÈÅ†Ë∑ùÂ∞éÂ∏´ÂÆ§', x: -4, z: -8, w: 5, d: 4, area: 20, type: 'education', equipment: ['Ë¶ñË®äÁ≥ªÁµ±'] },
                { id: '4F-08', name: 'ËÅ∑Ê∂ØÂ∞éÂ∏´ÂçÄ', x: 12, z: -8, w: 6, d: 5, area: 30, type: 'education', equipment: ['ÊúÉË≠∞Ê°å'] }
            ],
            '5F': [
                { id: '5F-01', name: 'Â§™ÈôΩËÉΩÈù¢Êùø', x: 0, z: 0, w: 20, d: 14, area: 280, type: 'energy', equipment: ['Â§™ÈôΩËÉΩÊùø√ó120'] },
                { id: '5F-02', name: 'ÂÑ≤ËÉΩÈõªÊ±†', x: -8, z: -8, w: 4, d: 4, area: 16, type: 'energy', equipment: ['Èã∞ÈõªÊ±†ÁµÑ'] },
                { id: '5F-03', name: 'Á∂†Â±ãÈ†Ç', x: 8, z: -8, w: 12, d: 10, area: 120, type: 'environment', equipment: ['Ê§çË¢´'] },
                { id: '5F-04', name: 'ÂüπË®ìÊïôÂÆ§', x: -12, z: 8, w: 6, d: 5, area: 30, type: 'education', equipment: ['Â∫ßÊ§Ö√ó60'] },
                { id: '5F-05', name: 'ÊúÉË≠∞ÂÆ§', x: -4, z: 8, w: 5, d: 4, area: 20, type: 'administrative', equipment: ['ÊúÉË≠∞Ê°å'] },
                { id: '5F-06', name: 'ÂØ¶È©óÂÆ§', x: 4, z: 8, w: 6, d: 5, area: 30, type: 'research', equipment: ['VR/ARË®≠ÂÇô'] },
                { id: '5F-07', name: 'Ëæ¶ÂÖ¨ÂçÄ', x: 12, z: 8, w: 8, d: 6, area: 48, type: 'administrative', equipment: ['Â∫ß‰Ωç√ó15'] }
            ],
            '6F': [
                { id: '6F-01', name: 'ÊúÉË≠∞Âª≥', x: -2, z: 0, w: 20, d: 12, area: 240, type: 'event', equipment: ['Â∫ß‰Ωç√ó300', 'ÊäïÂΩ±Âπï'] },
                { id: '6F-02', name: 'ÂÇôÈ§êÂçÄ', x: -12, z: 8, w: 4, d: 3, area: 12, type: 'dining', equipment: ['ÊñôÁêÜÂè∞'] },
                { id: '6F-03', name: 'Ë°õÊµ¥Ë®≠ÊñΩ', x: -6, z: 8, w: 4, d: 4, area: 16, type: 'facility', equipment: ['ÂªÅÊâÄ√ó12'] },
                { id: '6F-04', name: 'ËàûÂè∞', x: 10, z: 6, w: 8, d: 5, area: 40, type: 'event', equipment: ['ÊäïÂΩ±Á≥ªÁµ±', 'Èü≥Èüø'] },
                { id: '6F-05', name: 'Â±ãÈ†ÇÈú≤Ëá∫', x: 8, z: -10, w: 10, d: 8, area: 80, type: 'outdoor', equipment: ['Â∫ß‰Ωç', 'ÈÅÆÈôΩ'] },
                { id: '6F-06', name: 'ÂÑ≤ÂÇôÂçÄ', x: 14, z: 8, w: 4, d: 5, area: 20, type: 'facility', equipment: ['È†êÁïôÁ©∫Èñì'] }
            ]
        };

        // ==================== Three.js Â†¥ÊôØ ====================
        let scene, renderer;
        let orbitCamera, orbitControls;
        let building;
        let frameCount = 0, lastTime = Date.now(), fps = 0;
        let raycaster = new THREE.Raycaster();
        let velocity = new THREE.Vector3();

        function initThreeJS() {
            const container = document.getElementById('canvas-container');

            // Â†¥ÊôØ
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0e27);
            scene.fog = new THREE.Fog(0x0a0e27, 100, 500);

            // Â§ñÈÉ®Ë¶ñËßíÁõ∏Ê©üÔºàËªåÈÅìÊéßÂà∂Ôºâ
            orbitCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            orbitCamera.position.set(80, 60, 80);

            // Á¨¨‰∏Ä‰∫∫Á®±Ë¶ñËßíÁõ∏Ê©üÔºàFPSÔºâ
            fpsCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            fpsCamera.position.set(0, FPS_HEIGHT, 10);

            // Ê∏≤ÊüìÂô®
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // ËªåÈÅìÊéßÂà∂Âô®ÔºàÂ§ñÈÉ®Ë¶ñËßíÔºâ
            orbitControls = new THREE.OrbitControls(orbitCamera, renderer.domElement);
            orbitControls.enableDamping = true;
            orbitControls.dampingFactor = 0.05;
            orbitControls.autoRotate = true;
            orbitControls.autoRotateSpeed = 2;

            // FPS ÊéßÂà∂Âô®ÔºàÁ¨¨‰∏Ä‰∫∫Á®±Ôºâ
            pointerLockControls = new THREE.PointerLockControls(fpsCamera, renderer.domElement);
            scene.add(pointerLockControls.getObject());

            // ÂÖâÁÖß
            setupLighting();

            // Âª∫ÁØâ
            building = createBuilding();
            scene.add(building);

            // Âú∞Èù¢
            const groundGeometry = new THREE.PlaneGeometry(200, 200);
            const groundMaterial = new THREE.MeshPhongMaterial({ color: 0x1a3a2a, side: THREE.DoubleSide });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.5;
            ground.receiveShadow = true;
            scene.add(ground);

            // ÈçµÁõ§‰∫ã‰ª∂Áõ£ËÅΩ
            window.addEventListener('keydown', onKeyDown);
            window.addEventListener('keyup', onKeyUp);

            // Pointer Lock ‰∫ã‰ª∂
            renderer.domElement.addEventListener('click', () => {
                if (currentMode === 'fps') {
                    pointerLockControls.lock();
                }
            });

            // Ë™øÊï¥Á™óÂè£Â§ßÂ∞è
            window.addEventListener('resize', onWindowResize);

            // ÂãïÁï´Âæ™Áí∞
            animate();
        }

        function setupLighting() {
            // Áí∞Â¢ÉÂÖâ
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            // Â§™ÈôΩÂÖâ
            const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
            sunLight.position.set(100, 100, 50);
            sunLight.castShadow = true;
            sunLight.shadow.camera.left = -100;
            sunLight.shadow.camera.right = 100;
            sunLight.shadow.camera.top = 100;
            sunLight.shadow.camera.bottom = -100;
            sunLight.shadow.mapSize.width = 1024;
            sunLight.shadow.mapSize.height = 1024;
            scene.add(sunLight);

            // ÂçäÁêÉÂÖâ
            const hemiLight = new THREE.HemisphereLight(0x87ceeb, 0x2d5016, 0.3);
            scene.add(hemiLight);
        }

        function createBuilding() {
            const group = new THREE.Group();

            let yOffset = 0;
            const colors = [0x7a7a7a, 0x9a9a9a, 0x9a9a9a, 0xb0b0b0, 0xf5f5f5, 0xf5f5f5, 0xf0f0f0];

            BUILDING_CONFIG.floors.forEach((floorKey, index) => {
                const height = BUILDING_CONFIG.floorHeights[index];
                const material = new THREE.MeshStandardMaterial({
                    color: colors[index],
                    metalness: 0.2,
                    roughness: 0.8
                });

                // ÂõõÈù¢ÁâÜ
                const walls = [
                    { pos: [0, yOffset + height/2, BUILDING_CONFIG.depth/2], size: [BUILDING_CONFIG.width, height, 0.3] },
                    { pos: [0, yOffset + height/2, -BUILDING_CONFIG.depth/2], size: [BUILDING_CONFIG.width, height, 0.3] },
                    { pos: [-BUILDING_CONFIG.width/2, yOffset + height/2, 0], size: [BUILDING_CONFIG.depth, height, 0.3] },
                    { pos: [BUILDING_CONFIG.width/2, yOffset + height/2, 0], size: [BUILDING_CONFIG.depth, height, 0.3] }
                ];

                walls.forEach(wall => {
                    const geometry = new THREE.BoxGeometry(...wall.size);
                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(...wall.pos);
                    mesh.castShadow = true;
                    mesh.receiveShadow = true;
                    mesh.userData = { floor: floorKey };
                    group.add(mesh);
                });

                // Âú∞Êùø
                const floorGeometry = new THREE.PlaneGeometry(BUILDING_CONFIG.width, BUILDING_CONFIG.depth);
                const floorMesh = new THREE.Mesh(floorGeometry, material);
                floorMesh.rotation.x = -Math.PI / 2;
                floorMesh.position.y = yOffset;
                floorMesh.receiveShadow = true;
                group.add(floorMesh);

                // ÊàøÈñìÊ®ôË®ò
                const rooms = ROOM_DATA[floorKey] || [];
                rooms.forEach(room => {
                    const roomGeometry = new THREE.BoxGeometry(room.w, height * 0.8, room.d);
                    const roomMaterial = new THREE.MeshStandardMaterial({
                        color: 0x3a3a4a,
                        metalness: 0.1,
                        roughness: 0.9,
                        transparent: true,
                        opacity: 0.1
                    });
                    const roomMesh = new THREE.Mesh(roomGeometry, roomMaterial);
                    roomMesh.position.set(room.x, yOffset + height / 2, room.z);
                    roomMesh.userData = { ...room, floor: floorKey };
                    roomMesh.castShadow = true;
                    roomMesh.receiveShadow = true;
                    group.add(roomMesh);
                });

                yOffset += height;
            });

            return group;
        }

        function animate() {
            requestAnimationFrame(animate);

            frameCount++;
            const now = Date.now();
            if (now >= lastTime + 1000) {
                fps = frameCount;
                document.getElementById('fps-display').textContent = fps;
                frameCount = 0;
                lastTime = now;
            }

            // Ê†πÊìöÁï∂ÂâçÊ®°ÂºèÊõ¥Êñ∞ÊéßÂà∂ÂíåÁõ∏Ê©ü
            if (currentMode === 'exterior') {
                orbitControls.update();
                renderer.render(scene, orbitCamera);
            } else if (currentMode === 'interior') {
                // ÂÖßÈÉ®ËªåÈÅìË¶ñËßí
                orbitControls.object = fpsCamera;
                orbitControls.update();
                renderer.render(scene, fpsCamera);
            } else if (currentMode === 'fps') {
                // FPS ÊéßÂà∂ÂíåÁßªÂãï
                updateFPSMovement();
                pointerLockControls.update();
                renderer.render(scene, fpsCamera);
            }
        }

        // FPS ÁßªÂãïÊéßÂà∂
        function updateFPSMovement() {
            const direction = new THREE.Vector3();
            const rotation = new THREE.Euler(0, pointerLockControls.getObject().rotation.y, 0, 'YXZ');

            if (moveVector.forward) {
                direction.z -= 1;
            }
            if (moveVector.backward) {
                direction.z += 1;
            }
            if (moveVector.left) {
                direction.x -= 1;
            }
            if (moveVector.right) {
                direction.x += 1;
            }

            if (direction.length() > 0) {
                direction.normalize();
                direction.applyAxisAngle(new THREE.Vector3(0, 1, 0), rotation.y);

                // Á¢∞ÊíûÊ™¢Ê∏¨
                const checkDistance = 0.5;
                const rayStart = pointerLockControls.getObject().position.clone();
                rayStart.y = FPS_HEIGHT;

                const moveVector = direction.clone().multiplyScalar(FPS_SPEED);
                raycaster.set(rayStart, moveVector.normalize());
                const intersects = raycaster.intersectObjects(scene.children, true);

                // Â¶ÇÊûúÊ≤íÊúâÁ¢∞ÊíûÔºåÁßªÂãïÁõ∏Ê©ü
                if (intersects.length === 0 || intersects[0].distance > checkDistance) {
                    pointerLockControls.getObject().position.add(moveVector);
                }
            }
        }

        // ==================== UI ÊéßÂà∂ ====================

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Ê†πÊìöÊ®°ÂºèË®≠ÁΩÆÁõ∏Ê©üÂíåÊéßÂà∂Âô®
            if (mode === 'exterior') {
                // Â§ñÈÉ®Ë¶ñËßí
                orbitControls.object = orbitCamera;
                orbitControls.autoRotate = true;
                orbitCamera.position.set(80, 60, 80);
                orbitControls.target.set(0, 15, 0);
                orbitControls.update();
            } else if (mode === 'interior') {
                // ÂÖßÈÉ®ËªåÈÅìË¶ñËßí
                orbitControls.object = fpsCamera;
                orbitControls.autoRotate = false;
                fpsCamera.position.set(0, FPS_HEIGHT, 10);
                orbitControls.target.set(0, FPS_HEIGHT, 0);
                orbitControls.update();
                // ÈáãÊîæ Pointer Lock
                if (document.pointerLockElement) {
                    document.exitPointerLock();
                }
            } else if (mode === 'fps') {
                // Á¨¨‰∏Ä‰∫∫Á®±Ë¶ñËßí
                orbitControls.autoRotate = false;
                fpsCamera.position.set(0, FPS_HEIGHT, 10);
            }
        }

        // ÈçµÁõ§‰∫ã‰ª∂ËôïÁêÜÂô®
        function onKeyDown(event) {
            switch (event.key.toLowerCase()) {
                case 'w': moveVector.forward = true; break;
                case 's': moveVector.backward = true; break;
                case 'a': moveVector.left = true; break;
                case 'd': moveVector.right = true; break;
            }
        }

        function onKeyUp(event) {
            switch (event.key.toLowerCase()) {
                case 'w': moveVector.forward = false; break;
                case 's': moveVector.backward = false; break;
                case 'a': moveVector.left = false; break;
                case 'd': moveVector.right = false; break;
            }
        }

        function selectFloor(floor) {
            currentFloor = floor;
            document.querySelectorAll('.floor-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            updateRoomsList();
            updateInfoPanel();
        }

        function updateRoomsList() {
            const rooms = ROOM_DATA[currentFloor] || [];
            const html = rooms.map(room => `
                <div class="room-item" onclick="selectRoom('${room.id}')">
                    <div class="room-name">${room.name}</div>
                    <div class="room-area">${room.area} m¬≤ ‚Ä¢ ${room.equipment[0]}</div>
                </div>
            `).join('');
            document.getElementById('rooms-list').innerHTML = html;
        }

        function selectRoom(roomId) {
            const room = ROOM_DATA[currentFloor].find(r => r.id === roomId);
            if (room) updateInfoPanel(room);
        }

        function updateInfoPanel(room = null) {
            const panel = document.getElementById('info-panel');
            if (!room) {
                const floorRooms = ROOM_DATA[currentFloor] || [];
                const totalArea = floorRooms.reduce((sum, r) => sum + r.area, 0);
                panel.innerHTML = `
                    <div class="info-card">
                        <div class="card-title">Ê®ìÂ±§Áµ±Ë®à</div>
                        <div class="card-content">
                            <div class="info-row">
                                <span class="info-label">Ê®ìÂ±§</span>
                                <span class="info-value">${currentFloor}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ÊàøÈñìÊï∏</span>
                                <span class="info-value">${floorRooms.length}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Á∏ΩÈù¢Á©ç</span>
                                <span class="info-value">${totalArea} m¬≤</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                panel.innerHTML = `
                    <div class="info-card">
                        <div class="card-title">${room.name}</div>
                        <div class="card-content">
                            <div class="info-row">
                                <span class="info-label">ÊàøÈñì ID</span>
                                <span class="info-value">${room.id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Èù¢Á©ç</span>
                                <span class="info-value">${room.area} m¬≤</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">È°ûÂûã</span>
                                <span class="info-value">${room.type}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ë®≠ÂÇô</span>
                            </div>
                            ${room.equipment.map(eq => `
                                <div style="color: #888; font-size: 11px; padding: 4px 0; padding-left: 10px;">‚Ä¢ ${eq}</div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        function toggleWireframe() {
            scene.traverse(obj => {
                if (obj.material && obj.material.wireframe !== undefined) {
                    obj.material.wireframe = !obj.material.wireframe;
                }
            });
        }

        function toggleAutoRotate() {
            orbitControls.autoRotate = !orbitControls.autoRotate;
        }

        function resetView() {
            camera.position.set(80, 60, 80);
            orbitControls.target.set(0, 15, 0);
            orbitControls.update();
        }

        function toggleHelp() {
            const helpText = `
üéÆ ‰∏âÁ®ÆË¶ñËßíÊ®°Âºè:

„ÄêÂ§ñÈÉ®Ë¶ñËßí„Äë
‚Ä¢ ÊªëÈº†Â∑¶ÈçµÊãñÂãï: ÊóãËΩâË¶ñËßí
‚Ä¢ ÊªëÈº†ÊªæËº™: ÊîæÂ§ß/Á∏ÆÂ∞è
‚Ä¢ ÊªëÈº†Âè≥ÈçµÊãñÂãï: Âπ≥ÁßªË¶ñËßí

„ÄêÂÖßÈÉ®Â∞éË¶Ω„Äë
‚Ä¢ ÊªëÈº†Â∑¶ÈçµÊãñÂãï: ÊóãËΩâË¶ñËßí
‚Ä¢ ÊªëÈº†ÊªæËº™: ÊîæÂ§ß/Á∏ÆÂ∞è
‚Ä¢ ÈªûÊìäÊ®ìÂ±§/ÊàøÈñìÊü•ÁúãË©≥ÊÉÖ

„ÄêÁ¨¨‰∏Ä‰∫∫Á®±Ë¶ñËßí„Äë
‚Ä¢ W/A/S/D: ÁßªÂãï (Ââç/Â∑¶/Âæå/Âè≥)
‚Ä¢ ÊªëÈº†ÁßªÂãï: ËΩâË∫´/ÁúãÂêë
‚Ä¢ ÈªûÊìäÁï´Èù¢: ÈéñÂÆöÊªëÈº†(Pointer Lock)
‚Ä¢ Êåâ ESC: ÈáãÊîæÊªëÈº†

ÂÖ∂‰ªñ:
‚Ä¢ Á∑öÊ°Ü: ÂàáÊèõÁ∑öÊ°ÜÈ°ØÁ§∫
‚Ä¢ Ëá™ÂãïÊóãËΩâ: ÈñãÂïüËá™ÂãïÊóãËΩâ
‚Ä¢ ÈáçÁΩÆË¶ñËßí: ÂõûÂà∞ÂàùÂßãË¶ñËßí
            `;
            alert(helpText.trim());
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const aspect = width / height;

            // Êõ¥Êñ∞ÂÖ©ÂÄãÁõ∏Ê©ü
            orbitCamera.aspect = aspect;
            orbitCamera.updateProjectionMatrix();
            fpsCamera.aspect = aspect;
            fpsCamera.updateProjectionMatrix();

            renderer.setSize(width, height);
        }

        // ==================== ÂàùÂßãÂåñ ====================
        window.addEventListener('load', () => {
            initThreeJS();
            updateRoomsList();
            updateInfoPanel();
            document.getElementById('obj-display').textContent = scene.children.length;
        });
    </script>
</body>
</html>
